<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } 
        body { margin: 0; background-color: #f0f2f5; overflow: hidden; }
        
        /* Mobile responsive layout */
        @media (max-width: 768px) {
            body { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto 1fr; 
            }
            #editor-panel { 
                grid-column: 1; 
                grid-row: 1;
                height: auto; 
                position: relative;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            #preview-panel { 
                grid-column: 1; 
                grid-row: 2;
                padding: 10px; 
            }
            .mobile-toggle {
                display: block !important;
                background: #007bff;
                color: white;
                border: none;
                padding: 10px;
                width: 100%;
                font-size: 16px;
                cursor: pointer;
            }
            #editor-content.mobile-hidden {
                display: none;
            }
            #editor-footer.mobile-hidden {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-toggle { display: none; }
        }
        
    #editor-panel {
        width: 420px;
        background-color: #fff;
        border-right: 1px solid #ddd;
        height: 100vh;
        overflow-y: auto;
        position: fixed;
        top: 0;
        left: 0;
    }
    #preview-panel { padding: 20px; box-sizing: border-box; display: flex; justify-content: center; margin-left: 420px; height: 100vh; overflow-y: auto; } 
    #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; position: relative; } 
    iframe { width: 100%; height: 100%; border: none; display: block; } 
        
        /* Text editing toolbar */
        #text-editing-toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 90%;
        }
        
        #text-editing-toolbar.visible {
            display: flex;
        }
        
        #text-editing-toolbar label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
            display: block;
        }
        
        #text-editing-toolbar select,
        #text-editing-toolbar input {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        
        #text-editing-toolbar .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } 
        #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } 
        #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } 
        #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } 
        .global-settings { margin-top: 15px; } 
        #editor-content { flex-grow: 1; overflow-y: auto; min-height: 0; padding: 20px; }
        #editor-footer { padding: 20px; border-top: 1px solid #eee; } 
        
        .mobile-toggle { display: none; }
        
        .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } 
        .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } 
        .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } 
        .editor-block-title { font-weight: bold; flex-grow: 1; } 
        .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } 
        .delete-block-btn { color: crimson !important; } 
        .editor-block-content { padding: 15px; display: none; } 
        .editor-block-content.is-open { display: block; }
        
        .control-group { margin-bottom: 15px; } 
        .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } 
        .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; } 
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } 
        input.smart-location-search { border-left: 4px solid #28a745; } 
        textarea { min-height: 80px; }
        
        .style-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; } 
        .style-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; } 
        .style-controls .control-group { margin-bottom: 0; } 
        input[type="color"] { padding: 2px; min-height: 38px; } 
        .style-controls label { font-size: 0.9em; font-weight: 600; color: #555; } 
        hr.style-separator { border: none; border-top: 1px dashed #ccc; margin: 15px 0; }
        
        .optional-element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } 
        .optional-element-header label { margin-bottom: 0; }
        
        .sticker-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #6f42c1; } 
        .sticker-editor-header { display: flex; justify-content: space-between; align-items: center; } 
        .sticker-editor .control-group { margin-bottom: 8px; } 
        .sticker-editor .control-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 3px; } 
        .delete-sticker-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-weight: bold; cursor: pointer; }
        
        .inner-blocks-container { border-top: 2px solid #007bff; margin-top: 20px; padding-top: 15px; } 
        .inner-block-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid #007bff; } 
        .inner-block-editor .delete-inner-block-btn { float: right; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; line-height: 22px; text-align: center; } 
        .add-inner-block-controls button { background-color: #e9ecef; border: 1px dashed #ccc; padding: 8px; margin-right: 5px; cursor: pointer; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } 
        .modal-overlay.is-visible { display: flex; } 
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; } 
        .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; } 
        #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px; }
        
        .image-input-group { display: flex; gap: 8px; align-items: stretch; } 
        .image-input-group input[type="url"] { flex: 1; } 
        .browse-image-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px; } 
        .browse-image-btn:hover { background: #0056b3; }
        
        .image-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; } 
        .image-library-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: border-color 0.2s; } 
        .image-library-item:hover { border-color: #007bff; } 
        .image-library-item img { width: 100%; height: 80px; object-fit: cover; display: block; }
        
        .upload-section { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; } 
        .upload-section.dragover { border-color: #007bff; background-color: #f8f9fa; } 
        .upload-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; } 
        .upload-btn:hover { background: #218838; }
        
        .opacity-control { margin-top: 10px; } 
        .opacity-slider { width: 100%; margin-top: 5px; }
        
        .schedule-item-editor { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin-bottom: 15px; } 
        .schedule-item-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } 
        .schedule-item-editor-header h4 { margin: 0; flex-grow: 1; } 
        .delete-schedule-item-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        /* Background controls */
        .background-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; }
        
        /* Display mode selector */
        .display-mode-controls { margin-top: 15px; }
        .display-mode-controls label { font-weight: bold; }
        .display-mode-selector { display: flex; gap: 10px; margin-top: 8px; }
        .display-mode-selector button { flex: 1; padding: 8px; background: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; }
        .display-mode-selector button.active { background: #007bff; color: white; }
    </style>
</head>
<body>
    <!-- Text Editing Toolbar -->
    <div id="text-editing-toolbar">
        <div class="toolbar-group">
            <label>Font Family</label>
            <select id="toolbar-font-family">
                <optgroup label="Script/Handwritten">
                    <option value="Great Vibes">Great Vibes</option>
                    <option value="Dancing Script">Dancing Script</option>
                    <option value="Allura">Allura</option>
                    <option value="Sacramento">Sacramento</option>
                    <option value="Alex Brush">Alex Brush</option>
                    <option value="Satisfy">Satisfy</option>
                    <option value="Kaushan Script">Kaushan Script</option>
                    <option value="Pacifico">Pacifico</option>
                    <option value="Caveat">Caveat</option>
                    <option value="Cookie">Cookie</option>
                </optgroup>
                <optgroup label="Elegant Serif">
                    <option value="Playfair Display">Playfair Display</option>
                    <option value="Crimson Text">Crimson Text</option>
                    <option value="Cormorant Garamond">Cormorant Garamond</option>
                    <option value="EB Garamond">EB Garamond</option>
                    <option value="Libre Baskerville">Libre Baskerville</option>
                    <option value="Lora">Lora</option>
                    <option value="Merriweather">Merriweather</option>
                    <option value="Vollkorn">Vollkorn</option>
                </optgroup>
                <optgroup label="Decorative">
                    <option value="Cinzel">Cinzel</option>
                    <option value="Abril Fatface">Abril Fatface</option>
                    <option value="Amatic SC">Amatic SC</option>
                    <option value="Fredoka One">Fredoka One</option>
                    <option value="Lobster">Lobster</option>
                </optgroup>
                <optgroup label="Modern Sans-Serif">
                    <option value="Montserrat">Montserrat</option>
                    <option value="Raleway">Raleway</option>
                    <option value="Lato">Lato</option>
                    <option value="Open Sans">Open Sans</option>
                    <option value="Poppins">Poppins</option>
                </optgroup>
            </select>
        </div>
        <div class="toolbar-group">
            <label>Size</label>
            <input type="text" id="toolbar-font-size" placeholder="16px">
        </div>
        <div class="toolbar-group">
            <label>Color</label>
            <input type="color" id="toolbar-color">
        </div>
        <div class="toolbar-group">
            <label>Weight</label>
            <select id="toolbar-font-weight">
                <option value="400">Normal</option>
                <option value="700">Bold</option>
            </select>
        </div>
        <div class="toolbar-group">
            <label>Align</label>
            <select id="toolbar-text-align">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
            </select>
        </div>
    </div>

    <!-- HTML для модального окна с инструкцией -->
    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('is-visible')">×</span>
            <div id="instruction-content">
                <!-- Содержимое будет генерироваться через JS -->
            </div>
        </div>
    </div>

    <div id="editor-panel"> 
        <div id="editor-header">
            <h2>Editor</h2>
            <button class="mobile-toggle" onclick="toggleMobileEditor()">Toggle Editor</button>
            <div class="template-switcher">
                <button id="edit-main-btn" class="active">Invitation</button>
                <button id="edit-rsvp-btn">RSVP Form</button>
            </div>
            <div class="api-settings" style="margin-top: 15px;">
                <div class="control-group">
                    <label for="sheetdb-api-input">SheetDB API URL</label>
                    <input type="url" id="sheetdb-api-input" placeholder="Paste your SheetDB API URL here...">
                </div>
            </div>
            <div class="global-settings">
                <div class="control-group">
                    <label for="global-style-select">Page Style</label>
                    <select id="global-style-select">
                        <option value="classic">Classic (Cards)</option>
                        <option value="modern">Modern (Shared Background)</option>
                    </select>
                </div>
                <div class="display-mode-controls">
                    <label>Display Mode</label>
                    <div class="display-mode-selector">
                        <button id="mode-blocks" class="active">Blocks</button>
                        <button id="mode-ribbon">Ribbon</button>
                    </div>
                </div>
                <div class="control-group" id="global-bg-image-group">
                    <label for="global-bg-image-input">Background Image URL</label>
                    <div class="image-input-group">
                        <input type="url" id="global-bg-image-input" placeholder="https://images.unsplash.com/photo-...">
                        <button type="button" class="browse-image-btn" onclick="openImageLibrary('global-bg-image-input')">Browse...</button>
                    </div>
                </div>
                <div class="control-group">
                    <label for="global-bg-color-input">Page Background Color</label>
                    <input type="color" id="global-bg-color-input" value="#f8f7f5">
                </div>
                <div class="control-group">
                    <label for="global-width-input">Global Block Width</label>
                    <input type="text" id="global-width-input" placeholder="e.g., 800px or 90%">
                </div>
            </div>
        </div> 
        <div id="editor-content"></div> 
        <div id="editor-footer">
            <button id="add-block-btn" class="action-button" style="margin-bottom: 15px; background-color: #28a745;">+ Add New Block</button>
            <button id="share-button" class="action-button">Generate & Copy Link</button>
            <p id="status-text" style="text-align:center; margin-top:10px;"></p>
        </div> 
    </div> 
    
    <div id="preview-panel">
        <div id="preview-wrapper">
            <iframe id="preview-frame" scrolling="no"></iframe>
        </div>
    </div> 
    
    <template id="editor-block-template">
        <div class="editor-block">
            <div class="editor-block-header">
                <span class="drag-handle">☰</span>
                <span class="editor-block-title">Block Title</span>
                <div class="editor-block-controls">
                    <button class="toggle-btn">▼</button>
                    <button class="delete-block-btn" title="Delete Block">×</button>
                </div>
            </div>
            <div class="editor-block-content"></div>
        </div>
    </template> 
    
    <div id="add-block-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">×</span>
            <h3>Choose a Block to Add</h3>
            <div id="add-block-options">
                <button data-type="hero">Hero</button>
                <button data-type="text-block">Text Block</button>
                <button data-type="image">Image</button>
                <hr>
                <button data-type="schedule">Schedule</button>
                <button data-type="location">Location</button>
                <button data-type="countdown">Countdown</button>
                <button data-type="rsvp">RSVP Button</button>
                <hr>
                <button data-type="form-header">Form: Header</button>
                <button data-type="input-question">Form: Text Input</button>
                <button data-type="textarea-question">Form: Text Area</button>
                <button data-type="radio-question">Form: Radio Choice</button>
                <button data-type="form-footer">Form: Footer</button>
            </div>
        </div>
    </div>

    <div id="image-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeImageLibrary()">×</span>
            <h3>Image Library</h3>
            
            <div class="upload-section" id="upload-section">
                <p>Drag & drop an image here or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">Choose File</button>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">Uploads via ImgBB (free image hosting)</p>
            </div>
            
            <div class="image-library-grid" id="image-library-grid">
                <!-- Predefined images will be populated here -->
            </div>
        </div>
    </div>

    <div id="element-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeElementLibrary()">×</span>
            <h3>Element Library</h3>
            
            <div class="upload-section" id="element-upload-section">
                <p>Upload Your Own Element</p>
                <p>Drag & drop an image here or</p>
                <button class="upload-btn" onclick="document.getElementById('element-file-input').click()">Choose File</button>
                <input type="file" id="element-file-input" accept="image/*" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">Uploads via ImgBB (free image hosting)</p>
            </div>
            
            <div class="image-library-grid" id="element-library-grid">
                <!-- Predefined elements will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; 
    let pageSettings = {}; 
    let currentTemplate = '';
    let sheetDbApiUrl = '';
    let apiKeys = {}; 
    let currentImageTarget = null; 
    let currentElementBlock = null; 
    let currentEditingElement = null;
    let isCustomerMode = false;
    
    const defaultTextStyle = { fontFamily: 'Montserrat', fontSize: '1rem', color: '#333333', fontWeight: '400' };
    const defaultTitleStyle = { fontFamily: 'Playfair Display', fontSize: '2.2rem', color: '#111111', fontWeight: '700' };

    let mainPageData = { 
        template: 'wedding-classic.html', 
        settings: { 
            maxWidth: '800px', 
            style: 'classic', 
            backgroundImage: '', 
            backgroundColor: '#f8f7f5',
            displayMode: 'blocks'
        }, 
        blocks: [ 
            { 
                type: 'hero', 
                id: `block-${Date.now()}-1`, 
                content: { 
                    subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    names: { text: 'John & Jane', enabled: true, style: { fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    date: { text: 'September 15, 2025', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    imageUrl: 'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg', 
                    backgroundPosition: 'center 30%', 
                    aspectRatio: '9/16', 
                    opacity: 1, 
                    innerBlocks: [], 
                    stickers: [], 
                    fullWidth: true,
                    backgroundColor: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
                }
            }, 
            { 
                type: 'text-block', 
                id: `block-${Date.now()}-3`, 
                content: { 
                    title: 'A few words', 
                    text: 'We are excited to share this special day with our closest family and friends.', 
                    titleStyle: { ...defaultTitleStyle, fontSize: '2.5rem' }, 
                    textStyle: { ...defaultTextStyle, fontSize: '1.1rem', textAlign: 'center' }, 
                    stickers: [],
                    backgroundColor: '',
                    backgroundImage: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
                }
            }, 
            { 
                type: 'countdown', 
                id: `block-${Date.now()}-2`, 
                content: { 
                    title: 'Until Our Big Day', 
                    targetDate: '2025-09-15T16:00', 
                    titleStyle: { ...defaultTitleStyle }, 
                    buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' }, 
                    stickers: [],
                    backgroundColor: '',
                    backgroundImage: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
                }
            },
            { 
                type: 'schedule', 
                id: `block-${Date.now()}-4`, 
                content: { 
                    title: "The Day's Schedule", 
                    items: [
                        { 
                            id: `item-${Date.now()}-1`, 
                            time: '3:00 PM', 
                            title: 'Ceremony', 
                            desc: 'Join us for the wedding ceremony at the Grand Hall.', 
                            timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, 
                            titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, 
                            descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } 
                        }, 
                        { 
                            id: `item-${Date.now()}-2`, 
                            time: '5:00 PM', 
                            title: 'Reception', 
                            desc: 'Dinner, dancing, and celebration!', 
                            timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, 
                            titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, 
                            descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } 
                        }
                    ], 
                    titleStyle: { ...defaultTitleStyle }, 
                    stickers: [],
                    backgroundColor: '',
                    backgroundImage: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
                }
            }, 
            { 
                type: 'location', 
                id: `block-${Date.now()}-5`, 
                content: { 
                    title: 'Venue', 
                    address: 'The Grand Hall, 123 Celebration Ave, New York', 
                    imageUrl: 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', 
                    opacity: 1, 
                    mapLink: 'https://maps.google.com', 
                    titleStyle: { ...defaultTitleStyle }, 
                    addressStyle: { ...defaultTextStyle, textAlign: 'center' },
                    stickers: [],
                    backgroundColor: '',
                    backgroundImage: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
                }
            }, 
            { 
                type: 'rsvp', 
                id: `block-${Date.now()}-6`, 
                content: { 
                    title: 'Confirm Your Attendance', 
                    subtitle: 'Please reply by September 1st.', 
                    titleStyle: { ...defaultTitleStyle },
                    subtitleStyle: { ...defaultTextStyle, textAlign: 'center' },
                    buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' }, 
                    stickers: [],
                    backgroundColor: '',
                    backgroundImage: '',
                    backgroundOpacity: 1,
                    backgroundSize: 'cover'
               }
           }
        ] 
    };
    
    let rsvpFormData = { 
        template: 'rsvp-form.html', 
        settings: { 
            maxWidth: '800px', 
            style: 'classic', 
            backgroundImage: '', 
            backgroundColor: '#f8f7f5',
            displayMode: 'blocks'
        }, 
        blocks: [] 
    };
    
    const fontOptionsHTML = `<optgroup label="Script/Handwritten"> <option value="Great Vibes">Great Vibes</option> <option value="Dancing Script">Dancing Script</option> <option value="Allura">Allura</option> <option value="Sacramento">Sacramento</option> <option value="Alex Brush">Alex Brush</option> <option value="Satisfy">Satisfy</option> <option value="Kaushan Script">Kaushan Script</option> <option value="Pacifico">Pacifico</option> <option value="Caveat">Caveat</option> <option value="Cookie">Cookie</option> </optgroup> <optgroup label="Elegant Serif"> <option value="Playfair Display">Playfair Display</option> <option value="Crimson Text">Crimson Text</option> <option value="Cormorant Garamond">Cormorant Garamond</option> <option value="EB Garamond">EB Garamond</option> <option value="Libre Baskerville">Libre Baskerville</option> <option value="Lora">Lora</option> <option value="Merriweather">Merriweather</option> <option value="Vollkorn">Vollkorn</option> </optgroup> <optgroup label="Decorative"> <option value="Cinzel">Cinzel</option> <option value="Abril Fatface">Abril Fatface</option> <option value="Amatic SC">Amatic SC</option> <option value="Fredoka One">Fredoka One</option> <option value="Lobster">Lobster</option> </optgroup> <optgroup label="Modern Sans-Serif"> <option value="Montserrat">Montserrat</option> <option value="Raleway">Raleway</option> <option value="Lato">Lato</option> <option value="Open Sans">Open Sans</option> <option value="Poppins">Poppins</option> </optgroup>`;
    
    const predefinedImages = [
        'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1519225421980-715cb0215aed?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?q=80&w=2069&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1520854221256-17451cc331bf?q=80&w=2070&auto=format&fit=crop',
        'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg',
        'https://images.unsplash.com/photo-1583939003579-730e3918a45a?q=80&w=2071&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1606800052052-a08af7148866?q=80&w=2070&auto=format&fit=crop'
    ];

    const predefinedElements = [
        'https://www.pngkey.com/png/full/15-154942_wedding-rings-png-image-background-gold-wedding-rings.png',
        'https://static.vecteezy.com/system/resources/previews/009/341/365/original/heart-shape-outline-love-symbol-icon-free-png.png',
        'https://pngimg.com/uploads/rose/rose_PNG11018.png',
        'https://www.pngplay.com/wp-content/uploads/12/Wedding-Dove-PNG-Clipart-Background.png'
    ];

    // Mobile responsive functions
    function toggleMobileEditor() {
        const editorContent = document.getElementById('editor-content');
        const editorFooter = document.getElementById('editor-footer');
        editorContent.classList.toggle('mobile-hidden');
        editorFooter.classList.toggle('mobile-hidden');
    }

    // Text editing toolbar functions
    function showTextEditingToolbar(blockId, elementKey, currentStyle) {
        const toolbar = document.getElementById('text-editing-toolbar');
        currentEditingElement = { blockId, elementKey };
        
        // Populate toolbar with current values
        document.getElementById('toolbar-font-family').value = currentStyle.fontFamily || 'Montserrat';
        document.getElementById('toolbar-font-size').value = currentStyle.fontSize || '1rem';
        document.getElementById('toolbar-color').value = currentStyle.color || '#333333';
        document.getElementById('toolbar-font-weight').value = currentStyle.fontWeight || '400';
        document.getElementById('toolbar-text-align').value = currentStyle.textAlign || 'center';
        
        toolbar.classList.add('visible');
        
        // Set up event listeners
        setupToolbarEventListeners();
    }

    function hideTextEditingToolbar() {
        document.getElementById('text-editing-toolbar').classList.remove('visible');
        currentEditingElement = null;
    }

    function setupToolbarEventListeners() {
        const toolbar = document.getElementById('text-editing-toolbar');
        const inputs = toolbar.querySelectorAll('select, input');
        
        inputs.forEach(input => {
            input.addEventListener('change', updateTextStyle);
            input.addEventListener('input', updateTextStyle);
        });
    }

    function updateTextStyle() {
        if (!currentEditingElement) return;
        
        const blockIndex = pageBlocks.findIndex(b => b.id === currentEditingElement.blockId);
        if (blockIndex === -1) return;
        
        const keys = currentEditingElement.elementKey.split('.');
        let current = pageBlocks[blockIndex].content;
        
        for (let i = 0; i < keys.length - 1; i++) {
            current = current[keys[i]];
        }
        
        const styleKey = keys[keys.length - 1];
        
        const existingStyle = current[styleKey] || {};

        const newStyles = {
            fontFamily: document.getElementById('toolbar-font-family').value,
            fontSize: document.getElementById('toolbar-font-size').value,
            color: document.getElementById('toolbar-color').value,
            fontWeight: document.getElementById('toolbar-font-weight').value,
            textAlign: document.getElementById('toolbar-text-align').value
        };

        Object.assign(existingStyle, newStyles);
        current[styleKey] = existingStyle;
        
        renderPreview();
        renderEditor();
    }

    function openImageLibrary(targetInputId) {
        currentImageTarget = targetInputId;
        const modal = document.getElementById('image-library-modal');
        const grid = document.getElementById('image-library-grid');
        
        // Populate predefined images
        grid.innerHTML = predefinedImages.map(url => 
            `<div class="image-library-item" onclick="selectImage('${url}')">
                <img src="${url}" alt="Image option" loading="lazy">
            </div>`
        ).join('');
        
        modal.classList.add('is-visible');
    }

    function closeImageLibrary() {
        document.getElementById('image-library-modal').classList.remove('is-visible');
        currentImageTarget = null;
    }

    function openElementLibrary(blockId) {
        currentElementBlock = blockId;
        const modal = document.getElementById('element-library-modal');
        const grid = document.getElementById('element-library-grid');
        
        // Populate predefined elements
        grid.innerHTML = predefinedElements.map(url => 
            `<div class="image-library-item" onclick="selectElement('${url}')">
                <img src="${url}" alt="Element option" loading="lazy">
            </div>`
        ).join('');
        
        modal.classList.add('is-visible');
    }

    function closeElementLibrary() {
        document.getElementById('element-library-modal').classList.remove('is-visible');
        currentElementBlock = null;
    }

    function selectElement(elementUrl) {
        if (currentElementBlock) {
            const blockIndex = pageBlocks.findIndex(b => b.id === currentElementBlock);
            if (blockIndex !== -1) {
                const newSticker = {
                    id: `sticker-${Date.now()}`,
                    src: elementUrl,
                    x: 50,
                    y: 50,
                    width: 150,
                    rotation: 0,
                    opacity: 1
                };
                if (!pageBlocks[blockIndex].content.stickers) pageBlocks[blockIndex].content.stickers = [];
                pageBlocks[blockIndex].content.stickers.push(newSticker);
                renderEditor();
                renderPreview();
            }
        }
        closeElementLibrary();
    }

    function selectImage(imageUrl) {
        if (currentImageTarget) {
            let input = null;
            if (currentImageTarget.startsWith('backgroundImage-')) {
                const blockId = currentImageTarget.replace('backgroundImage-', '');
                input = document.querySelector(`input[data-key="backgroundImage"][data-block-id="${blockId}"]`);
            } else {
                input = document.getElementById(currentImageTarget) || document.querySelector(`input[data-key="${currentImageTarget}"]`);
            }
            if (input) {
                input.value = imageUrl;
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        }
        closeImageLibrary();
    }

    async function uploadToImgBB(file) {
        if (!apiKeys.imgbb) {
            throw new Error('ImgBB API key not available');
        }
        
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeys.imgbb}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error?.message || 'Upload failed');
        }
        
        return result.data.url;
    }

    // Setup file upload for images
    document.getElementById('file-input').addEventListener('change', async (e) => { 
        if (e.target.files.length === 0) return;
        
        const file = e.target.files[0];
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading image...';
            const imageUrl = await uploadToImgBB(file);
            selectImage(imageUrl);
            statusText.textContent = 'Image uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
        e.target.value = '';
    });

    // Setup file upload for elements
    document.getElementById('element-file-input').addEventListener('change', async (e) => {
        if (e.target.files.length === 0) return;
        
        const file = e.target.files[0];
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading element...';
            const elementUrl = await uploadToImgBB(file);
            selectElement(elementUrl);
            statusText.textContent = 'Element uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
        e.target.value = '';
    });

    // Setup drag and drop for images
    const uploadSection = document.getElementById('upload-section');
    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('dragover');
    });
    
    uploadSection.addEventListener('dragleave', () => {
        uploadSection.classList.remove('dragover');
    });
    
    uploadSection.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        
        if (e.dataTransfer.files.length === 0) return;
        
        const file = e.dataTransfer.files[0];
        if (!file.type.startsWith('image/')) return;
        
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading image...';
            const imageUrl = await uploadToImgBB(file);
            selectImage(imageUrl);
            statusText.textContent = 'Image uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
    });

    // Setup drag and drop for elements
    const elementUploadSection = document.getElementById('element-upload-section');
    elementUploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        elementUploadSection.classList.add('dragover');
    });
    
    elementUploadSection.addEventListener('dragleave', () => {
        elementUploadSection.classList.remove('dragover');
    });
    
    elementUploadSection.addEventListener('drop', async (e) => {
        e.preventDefault();
        elementUploadSection.classList.remove('dragover');
        
        if (e.dataTransfer.files.length === 0) return;
        
        const file = e.dataTransfer.files[0];
        if (!file.type.startsWith('image/')) return;
        
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading element...';
            const elementUrl = await uploadToImgBB(file);
            selectElement(elementUrl);
            statusText.textContent = 'Element uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
    });

    function createStyleControlsHTML(prefix, styleObject, options = { color: true, size: true, weight: true, family: true, textAlign: false }) { 
        if (!styleObject) return ''; 
        return `<div class="style-controls"> ${options.family ? `<div class="control-group"><label>Font Family</label><select data-key="${prefix}.fontFamily">${fontOptionsHTML.replace(`value="${styleObject.fontFamily}"`, `value="${styleObject.fontFamily}" selected`)}</select></div>` : ''} <div class="style-controls-grid"> ${options.size ? `<div class="control-group"><label>Font Size</label><input type="text" data-key="${prefix}.fontSize" value="${styleObject.fontSize || ''}" placeholder="e.g. 16px or 1.2rem"></div>` : ''} ${options.color ? `<div class="control-group"><label>Color</label><input type="color" data-key="${prefix}.color" value="${styleObject.color || '#000000'}"></div>` : ''} </div> <div class="style-controls-grid" style="margin-top: 10px;"> ${options.weight ? `<div class="control-group"><label>Font Weight</label><select data-key="${prefix}.fontWeight"><option value="400" ${styleObject.fontWeight == '400' ? 'selected' : ''}>Normal</option><option value="700" ${styleObject.fontWeight == '700' ? 'selected' : ''}>Bold</option></select></div>` : ''} ${options.textAlign ? `<div class="control-group"><label>Text Align</label><select data-key="${prefix}.textAlign"><option value="left" ${styleObject.textAlign == 'left' ? 'selected' : ''}>Left</option><option value="center" ${styleObject.textAlign == 'center' ? 'selected' : ''}>Center</option><option value="right" ${styleObject.textAlign == 'right' ? 'selected' : ''}>Right</option></select></div>` : ''} </div> </div>`; 
    }
    
    function createBackgroundControlsHTML(block) {
        const c = block.content;
        return `<hr class="style-separator">
                <div class="control-group">
                    <label>Background Settings</label>
                    <div class="background-controls">
                        <div class="control-group">
                            <label>Background Color</label>
                            <input type="color" data-key="backgroundColor" value="${c.backgroundColor || '#ffffff'}">
                        </div>
                        <div class="control-group">
                            <label>Background Image</label>
                            <div class="image-input-group">
                                <input type="url" data-key="backgroundImage" value="${c.backgroundImage || ''}" placeholder="https://images.unsplash.com/photo-..." data-block-id="${block.id}">
                                <button type="button" class="browse-image-btn" onclick="openImageLibrary('backgroundImage-${block.id}')">Browse...</button>
                            </div>
                        </div>
                        <div class="style-controls-grid">
                            <div class="control-group">
                                <label>Background Size</label>
                                <select data-key="backgroundSize">
                                    <option value="cover" ${c.backgroundSize === 'cover' ? 'selected' : ''}>Cover</option>
                                    <option value="contain" ${c.backgroundSize === 'contain' ? 'selected' : ''}>Contain</option>
                                    <option value="repeat" ${c.backgroundSize === 'repeat' ? 'selected' : ''}>Repeat</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Background Opacity</label>
                                <input type="range" class="opacity-slider" min="0" max="1" step="0.1" data-key="backgroundOpacity" value="${c.backgroundOpacity || 1}">
                                <span style="font-size: 12px; color: #666;">${Math.round((c.backgroundOpacity || 1) * 100)}%</span>
                            </div>
                        </div>
                    </div>
                </div>`;
    }

    function createInnerBlocksEditor(block) {
        const innerBlocksHTML = (block.content.innerBlocks || []).map((innerBlock, index) => {
            const textContentField = `<textarea data-key="innerBlocks.${index}.text">${innerBlock.text || ''}</textarea>`;
            return `<div class="inner-block-editor" data-inner-id="${innerBlock.id}" data-index="${index}">
                        <button class="delete-inner-block-btn" title="Delete this element">×</button>
                        <label>Floating Text #${index + 1}</label>
                        ${textContentField}
                        ${createStyleControlsHTML(`innerBlocks.${index}.style`, innerBlock.style, { textAlign: true, color: true, size: true, weight: true, family: true })}
                        <div class="style-controls-grid">
                            <div class="control-group"><label>X (%)</label><input type="number" data-key="innerBlocks.${index}.x" value="${Math.round(innerBlock.x || 50)}"></div>
                            <div class="control-group"><label>Y (%)</label><input type="number" data-key="innerBlocks.${index}.y" value="${Math.round(innerBlock.y || 50)}"></div>
                        </div>
                        <div class="style-controls-grid">
                            <div class="control-group"><label>Width (px)</label><input type="number" data-key="innerBlocks.${index}.width" value="${Math.round(innerBlock.width || 200)}"></div>
                            <div class="control-group"><label>Rotation (°)</label><input type="number" data-key="innerBlocks.${index}.rotation" value="${Math.round(innerBlock.rotation || 0)}"></div>
                        </div>
                    </div>`;
        }).join('');

        return `<hr class="style-separator">
                <div class="control-group">
                    <label style="font-weight: bold; color: #333;">Floating Text Elements</label>
                    <button class="add-inner-block-btn" data-block-id="${block.id}" style="width: 100%; background-color: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">+ Add Floating Text</button>
                </div>
                <div class="inner-blocks-list">${innerBlocksHTML}</div>`;
    }

    function createScheduleItemsEditor(block) {
        let itemsHTML = (block.content.items || []).map((item, index) => {
            return `<div class="schedule-item-editor" data-item-id="${item.id}">
                <div class="schedule-item-editor-header">
                    <h4>Schedule Item ${index + 1}</h4>
                    <button class="delete-schedule-item-btn" title="Delete this item">Delete</button>
                </div>
                <div class="control-group">
                    <label>Time</label>
                    <input type="text" class="sub-item-input" data-item-key="time" value="${item.time || ''}" placeholder="e.g., 3:00 PM">
                    ${createStyleControlsHTML(`items.${index}.timeStyle`, item.timeStyle, { color: true, size: true, weight: true, family: true })}
                </div>
                <hr class="style-separator">
                <div class="control-group">
                    <label>Title</label>
                    <input type="text" class="sub-item-input" data-item-key="title" value="${item.title || ''}" placeholder="e.g., Ceremony">
                    ${createStyleControlsHTML(`items.${index}.titleStyle`, item.titleStyle, { color: true, size: true, weight: true, family: true })}
                </div>
                <hr class="style-separator">
                <div class="control-group">
                    <label>Description</label>
                    <textarea class="sub-item-input" data-item-key="desc" placeholder="Additional details...">${item.desc || ''}</textarea>
                    ${createStyleControlsHTML(`items.${index}.descStyle`, item.descStyle, { color: true, size: true, weight: true, family: true })}
                </div>
            </div>`;
        }).join('');
        
        return `<div class="control-group">
            <label style="font-weight: bold; color: #333;">Schedule Items</label>
            <div class="schedule-items-list">${itemsHTML}</div>
            <button class="add-sub-item-btn action-button" data-list-key="items" style="font-size: 12px; padding: 5px; margin-top: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px;">+ Add Schedule Item</button>
        </div>`;
    }
    
    function getNewBlockData(type) { 
        const newBlock = { 
            type: type, 
            id: `block-${Date.now()}`, 
            content: {
                innerBlocks: [],
                stickers: [],
                backgroundColor: '',
                backgroundImage: '',
                backgroundOpacity: 1,
                backgroundSize: 'cover'
            } 
        }; 

        switch(type) { 
            case 'hero': 
                Object.assign(newBlock.content, { 
                    subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, 
                    names: { text: 'John & Jane', enabled: true, style: { ...defaultTitleStyle, fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF'} }, 
                    date: { text: 'September 15, 2025', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, 
                    imageUrl: 'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop', 
                    backgroundPosition: 'center center', 
                    aspectRatio: '16/9', 
                    opacity: 1,
                    fullWidth: true
                }); 
                break; 
            case 'text-block': 
                Object.assign(newBlock.content, { 
                    title: 'New Title', 
                    text: 'New paragraph text.', 
                    titleStyle: { ...defaultTitleStyle }, 
                    textStyle: { ...defaultTextStyle, textAlign: 'center' }
                }); 
                break; 
            case 'countdown': 
                Object.assign(newBlock.content, { 
                    title: 'New Countdown', 
                    targetDate: '', 
                    titleStyle: { ...defaultTitleStyle }, 
                    numberStyle: { ...defaultTitleStyle, fontSize: '2.5rem' },
                    labelStyle: { ...defaultTextStyle, fontSize: '1rem' }
                }); 
                break;  
            case 'schedule': 
                Object.assign(newBlock.content, { 
                    title: 'New Schedule', 
                    items: [{ 
                        id: `item-${Date.now()}`, 
                        time: '3:00 PM', 
                        title: 'New Event', 
                        desc: 'Event description', 
                        timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, 
                        titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, 
                        descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } 
                    }], 
                    titleStyle: { ...defaultTitleStyle }
                }); 
                break; 
            case 'location': 
                Object.assign(newBlock.content, { 
                    title: 'New Location', 
                    address: '',
                    addressStyle: { ...defaultTextStyle, textAlign: 'center' },
                    imageUrl: '', 
                    opacity: 1, 
                    mapLink: '#', 
                    titleStyle: { ...defaultTitleStyle }
                }); 
                break; 
            case 'rsvp': 
                Object.assign(newBlock.content, { 
                    title: 'New RSVP Block', 
                    subtitle: 'New subtitle text', 
                    titleStyle: { ...defaultTitleStyle }, 
                    subtitleStyle: { ...defaultTextStyle, textAlign: 'center' },
                    buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' }
                }); 
                break; 
            case 'image': 
                Object.assign(newBlock.content, { 
                    imageUrl: 'https://via.placeholder.com/800x400', 
                    opacity: 1, 
                    caption: '', 
                    title: '', 
                    description: '', 
                    titleStyle: { ...defaultTitleStyle }, 
                    descriptionStyle: { ...defaultTextStyle, textAlign: 'center' }
                }); 
                break; 
            case 'form-header':
                Object.assign(newBlock.content, { title: 'RSVP', subtitle: 'Please fill out the form below', imageUrl: '', opacity: 1, aspectRatio: '16/9' }); 
                break;
            case 'input-question':
                Object.assign(newBlock.content, { id: `input-${Date.now()}`, title: 'Your Name', required: true });
                break;
            case 'textarea-question':
                Object.assign(newBlock.content, { id: `textarea-${Date.now()}`, title: 'Any comments?', required: false });
                break;
            case 'radio-question':
                Object.assign(newBlock.content, { id: `radio-${Date.now()}`, title: 'Will you attend?', required: true, options: [{ id: `opt-${Date.now()}`, text: 'New Option' }] });
                break;
            case 'form-footer':
                Object.assign(newBlock.content, { text: 'Thanks for your response!' });
                break;
        } 
        return newBlock; 
    }
    
    function createStickerEditor(block) {
       const stickersHTML = (block.content.stickers || []).map((sticker, index) => {
           return `<div class="sticker-editor" data-sticker-index="${index}">
               <div class="sticker-editor-header">
                   <img src="${sticker.src}" style="width: 30px; height: 30px; border-radius: 4px; object-fit: contain; background: #ddd;">
                   <button class="delete-sticker-btn" title="Delete Sticker">Delete</button>
               </div>
               <div class="control-group"> 
                   <label>Image URL</label> 
                   <div class="image-input-group">
                       <input type="url" data-key="stickers.${index}.src" value="${sticker.src}">
                       <button type="button" class="browse-image-btn" onclick="openImageLibrary('stickers.${index}.src')">Browse...</button>
                   </div>
               </div>
               <div class="style-controls-grid">
                   <div class="control-group"><label>X (%)</label><input type="number" data-key="stickers.${index}.x" value="${Math.round(sticker.x || 50)}"></div>
                   <div class="control-group"><label>Y (%)</label><input type="number" data-key="stickers.${index}.y" value="${Math.round(sticker.y || 50)}"></div>
               </div>
               <div class="style-controls-grid">
                   <div class="control-group"><label>Width (px)</label><input type="number" data-key="stickers.${index}.width" value="${Math.round(sticker.width || 100)}"></div>
                   <div class="control-group"><label>Rotation (°)</label><input type="number" data-key="stickers.${index}.rotation" value="${Math.round(sticker.rotation || 0)}"></div>
               </div>
               <div class="opacity-control">
                   <label>Opacity</label>
                   <input type="range" class="opacity-slider" min="0" max="1" step="0.1" data-key="stickers.${index}.opacity" value="${sticker.opacity || 1}">
                   <span style="font-size: 12px; color: #666;">${Math.round((sticker.opacity || 1) * 100)}%</span>
               </div>
           </div>`;
       }).join('');
       
       return `<hr class="style-separator">
               <div class="control-group">
                   <label>Decorative Elements</label>
                   <button class="add-element-btn" data-block-id="${block.id}" style="width: 100%; background-color: #6f42c1; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">+ Add Element</button>
               </div>
               <div id="sticker-editors-container">${stickersHTML}</div>`;
    }

    function createImageInputHTML(dataKey, value, label) {
        return `<div class="control-group">
            <label>${label}</label>
            <div class="image-input-group">
                <input type="url" data-key="${dataKey}" value="${value || ''}" placeholder="https://images.unsplash.com/photo-...">
                <button type="button" class="browse-image-btn" onclick="openImageLibrary('${dataKey}')">Browse...</button>
            </div>
        </div>`;
    }

    function createOpacityControl(dataKey, value, label = 'Opacity') {
        const opacityValue = value !== undefined ? value : 1;
        return `<div class="opacity-control">
            <label>${label}</label>
            <input type="range" class="opacity-slider" min="0" max="1" step="0.1" data-key="${dataKey}" value="${opacityValue}">
            <span style="font-size: 12px; color: #666;">${Math.round(opacityValue * 100)}%</span>
        </div>`;
    }

    function createEditorFieldsForBlock(block) {
        let fieldsHTML = '';
        const c = block.content;
        const bgPosField = `<div class="control-group"><label>Background Focus Point</label><input type="text" data-key="backgroundPosition" value="${c.backgroundPosition || 'center center'}" placeholder="e.g., center 30%"></div>`;
        const aspectRatioField = `<div class="control-group"><label>Block Shape (Height)</label><select data-key="aspectRatio"> <option value="21/9" ${c.aspectRatio === '21/9' ? 'selected' : ''}>Cinematic</option> <option value="16/9" ${c.aspectRatio === '16/9' ? 'selected' : ''}>Widescreen</option> <option value="8/5" ${c.aspectRatio === '8/5' ? 'selected' : ''}>Landscape (Wide)</option> <option value="3/2"  ${c.aspectRatio === '3/2' ? 'selected' : ''}>Landscape (Classic)</option> <option value="4/3"  ${c.aspectRatio === '4/3' ? 'selected' : ''}>Standard (4:3)</option> <option value="1/1"  ${c.aspectRatio === '1/1' ? 'selected' : ''}>Square</option> <option value="9/12" ${c.aspectRatio === '9/12' ? 'selected' : ''}>Portrait (Standard)</option> <option value="9/16" ${c.aspectRatio === '9/16' ? 'selected' : ''}>Portrait (Tall)</option> </select></div>`;
        const titleStyleField = (styleObj) => `<label>Title Style</label>${createStyleControlsHTML('titleStyle', styleObj, { textAlign: true, color: true, size: true, weight: true, family: true })}`;
        const sectionTitleField = (title) => `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${title}"></div>`;
        const createOptionalElementEditor = (key, label) => {
            const element = c[key];
            if (!element) return '';
            return `<div class="control-group"> <div class="optional-element-header"> <label>${label}</label> <label><input type="checkbox" data-key="${key}.enabled" ${element.enabled ? 'checked' : ''}> Show</label> </div> <input type="text" data-key="${key}.text" value="${element.text}"> ${createStyleControlsHTML(`${key}.style`, element.style)} </div>`;
        };

        switch (block.type) {
            case 'hero':
                fieldsHTML = `${createImageInputHTML('imageUrl', c.imageUrl, 'Background Image URL')}
                    ${createOpacityControl('opacity', c.opacity, 'Background Opacity')}
                    <div class="control-group">
                        <label>Block Width</label>
                        <select data-key="fullWidth">
                            <option value="true" ${c.fullWidth ? 'selected' : ''}>Full Width</option>
                            <option value="false" ${!c.fullWidth ? 'selected' : ''}>Limited (use global width)</option>
                        </select>
                    </div>
                    ${createOptionalElementEditor('names', 'Names')}
                    <hr class="style-separator">
                    ${createOptionalElementEditor('subtitle', 'Subtitle')}
                    <hr class="style-separator">
                    ${createOptionalElementEditor('date', 'Date')}
                    <hr class="style-separator">
                    ${aspectRatioField}${bgPosField}
                    ${createInnerBlocksEditor(block)}
                    ${createStickerEditor(block)}
                    ${createBackgroundControlsHTML(block)}`;
                break;

            case 'text-block':
                fieldsHTML = `<div class="control-group"><label>Title (optional)</label><input type="text" data-key="title" value="${c.title || ''}"></div>${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${c.text}</textarea></div>${createStyleControlsHTML('textStyle', c.textStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;

            case 'rsvp':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle}</textarea>${createStyleControlsHTML('subtitleStyle', c.subtitleStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}</div><hr class="style-separator"><label>Button Style</label><div class="style-controls"><div class="style-controls-grid"><div class="control-group"><label>Background Color</label><input type="color" data-key="buttonStyle.backgroundColor" value="${c.buttonStyle.backgroundColor || '#c5a98b'}"></div><div class="control-group"><label>Text Color</label><input type="color" data-key="buttonStyle.color" value="${c.buttonStyle.color || '#FFFFFF'}"></div></div><div style="margin-top: 10px;">${createStyleControlsHTML('buttonStyle', c.buttonStyle, {color: false, size: true, weight: true, family: true})}</div></div>${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;

            case 'countdown':
            case 'location':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}`;

                if (block.type === 'countdown') {
                    fieldsHTML += `<hr class="style-separator"><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${c.targetDate}"></div>
                    <hr class="style-separator">
                    <label>Numbers Style (e.g., 40)</label>
                    ${createStyleControlsHTML('numberStyle', c.numberStyle, { color: true, size: true, weight: true, family: true })}
                    <hr class="style-separator">
                    <label>Labels Style (e.g., Days)</label>
                    ${createStyleControlsHTML('labelStyle', c.labelStyle, { color: true, size: true, weight: true, family: true })}`;
                }

                if (block.type === 'location') {
                    fieldsHTML += `<hr class="style-separator"><div class="control-group"><label>Smart Location Search</label><input type="text" class="smart-location-search" placeholder="e.g., Per Se, New York"></div>
                    <div class="control-group"><label>Address</label><textarea data-key="address">${c.address || ''}</textarea></div>
                    ${createStyleControlsHTML('addressStyle', c.addressStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    ${createImageInputHTML('imageUrl', c.imageUrl, 'Photo URL')}${createOpacityControl('opacity', c.opacity, 'Photo Opacity')}<div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${c.mapLink || ''}" onblur="handleMapLinkBlur(this.value, ${pageBlocks.indexOf(block)})"></div>`;
                }

                fieldsHTML += createInnerBlocksEditor(block) + createStickerEditor(block) + createBackgroundControlsHTML(block);
                break;

            case 'schedule':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator">${createScheduleItemsEditor(block)}${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;

            case 'image':
                fieldsHTML = `${createImageInputHTML('imageUrl', c.imageUrl, 'Image URL')}
                    ${createOpacityControl('opacity', c.opacity, 'Image Opacity')}
                    <div class="control-group"><label>Title (optional)</label><input type="text" data-key="title" value="${c.title || ''}"></div>
                    ${createStyleControlsHTML('titleStyle', c.titleStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    <hr class="style-separator">
                    <div class="control-group"><label>Description (optional)</label><textarea data-key="description">${c.description || ''}</textarea></div>
                    ${createStyleControlsHTML('descriptionStyle', c.descriptionStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    <hr class="style-separator">
                    <div class="control-group"><label>Caption (optional)</label><input type="text" data-key="caption" value="${c.caption || ''}"></div>
                    ${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;

            case 'form-header':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle}</textarea></div>${createImageInputHTML('imageUrl', c.imageUrl, 'Background Image URL')}${createOpacityControl('opacity', c.opacity, 'Background Opacity')}${aspectRatioField}${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;

            case 'input-question':
            case 'textarea-question':
                fieldsHTML = `<div class="control-group"><label>Question Text</label><input type="text" data-key="title" value="${c.title}"></div><div class="control-group"><label><input type="checkbox" data-key="required" ${c.required ? 'checked' : ''}> Required</label></div>${createBackgroundControlsHTML(block)}`;
                break;

            case 'radio-question':
                const optionsHTML = (c.options || []).map((option, index) => {
                    return `<div class="schedule-item-editor" data-item-id="${option.id}">
                        <div class="schedule-item-editor-header">
                            <h4>Option ${index + 1}</h4>
                            <button class="delete-schedule-item-btn" title="Delete this option">Delete</button>
                        </div>
                        <input type="text" class="sub-item-input" data-item-key="text" value="${option.text || ''}" placeholder="Option text">
                    </div>`;
                }).join('');
                fieldsHTML = `<div class="control-group"><label>Question Text</label><input type="text" data-key="title" value="${c.title}"></div><div class="control-group"><label><input type="checkbox" data-key="required" ${c.required ? 'checked' : ''}> Required</label></div><div class="control-group"><label>Options</label><div class="schedule-items-list">${optionsHTML}</div><button class="add-sub-item-btn action-button" data-list-key="options" style="font-size: 12px; padding: 5px; margin-top: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px;">+ Add Option</button></div>${createBackgroundControlsHTML(block)}`;
                break;

            case 'form-footer':
                fieldsHTML = `<div class="control-group"><label>Footer Text</label><input type="text" data-key="text" value="${c.text}"></div>${createInnerBlocksEditor(block)}${createStickerEditor(block)}${createBackgroundControlsHTML(block)}`;
                break;
            default:
                fieldsHTML = 'No editor available for this block type.';
        }
        return fieldsHTML;
    }
    
    function renderEditor() { 
        const container = document.getElementById('editor-content'); 
        const currentlyOpen = [...container.querySelectorAll('.editor-block-content.is-open')].map(el => el.closest('.editor-block').dataset.id); 
        container.innerHTML = ''; 
        pageBlocks.forEach(block => { 
            const tpl = document.getElementById('editor-block-template').content.cloneNode(true); 
            const editorBlock = tpl.querySelector('.editor-block'); 
            editorBlock.dataset.id = block.id; 
            const title = block.type.charAt(0).toUpperCase() + block.type.slice(1).replace(/-/g, ' '); 
            editorBlock.querySelector('.editor-block-title').textContent = title; 
            const contentDiv = editorBlock.querySelector('.editor-block-content'); 
            contentDiv.innerHTML = createEditorFieldsForBlock(block); 
            if (currentlyOpen.includes(block.id)) { 
                contentDiv.classList.add('is-open'); 
                editorBlock.querySelector('.toggle-btn').textContent = '▲'; 
            } 
            container.appendChild(tpl); 
        }); 
        initializeMapsForEditor(); 
    }
    
    async function handleMapLinkBlur(url, blockIndex) { 
        const trimmedUrl = url.trim(); 
        if (!trimmedUrl || (!trimmedUrl.includes('maps.app.goo.gl') && !trimmedUrl.includes('goo.gl/maps'))) return; 
        const statusText = document.getElementById('status-text'); 
        try { 
            statusText.innerText = 'Analyzing shortened link...'; 
            const response = await fetch(`/.netlify/functions/unshorten-url?url=${encodeURIComponent(trimmedUrl)}`); 
            const data = await response.json(); 
            if (!response.ok || data.error) throw new Error(data.error || 'Could not get data from link.'); 
            statusText.innerText = 'Searching for place details...'; 
            const service = new google.maps.places.PlacesService(document.createElement('div')); 
            const place = await new Promise((resolve, reject) => { 
                service.textSearch({ query: data.placeName, fields: ['name', 'formatted_address', 'photos', 'url'] }, (results, status) => { 
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) { 
                        resolve(results[0]); 
                    } else { 
                        reject(new Error('Place details not found.')); 
                    } 
                }); 
            }); 
            const block = pageBlocks[blockIndex]; 
            block.content.title = place.name || ''; 
            block.content.address = place.formatted_address || ''; 
            block.content.mapLink = place.url || trimmedUrl; 
            if (place.photos && place.photos.length > 0) { 
                block.content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); 
            } 
            statusText.innerText = 'Location data updated!'; 
            renderEditor(); 
            renderPreview(); 
        } catch (error) { 
            console.error('Error fetching place data from URL:', error); 
            statusText.innerText = `Error: ${error.message}`; 
        } finally { 
            setTimeout(() => { statusText.innerText = ''; }, 4000); 
        } 
    }
    
    function initializeMapsForEditor() { 
        if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') { 
            return; 
        } 
        document.querySelectorAll('.smart-location-search').forEach(input => { 
            if (input.dataset.mapsInitialized) return; 
            input.dataset.mapsInitialized = 'true'; 
            const autocomplete = new google.maps.places.Autocomplete(input, { 
                fields: ["name", "formatted_address", "photos", "url"], 
                types: ["establishment"] 
            }); 
            autocomplete.addListener('place_changed', () => { 
                const place = autocomplete.getPlace(); 
                if (!place) return; 
                const blockDiv = input.closest('.editor-block'); 
                const blockId = blockDiv.dataset.id; 
                const blockIndex = pageBlocks.findIndex(b => b.id === blockId); 
                if (blockIndex === -1) return; 
                const content = pageBlocks[blockIndex].content; 
                content.title = place.name || ''; 
                content.address = place.formatted_address || ''; 
                content.mapLink = place.url || ''; 
                if (place.photos && place.photos.length > 0) { 
                    content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); 
                } 
                renderEditor(); 
                renderPreview(); 
            }); 
        }); 
    }
    
    function setupEventListeners() { 
        const editorContent = document.getElementById('editor-content'); 

        const handleEditorChange = (e) => {
            const input = e.target;
            const blockDiv = input.closest('.editor-block');
            if (!blockDiv) return;

            const blockId = blockDiv.dataset.id;
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
            if (blockIndex === -1) return;

            const key = input.dataset.key;

            if (input.matches('.sub-item-input')) {
                const subItemDiv = input.closest('.schedule-item-editor');
                const subItemId = subItemDiv.dataset.itemId;
                const subItemKey = input.dataset.itemKey;
                const listKey = pageBlocks[blockIndex].content.items ? 'items' : 'options';
                const subItemIndex = pageBlocks[blockIndex].content[listKey].findIndex(i => i.id === subItemId);
                if (subItemIndex > -1) pageBlocks[blockIndex].content[listKey][subItemIndex][subItemKey] = input.value;

            } else if (key) {
                let value = input.type === 'checkbox' ? input.checked : input.value;
                if (input.type === 'number' || input.type === 'range') value = parseFloat(value) || 0;
                if (key === 'fullWidth') value = value === 'true';

                const keys = key.split('.');
                let current = pageBlocks[blockIndex].content;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) {
                        current[keys[i]] = isNaN(parseInt(keys[i + 1], 10)) ? {} : [];
                    }
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;

                if (keys[0] === 'innerBlocks' && keys[2] === 'text') {
                    const innerBlockIndex = parseInt(keys[1], 10);
                    if (pageBlocks[blockIndex]?.content?.innerBlocks?.[innerBlockIndex]) {
                        pageBlocks[blockIndex].content.innerBlocks[innerBlockIndex].width = 'auto';
                    }
                }

                if (input.type === 'range' && input.classList.contains('opacity-slider')) {
                    const span = input.nextElementSibling;
                    if (span) span.textContent = `${Math.round(value * 100)}%`;
                }
            }
            renderPreview();
        };
       
        editorContent.addEventListener('input', handleEditorChange); 
        editorContent.addEventListener('change', handleEditorChange); 
       
        editorContent.addEventListener('click', (e) => { 
            const target = e.target; 
            const blockDiv = target.closest('.editor-block'); 
            if (!blockDiv) return; 
           
            const blockId = blockDiv.dataset.id; 
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
            if (blockIndex === -1) return;
           
            if (target.matches('.add-inner-block-btn')) { 
                const newInnerBlock = {
                    id: `inner-${Date.now()}`,
                    text: 'New Text',
                    style: { ...defaultTextStyle, fontFamily: 'Montserrat', color: '#cc0000', fontSize: '24px', textAlign: 'center' },
                    x: 50,
                    y: 30,
                    width: 200,
                    rotation: 0
                }; 
                if (!pageBlocks[blockIndex].content.innerBlocks) {
                    pageBlocks[blockIndex].content.innerBlocks = [];
                }
                pageBlocks[blockIndex].content.innerBlocks.push(newInnerBlock); 
                renderEditor(); 
                renderPreview(); 
            } 
            else if (target.matches('.delete-inner-block-btn')) { 
                const innerIndex = parseInt(target.closest('.inner-block-editor').dataset.index, 10); 
                pageBlocks[blockIndex].content.innerBlocks.splice(innerIndex, 1); 
                renderEditor(); 
                renderPreview(); 
            }
            else if (target.matches('.add-element-btn')) {
                openElementLibrary(target.dataset.blockId);
            } else if (target.matches('.delete-sticker-btn')) { 
                const stickerIndex = parseInt(target.closest('.sticker-editor').dataset.stickerIndex, 10); 
                pageBlocks[blockIndex].content.stickers.splice(stickerIndex, 1); 
                renderEditor(); 
                renderPreview(); 
            } else if (target.closest('.delete-block-btn')) { 
                if (confirm('Are you sure?')) { 
                    pageBlocks.splice(blockIndex, 1); 
                    renderEditor(); 
                    renderPreview(); 
                } 
            } else if (target.closest('.add-sub-item-btn')) { 
                const listKey = target.dataset.listKey; 
                if (listKey === 'items') {
                    pageBlocks[blockIndex].content[listKey].push({ id: `item-${Date.now()}`, time: '3:00 PM', title: 'New Event', desc: 'Event description', timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } });
                } else if (listKey === 'options') {
                    pageBlocks[blockIndex].content[listKey].push({ id: `opt-${Date.now()}`, text: 'New Option' });
                }
                renderEditor(); 
                renderPreview(); 
            } else if (target.closest('.delete-schedule-item-btn')) { 
                const subItemId = target.closest('.schedule-item-editor').dataset.itemId; 
                const listKey = pageBlocks[blockIndex].content.items ? 'items' : 'options'; 
                pageBlocks[blockIndex].content[listKey] = pageBlocks[blockIndex].content[listKey].filter(i => i.id !== subItemId); 
                renderEditor(); 
                renderPreview(); 
            } else if (target.closest('.editor-block-header')) { 
                const content = blockDiv.querySelector('.editor-block-content'); 
                if (content) { 
                    content.classList.toggle('is-open'); 
                    blockDiv.querySelector('.toggle-btn').textContent = content.classList.contains('is-open') ? '▲' : '▼'; 
                } 
            } 
        }); 
    }
   
    const addBlockModal = document.getElementById('add-block-modal'); 
    document.getElementById('add-block-btn').addEventListener('click', () => addBlockModal.classList.add('is-visible')); 
    document.getElementById('modal-close-btn').addEventListener('click', () => addBlockModal.classList.remove('is-visible')); 
    addBlockModal.addEventListener('click', (e) => { 
        if (e.target === addBlockModal) addBlockModal.classList.remove('is-visible'); 
    }); 
    document.getElementById('add-block-options').addEventListener('click', (e) => { 
        if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { 
            const newBlock = getNewBlockData(e.target.dataset.type); 
            pageBlocks.push(newBlock); 
            renderEditor(); 
            renderPreview(); 
            addBlockModal.classList.remove('is-visible'); 
        } 
    });
    
    let resizeObserver; 
    function setupResizeObserver() { 
        if (resizeObserver) resizeObserver.disconnect(); 
        const previewBody = iframe.contentWindow.document.body; 
        if (!previewBody) return; 
        resizeObserver = new ResizeObserver(() => { 
            iframe.style.height = previewBody.scrollHeight + 'px'; 
        }); 
        resizeObserver.observe(previewBody); 
        iframe.style.height = previewBody.scrollHeight + 'px'; 
    }
    
    function renderPreview() { 
        if (iframe.contentWindow && typeof iframe.contentWindow.renderPage === 'function') { 
            iframe.contentWindow.renderPage(pageBlocks, pageSettings); 
            if (pageSettings.displayMode === 'ribbon' && pageSettings.maxWidth) {
                setTimeout(() => {
                    const pageContent = iframe.contentWindow.document.getElementById('page-content');
                    if (pageContent) {
                        pageContent.style.maxWidth = pageSettings.maxWidth;
                    }
                }, 100);
            }
        } 
    }
    
    function initSortable() { 
        const c = document.getElementById('editor-content'); 
        Sortable.create(c, { 
            handle: '.drag-handle', 
            animation: 150, 
            onEnd: (evt) => { 
                const mi = pageBlocks.splice(evt.oldIndex, 1)[0]; 
                pageBlocks.splice(evt.newIndex, 0, mi); 
                renderPreview(); 
            }
        }); 
    }
    
    // FINAL CODE FOR SHARE BUTTON
    document.getElementById('share-button').addEventListener('click', async function() {
        const statusText = document.getElementById('status-text');
        this.disabled = true;
        statusText.innerText = 'Processing...';
        saveCurrentPageData();

        // Check that API URL for RSVP form is entered
        const currentApiUrl = document.getElementById('sheetdb-api-input').value.trim();
        if (!currentApiUrl) {
            alert('Please enter your SheetDB API URL before generating the link.');
            statusText.innerText = '';
            this.disabled = false;
            return;
        }

        // Save API URL in RSVP form settings
        rsvpFormData.settings.sheetDbApiUrl = currentApiUrl;

        const dataToSave = { main: mainPageData, rsvp: rsvpFormData };

        try {
            statusText.innerText = 'Saving...';
            const response = await fetch('/.netlify/functions/create-bundle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `Server Error (${response.status})`);

            const mainLink = result.link;
            
            await navigator.clipboard.writeText(mainLink);
            
            // Generate headers
            const headers = rsvpFormData.blocks
                .filter(b => ['input-question', 'textarea-question', 'radio-question'].includes(b.type))
                .map(b => b.content.title);
            const headersString = headers.join(', ');

            // Form and show instruction
            const instructionContent = document.getElementById('instruction-content');
            instructionContent.innerHTML = `
                <h2>Success! Your links are ready.</h2>
                <p><strong>Your Invitation Link (copied to clipboard):</strong></p>
                <p style="word-break: break-all; background:#f0f2f5; padding:8px; border-radius:4px;">${mainLink}</p>
                <hr style="margin: 20px 0;">
                <h3><strong>Next Step:</strong> Prepare Your Google Sheet</h3>
                <p>To receive guest responses, please do the following:</p>
                <ol>
                    <li>Open your Google Sheet.</li>
                    <li>Copy the headers below and paste them into the <strong>first row</strong> of your sheet.</li>
                </ol>
                <pre id="headers-to-copy" style="background: #eee; padding: 10px; border-radius: 5px; cursor: pointer;">${headersString}</pre>
                <button id="copy-headers-btn" class="action-button" style="background-color: #007bff; width:auto; padding: 10px 20px;">Copy Headers</button>
            `;
            
            document.getElementById('instruction-modal').classList.add('is-visible');

            document.getElementById('copy-headers-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(headersString).then(() => alert('Headers copied!'));
            });

            statusText.innerText = 'Done! Follow the instructions.';

        } catch (err) {
            statusText.innerText = `Error: ${err.message}`;
        } finally {
            this.disabled = false;
        }
    });
    
    const editMainBtn = document.getElementById('edit-main-btn'), 
          editRsvpBtn = document.getElementById('edit-rsvp-btn'), 
          globalWidthInput = document.getElementById('global-width-input'), 
          globalStyleSelect = document.getElementById('global-style-select'), 
          globalBgImageGroup = document.getElementById('global-bg-image-group'), 
          globalBgImageInput = document.getElementById('global-bg-image-input'),
          globalBgColorInput = document.getElementById('global-bg-color-input'),
          modeBlocksBtn = document.getElementById('mode-blocks'),
          modeRibbonBtn = document.getElementById('mode-ribbon');
    
    function toggleBgImageField() { 
        globalBgImageGroup.style.display = (pageSettings.style === 'modern') ? 'block' : 'none'; 
    } 
    
    globalStyleSelect.addEventListener('change', () => { 
        pageSettings.style = globalStyleSelect.value; 
        toggleBgImageField(); 
        renderPreview(); 
    }); 
    
    globalBgImageInput.addEventListener('input', () => { 
        pageSettings.backgroundImage = globalBgImageInput.value; 
        renderPreview(); 
    }); 
    
    globalBgColorInput.addEventListener('input', () => { 
        pageSettings.backgroundColor = globalBgColorInput.value; 
        renderPreview(); 
    }); 
    
    globalWidthInput.addEventListener('input', () => { 
        pageSettings.maxWidth = globalWidthInput.value; 
        renderPreview(); 
    }); 

    // Display mode event listeners
    modeBlocksBtn.addEventListener('click', () => {
        pageSettings.displayMode = 'blocks';
        modeBlocksBtn.classList.add('active');
        modeRibbonBtn.classList.remove('active');
        renderPreview();
    });

    modeRibbonBtn.addEventListener('click', () => {
        pageSettings.displayMode = 'ribbon';
        modeRibbonBtn.classList.add('active');
        modeBlocksBtn.classList.remove('active');
        renderPreview();
    });

    // Add handler for API URL field
    document.getElementById('sheetdb-api-input').addEventListener('input', (e) => {
        if (currentTemplate === rsvpFormData.template) {
            rsvpFormData.settings.sheetDbApiUrl = e.target.value;
        }
    });
    
    function saveCurrentPageData() {
        const data = {
            settings: JSON.parse(JSON.stringify(pageSettings)),
            blocks: JSON.parse(JSON.stringify(pageBlocks))
        };
        
        if (currentTemplate === mainPageData.template) {
            mainPageData = {...mainPageData, ...data};
        } else {
            rsvpFormData = {...rsvpFormData, ...data};
            if (!rsvpFormData.settings) rsvpFormData.settings = {};
            rsvpFormData.settings.sheetDbApiUrl = document.getElementById('sheetdb-api-input').value;
        }
    }
    
    function switchEditorMode(target) {
        currentTemplate = target.template;
        pageSettings = JSON.parse(JSON.stringify(target.settings));
        pageBlocks = JSON.parse(JSON.stringify(target.blocks));
        
        globalWidthInput.value = pageSettings.maxWidth;
        globalStyleSelect.value = pageSettings.style;
        globalBgImageInput.value = pageSettings.backgroundImage || '';
        globalBgColorInput.value = pageSettings.backgroundColor || '#f8f7f5';
        
        // Update display mode buttons
        if (pageSettings.displayMode === 'ribbon') {
            modeRibbonBtn.classList.add('active');
            modeBlocksBtn.classList.remove('active');
        } else {
            modeBlocksBtn.classList.add('active');
            modeRibbonBtn.classList.remove('active');
        }
        
        toggleBgImageField();
        
        iframe.src = `templates/${currentTemplate}?v=${Date.now()}`;
        
        editMainBtn.classList.toggle('active', currentTemplate === mainPageData.template);
        editRsvpBtn.classList.toggle('active', currentTemplate === rsvpFormData.template);

        const apiSettingsDiv = document.querySelector('.api-settings');
        const sheetDbApiInput = document.getElementById('sheetdb-api-input');

        if (currentTemplate === rsvpFormData.template) {
            apiSettingsDiv.style.display = 'block';
            sheetDbApiInput.value = target.settings.sheetDbApiUrl || '';
        } else {
            apiSettingsDiv.style.display = 'none';
        }

        // Update add block modal options based on current template
        updateAddBlockOptions();
    }

    function updateAddBlockOptions() {
        const addBlockOptions = document.getElementById('add-block-options');
        const isRsvpMode = currentTemplate === rsvpFormData.template;
        
        // Show/hide options based on current template
        const buttons = addBlockOptions.querySelectorAll('button');
        buttons.forEach(btn => {
            const type = btn.dataset.type;
            if (isRsvpMode) {
                // In RSVP mode, show form blocks and basic content blocks
                const allowedTypes = ['hero', 'text-block', 'image', 'form-header', 'input-question', 'textarea-question', 'radio-question', 'form-footer'];
                btn.style.display = allowedTypes.includes(type) ? 'block' : 'none';
            } else {
                // In main mode, show all blocks except form-specific ones
                const formTypes = ['form-header', 'input-question', 'textarea-question', 'radio-question', 'form-footer'];
                btn.style.display = formTypes.includes(type) ? 'none' : 'block';
            }
        });

        // Show/hide separators
        const separators = addBlockOptions.querySelectorAll('hr');
        separators.forEach(sep => {
            if (isRsvpMode) {
                sep.style.display = 'block';
            } else {
                // Hide the last separator in main mode since form blocks are hidden
                const nextSibling = sep.nextElementSibling;
                if (nextSibling && nextSibling.dataset.type === 'form-header') {
                    sep.style.display = 'none';
                } else {
                    sep.style.display = 'block';
                }
            }
        });
    }
    
    editMainBtn.addEventListener('click', () => { 
        if (currentTemplate !== mainPageData.template) { 
            saveCurrentPageData(); 
            switchEditorMode(mainPageData); 
        } 
    }); 
    
    editRsvpBtn.addEventListener('click', () => { 
        if (currentTemplate !== rsvpFormData.template) { 
            saveCurrentPageData(); 
            switchEditorMode(rsvpFormData); 
        } 
    });
    
    window.openImageLibrary = function(targetId) {
        if (targetId.startsWith('backgroundImage-')) {
            const blockId = targetId.replace('backgroundImage-', '');
            currentImageTarget = `backgroundImage-${blockId}`;
        } else {
            currentImageTarget = targetId;
        }
        
        const modal = document.getElementById('image-library-modal');
        const grid = document.getElementById('image-library-grid');
        
        grid.innerHTML = predefinedImages.map(url => 
            `<div class="image-library-item" onclick="selectImage('${url}')">
                <img src="${url}" alt="Image option" loading="lazy">
            </div>`
        ).join('');
        
        modal.classList.add('is-visible');
    };
    
    // Fixed message handler for element updates
    window.addEventListener('message', (event) => {
        if (event.source !== iframe.contentWindow) return;
        const { type, payload } = event.data;
        
        if (type === 'UPDATE_STICKER' || type === 'UPDATE_INNER_BLOCK') {
            const { blockId, id, newProps } = payload;
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
            if (blockIndex === -1) return;

            const targetArrayKey = (type === 'UPDATE_STICKER') ? 'stickers' : 'innerBlocks';
            const targetArray = pageBlocks[blockIndex].content[targetArrayKey];
            if (!targetArray) return;

            const elementIndex = targetArray.findIndex(s => s.id === id);
            if (elementIndex === -1) return;
            
            Object.assign(targetArray[elementIndex], newProps);
            renderEditor(); 
        } 
        else if (type === 'TEXT_ELEMENT_CLICKED') {
            showTextEditingToolbar(payload.blockId, payload.elementKey, payload.currentStyle);
        } 
        else if (type === 'HIDE_TEXT_TOOLBAR') {
            hideTextEditingToolbar();
        }
    });
    
    async function initEditor() {
        // Check for customer mode
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        isCustomerMode = !!id;

        // Fetch API keys from server function
        try {
            const response = await fetch('/.netlify/functions/get-api-keys');
            if (response.ok) {
                apiKeys = await response.json();
            } else {
                console.warn('Could not fetch API keys from server');
            }
        } catch (error) {
            console.warn('Error fetching API keys:', error);
        }

        const initialize = () => { 
            if (isCustomerMode) {
                // Hide style selection controls in customer mode
                document.querySelector('.global-settings')?.remove(); 
            }
            initSortable(); 
            setupEventListeners(); 
            iframe.onload = () => { 
                renderEditor(); 
                renderPreview(); 
                setupResizeObserver(); 
            }; 
            switchEditorMode(mainPageData); 
        };
        
        if (isCustomerMode) { 
            const status = document.getElementById('status-text'); 
            status.innerText = 'Loading...'; 
            fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, { 
                headers: { 'X-Access-Key': '$2a$10$c.QWLI8NIw84W3uqmH/mUez32F1LK7KPBirRW7hr1nE0mJ9CAATC6' } 
            }).then(r => r.ok ? r.json() : Promise.reject(new Error('Could not load template.')))
            .then(d => { 
                mainPageData = d.record.main; 
                rsvpFormData = d.record.rsvp; 
                status.innerText = ''; 
                initialize(); 
            }).catch(e => document.body.innerHTML = `<h1>Error</h1><p>${e.message}</p>`); 
        } else { 
            initialize(); 
        }
    }
    
    function mapsReady() { 
        initializeMapsForEditor(); 
    }
    
    initEditor();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRylKwrQtZHNk3PvtpPqRbLpPwKQNF26k&libraries=places&callback=mapsReady"></script>
</body>
</html>