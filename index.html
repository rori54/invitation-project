<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } body { margin: 0; display: grid; grid-template-columns: 420px 1fr; background-color: #f0f2f5; } #editor-panel { grid-column: 1; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; } #preview-panel { grid-column: 2; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; } #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; } iframe { width: 100%; height: 100%; border: none; display: block; } #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } .global-settings { margin-top: 15px; } #editor-content { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 0; } #editor-footer { padding: 20px; border-top: 1px solid #eee; } .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } .editor-block-title { font-weight: bold; flex-grow: 1; } .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } .delete-block-btn { color: crimson !important; } .editor-block-content { padding: 15px; display: none; } .editor-block-content.is-open { display: block; }
        .control-group { margin-bottom: 15px; } .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } input.smart-location-search { border-left: 4px solid #28a745; } textarea { min-height: 80px; }
        .style-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; } .style-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; } .style-controls .control-group { margin-bottom: 0; } input[type="color"] { padding: 2px; min-height: 38px; } .style-controls label { font-size: 0.9em; font-weight: 600; color: #555; } hr.style-separator { border: none; border-top: 1px dashed #ccc; margin: 15px 0; }
        .optional-element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } .optional-element-header label { margin-bottom: 0; }
        .sticker-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #6f42c1; } .sticker-editor-header { display: flex; justify-content: space-between; align-items: center; } .sticker-editor .control-group { margin-bottom: 8px; } .sticker-editor .control-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 3px; } .delete-sticker-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-weight: bold; cursor: pointer; }
        .inner-blocks-container { border-top: 2px solid #007bff; margin-top: 20px; padding-top: 15px; } .inner-block-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid #007bff; } .inner-block-editor .delete-inner-block-btn { float: right; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; line-height: 22px; text-align: center; } .add-inner-block-controls button { background-color: #e9ecef; border: 1px dashed #ccc; padding: 8px; margin-right: 5px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } .modal-overlay.is-visible { display: flex; } .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; } .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; } #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .image-input-group { display: flex; gap: 8px; align-items: stretch; } .image-input-group input[type="url"] { flex: 1; } .browse-image-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px; } .browse-image-btn:hover { background: #0056b3; }
        .image-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; } .image-library-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: border-color 0.2s; } .image-library-item:hover { border-color: #007bff; } .image-library-item img { width: 100%; height: 80px; object-fit: cover; display: block; }
        .upload-section { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; } .upload-section.dragover { border-color: #007bff; background-color: #f8f9fa; } .upload-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; } .upload-btn:hover { background: #218838; }
        .opacity-control { margin-top: 10px; } .opacity-slider { width: 100%; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="editor-panel"> <div id="editor-header"><h2>Editor</h2><div class="template-switcher"><button id="edit-main-btn" class="active">Invitation</button><button id="edit-rsvp-btn">RSVP Form</button></div><div class="global-settings"><div class="control-group"><label for="global-style-select">Page Style</label><select id="global-style-select"><option value="classic">Classic (Cards)</option><option value="modern">Modern (Shared Background)</option></select></div><div class="control-group" id="global-bg-image-group"><label for="global-bg-image-input">Background Image URL</label><div class="image-input-group"><input type="url" id="global-bg-image-input" placeholder="https://images.unsplash.com/photo-..."><button type="button" class="browse-image-btn" onclick="openImageLibrary('global-bg-image-input')">Browse...</button></div></div><div class="control-group"><label for="global-width-input">Global Block Width</label><input type="text" id="global-width-input" placeholder="e.g., 800px or 90%"></div></div></div> <div id="editor-content"></div> <div id="editor-footer"><button id="add-block-btn" class="action-button" style="margin-bottom: 15px; background-color: #28a745;">+ Add New Block</button><button id="share-button" class="action-button">Generate & Copy Link</button><p id="status-text" style="text-align:center; margin-top:10px;"></p></div> </div> <div id="preview-panel"><div id="preview-wrapper"><iframe id="preview-frame" scrolling="no"></iframe></div></div> <template id="editor-block-template"><div class="editor-block"><div class="editor-block-header"><span class="drag-handle">☰</span><span class="editor-block-title">Block Title</span><div class="editor-block-controls"><button class="toggle-btn">▼</button><button class="delete-block-btn" title="Delete Block">×</button></div></div><div class="editor-block-content"></div></div></template> <div id="add-block-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close" id="modal-close-btn">×</span><h3>Choose a Block to Add</h3><div id="add-block-options"><button data-type="hero">Hero</button><button data-type="text-block">Text Block</button><button data-type="image">Image</button><hr><button data-type="schedule">Schedule</button><button data-type="location">Location</button><button data-type="countdown">Countdown</button><button data-type="rsvp">RSVP Button</button><hr><button data-type="form-header">Form: Header</button><button data-type="input-question">Form: Text Input</button><button data-type="textarea-question">Form: Text Area</button><button data-type="radio-question">Form: Radio Choice</button><button data-type="form-footer">Form: Footer</button></div></div></div>

    <div id="image-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeImageLibrary()">×</span>
            <h3>Image Library</h3>
            
            <div class="upload-section" id="upload-section">
                <p>Drag & drop an image here or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">Choose File</button>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">Uploads via ImgBB (free image hosting)</p>
            </div>
            
            <div class="image-library-grid" id="image-library-grid">
                <!-- Predefined images will be populated here -->
            </div>
        </div>
    </div>

    <script>
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; let pageSettings = {}; let currentTemplate = '';
    let apiKeys = {}; // For storing API keys from server
    let currentImageTarget = null; // For image library
    
    const defaultTextStyle = { fontFamily: 'Montserrat', fontSize: '1rem', color: '#333333', fontWeight: '400' };
    const defaultTitleStyle = { fontFamily: 'Playfair Display', fontSize: '2.2rem', color: '#111111', fontWeight: '700' };

    let mainPageData = { template: 'wedding-classic.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ { type: 'hero', id: `block-${Date.now()}-1`, content: { subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, names: { text: 'John & Jane', enabled: true, style: { fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF', fontWeight: '400' } }, date: { text: 'September 15, 2025', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, imageUrl: 'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg', backgroundPosition: 'center 30%', aspectRatio: '9/16', opacity: 1, innerBlocks: [], stickers: [] }}, { type: 'text-block', id: `block-${Date.now()}-3`, content: { title: 'A few words', text: 'We are excited to share this special day with our closest family and friends.', titleStyle: { ...defaultTitleStyle, fontSize: '2.5rem' }, textStyle: { ...defaultTextStyle, fontSize: '1.1rem', textAlign: 'center' } }}, { type: 'countdown', id: `block-${Date.now()}-2`, content: { title: 'Until Our Big Day', targetDate: '2025-09-15T16:00', titleStyle: { ...defaultTitleStyle } }}, { type: 'schedule', id: `block-${Date.now()}-4`, content: { title: "The Day's Schedule", items: [], titleStyle: { ...defaultTitleStyle } }}, { type: 'location', id: `block-${Date.now()}-5`, content: { title: 'Venue', address: 'The Grand Hall, 123 Celebration Ave, New York', imageUrl: 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', opacity: 1, mapLink: 'https://maps.google.com', titleStyle: { ...defaultTitleStyle } }}, { type: 'rsvp', id: `block-${Date.now()}-6`, content: { title: 'Confirm Your Attendance', subtitle: 'Please reply by September 1st.', titleStyle: { ...defaultTitleStyle }, buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' } }} ] };
    let rsvpFormData = { template: 'rsvp-form.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ ] };
    
    const fontOptionsHTML = `<optgroup label="Script/Handwritten"> <option value="Great Vibes">Great Vibes</option> <option value="Dancing Script">Dancing Script</option> <option value="Allura">Allura</option> <option value="Sacramento">Sacramento</option> <option value="Alex Brush">Alex Brush</option> <option value="Satisfy">Satisfy</option> <option value="Kaushan Script">Kaushan Script</option> <option value="Pacifico">Pacifico</option> <option value="Caveat">Caveat</option> <option value="Cookie">Cookie</option> </optgroup> <optgroup label="Elegant Serif"> <option value="Playfair Display">Playfair Display</option> <option value="Crimson Text">Crimson Text</option> <option value="Cormorant Garamond">Cormorant Garamond</option> <option value="EB Garamond">EB Garamond</option> <option value="Libre Baskerville">Libre Baskerville</option> <option value="Lora">Lora</option> <option value="Merriweather">Merriweather</option> <option value="Vollkorn">Vollkorn</option> </optgroup> <optgroup label="Decorative"> <option value="Cinzel">Cinzel</option> <option value="Abril Fatface">Abril Fatface</option> <option value="Amatic SC">Amatic SC</option> <option value="Fredoka One">Fredoka One</option> <option value="Lobster">Lobster</option> </optgroup> <optgroup label="Modern Sans-Serif"> <option value="Montserrat">Montserrat</option> <option value="Raleway">Raleway</option> <option value="Lato">Lato</option> <option value="Open Sans">Open Sans</option> <option value="Poppins">Poppins</option> </optgroup>`;
    
    const predefinedImages = [
        'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1519225421980-715cb0215aed?q=80&w=2070&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?q=80&w=2069&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1520854221256-17451cc331bf?q=80&w=2070&auto=format&fit=crop',
        'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg',
        'https://images.unsplash.com/photo-1583939003579-730e3918a45a?q=80&w=2071&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1606800052052-a08af7148866?q=80&w=2070&auto=format&fit=crop'
    ];

    function openImageLibrary(targetInputId) {
        currentImageTarget = targetInputId;
        const modal = document.getElementById('image-library-modal');
        const grid = document.getElementById('image-library-grid');
        
        // Populate predefined images
        grid.innerHTML = predefinedImages.map(url => 
            `<div class="image-library-item" onclick="selectImage('${url}')">
                <img src="${url}" alt="Image option" loading="lazy">
            </div>`
        ).join('');
        
        modal.classList.add('is-visible');
    }

    function closeImageLibrary() {
        document.getElementById('image-library-modal').classList.remove('is-visible');
        currentImageTarget = null;
    }

    function selectImage(imageUrl) {
        if (currentImageTarget) {
            const input = document.getElementById(currentImageTarget) || document.querySelector(`input[data-key="${currentImageTarget}"]`);
            if (input) {
                input.value = imageUrl;
                // Trigger change event to update the block
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        }
        closeImageLibrary();
    }

    async function uploadToImgBB(file) {
        if (!apiKeys.imgbb) {
            throw new Error('ImgBB API key not available');
        }
        
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeys.imgbb}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error?.message || 'Upload failed');
        }
        
        return result.data.url;
    }

    // Setup file upload
    document.getElementById('file-input').addEventListener('change', async (e) => {
        if (e.target.files.length === 0) return;
        
        const file = e.target.files[0];
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading image...';
            const imageUrl = await uploadToImgBB(file);
            selectImage(imageUrl);
            statusText.textContent = 'Image uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
    });

    // Setup drag and drop
    const uploadSection = document.getElementById('upload-section');
    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('dragover');
    });
    
    uploadSection.addEventListener('dragleave', () => {
        uploadSection.classList.remove('dragover');
    });
    
    uploadSection.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        
        if (e.dataTransfer.files.length === 0) return;
        
        const file = e.dataTransfer.files[0];
        if (!file.type.startsWith('image/')) return;
        
        const statusText = document.getElementById('status-text');
        
        try {
            statusText.textContent = 'Uploading image...';
            const imageUrl = await uploadToImgBB(file);
            selectImage(imageUrl);
            statusText.textContent = 'Image uploaded successfully!';
            setTimeout(() => statusText.textContent = '', 3000);
        } catch (error) {
            statusText.textContent = `Upload failed: ${error.message}`;
            setTimeout(() => statusText.textContent = '', 5000);
        }
    });

    function createStyleControlsHTML(prefix, styleObject, options = { color: true, size: true, weight: true, family: true, textAlign: false }) { 
        if (!styleObject) return ''; 
        return `<div class="style-controls"> ${options.family ? `<div class="control-group"><label>Font Family</label><select data-key="${prefix}.fontFamily">${fontOptionsHTML.replace(`value="${styleObject.fontFamily}"`, `value="${styleObject.fontFamily}" selected`)}</select></div>` : ''} <div class="style-controls-grid"> ${options.size ? `<div class="control-group"><label>Font Size</label><input type="text" data-key="${prefix}.fontSize" value="${styleObject.fontSize || ''}" placeholder="e.g. 16px or 1.2rem"></div>` : ''} ${options.color ? `<div class="control-group"><label>Color</label><input type="color" data-key="${prefix}.color" value="${styleObject.color || '#000000'}"></div>` : ''} </div> <div class="style-controls-grid" style="margin-top: 10px;"> ${options.weight ? `<div class="control-group"><label>Font Weight</label><select data-key="${prefix}.fontWeight"><option value="400" ${styleObject.fontWeight == '400' ? 'selected' : ''}>Normal</option><option value="700" ${styleObject.fontWeight == '700' ? 'selected' : ''}>Bold</option></select></div>` : ''} ${options.textAlign ? `<div class="control-group"><label>Text Align</label><select data-key="${prefix}.textAlign"><option value="left" ${styleObject.textAlign == 'left' ? 'selected' : ''}>Left</option><option value="center" ${styleObject.textAlign == 'center' ? 'selected' : ''}>Center</option><option value="right" ${styleObject.textAlign == 'right' ? 'selected' : ''}>Right</option></select></div>` : ''} </div> </div>`; 
    }
    
    function createInnerBlocksEditor(block) { 
        let innerBlocksHTML = (block.content.innerBlocks || []).map((innerBlock, index) => { 
            const textContentField = innerBlock.type === 'heading' ? `<input type="text" data-key="innerBlocks.${index}.text" value="${innerBlock.text || ''}">` : `<textarea data-key="innerBlocks.${index}.text">${innerBlock.text || ''}</textarea>`; 
            return `<div class="inner-block-editor" data-index="${index}"> <button class="delete-inner-block-btn" title="Delete this element">×</button> <label style="text-transform: capitalize;">${innerBlock.type} Text</label> ${textContentField} ${createStyleControlsHTML(`innerBlocks.${index}.style`, innerBlock.style, { textAlign: true, color: true, size: true, weight: true, family: true })} </div>`; 
        }).join(''); 
        return `<div class="inner-blocks-container"> <label style="font-weight: bold; color: #333;">Additional Elements</label> <div class="inner-blocks-list">${innerBlocksHTML}</div> <div class="add-inner-block-controls"> <button class="add-inner-block-btn" data-inner-type="heading">+ Add Heading</button> <button class="add-inner-block-btn" data-inner-type="paragraph">+ Add Paragraph</button> </div> </div>`; 
    }
    
    function getNewBlockData(type) { 
        const newBlock = { type: type, id: `block-${Date.now()}`, content: {} }; 
        switch(type) { 
            case 'hero': 
                newBlock.content = { 
                    subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, 
                    names: { text: 'John & Jane', enabled: true, style: { ...defaultTitleStyle, fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF'} }, 
                    date: { text: 'September 15, 2025', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, 
                    imageUrl: 'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop', 
                    backgroundPosition: 'center center', 
                    aspectRatio: '16/9', 
                    opacity: 1,
                    innerBlocks: [], 
                    stickers: [] 
                }; 
                break; 
            case 'text-block': 
                newBlock.content = { title: 'New Title', text: 'New paragraph text.', titleStyle: { ...defaultTitleStyle }, textStyle: { ...defaultTextStyle } }; 
                break; 
            case 'countdown': 
                newBlock.content = { title: 'New Countdown', targetDate: '', titleStyle: { ...defaultTitleStyle } }; 
                break; 
            case 'schedule': 
                newBlock.content = { title: 'New Schedule', items: [], titleStyle: { ...defaultTitleStyle } }; 
                break; 
            case 'location': 
                newBlock.content = { title: 'New Location', address: '', imageUrl: '', opacity: 1, mapLink: '#', titleStyle: { ...defaultTitleStyle } }; 
                break; 
            case 'rsvp': 
                newBlock.content = { title: 'New RSVP Block', subtitle: 'New subtitle text', titleStyle: { ...defaultTitleStyle }, buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' } }; 
                break; 
            case 'image': 
                newBlock.content = { imageUrl: 'https://via.placeholder.com/800x400', opacity: 1, caption: 'Image caption' }; 
                break; 
            case 'form-header': 
                newBlock.content = { title: 'RSVP', subtitle: 'Please fill out the form below', imageUrl: '', opacity: 1, aspectRatio: '16/9' }; 
                break; 
            case 'input-question': 
                newBlock.content = { id: `input-${Date.now()}`, title: 'Your Name', required: true }; 
                break; 
            case 'textarea-question': 
                newBlock.content = { id: `textarea-${Date.now()}`, title: 'Any comments?', required: false }; 
                break; 
            case 'radio-question': 
                newBlock.content = { id: `radio-${Date.now()}`, title: 'Will you attend?', required: true, options: [{ id: `opt-${Date.now()}`, text: 'New Option' }] }; 
                break; 
            case 'form-footer': 
                newBlock.content = { text: 'Thanks for your response!' }; 
                break; 
        } 
        return newBlock; 
    }
    
    function createStickerEditor(block) {
        const stickersHTML = (block.content.stickers || []).map((sticker, index) => {
            return `<div class="sticker-editor" data-sticker-index="${index}">
                <div class="sticker-editor-header">
                    <img src="${sticker.src}" style="width: 30px; height: 30px; border-radius: 4px; object-fit: contain; background: #ddd;">
                    <button class="delete-sticker-btn" title="Delete Sticker">Delete</button>
                </div>
                <div class="control-group"> 
                    <label>Image URL</label> 
                    <div class="image-input-group">
                        <input type="url" data-key="stickers.${index}.src" value="${sticker.src}">
                        <button type="button" class="browse-image-btn" onclick="openImageLibrary('stickers.${index}.src')">Browse...</button>
                    </div>
                </div>
                <div class="style-controls-grid">
                    <div class="control-group"><label>X</label><input type="number" data-key="stickers.${index}.x" value="${Math.round(sticker.x || 0)}"></div>
                    <div class="control-group"><label>Y</label><input type="number" data-key="stickers.${index}.y" value="${Math.round(sticker.y || 0)}"></div>
                </div>
                <div class="style-controls-grid">
                    <div class="control-group"><label>Width</label><input type="number" data-key="stickers.${index}.width" value="${Math.round(sticker.width || 100)}"></div>
                    <div class="control-group"><label>Rotation</label><input type="number" data-key="stickers.${index}.rotation" value="${Math.round(sticker.rotation || 0)}"></div>
                </div>
                <div class="opacity-control">
                    <label>Opacity</label>
                    <input type="range" class="opacity-slider" min="0" max="1" step="0.1" data-key="stickers.${index}.opacity" value="${sticker.opacity || 1}">
                    <span style="font-size: 12px; color: #666;">${Math.round((sticker.opacity || 1) * 100)}%</span>
                </div>
            </div>`;
        }).join('');
        
        return `<hr class="style-separator">
                <div class="control-group">
                    <label>Decorative Elements</label>
                    <div class="add-sticker-controls" style="display: flex; gap: 10px;">
                        <button class="add-sticker-btn" data-sticker-src="https://www.pngkey.com/png/full/15-154942_wedding-rings-png-image-background-gold-wedding-rings.png" style="flex: 1; background-color: #e9ecef;">+ Add Rings</button>
                        <button class="add-sticker-btn" data-sticker-src="https://static.vecteezy.com/system/resources/previews/009/341/365/original/heart-shape-outline-love-symbol-icon-free-png.png" style="flex: 1; background-color: #e9ecef;">+ Add Heart</button>
                    </div>
                </div>
                <div id="sticker-editors-container">${stickersHTML}</div>`;
    }

    function createImageInputHTML(dataKey, value, label) {
        return `<div class="control-group">
            <label>${label}</label>
            <div class="image-input-group">
                <input type="url" data-key="${dataKey}" value="${value || ''}" placeholder="https://images.unsplash.com/photo-...">
                <button type="button" class="browse-image-btn" onclick="openImageLibrary('${dataKey}')">Browse...</button>
            </div>
        </div>`;
    }

    function createOpacityControl(dataKey, value, label = 'Opacity') {
        const opacityValue = value !== undefined ? value : 1;
        return `<div class="opacity-control">
            <label>${label}</label>
            <input type="range" class="opacity-slider" min="0" max="1" step="0.1" data-key="${dataKey}" value="${opacityValue}">
            <span style="font-size: 12px; color: #666;">${Math.round(opacityValue * 100)}%</span>
        </div>`;
    }

    function createEditorFieldsForBlock(block) { 
        let fieldsHTML = ''; 
        const c = block.content; 
        const bgPosField = `<div class="control-group"><label>Background Focus Point</label><input type="text" data-key="backgroundPosition" value="${c.backgroundPosition || 'center center'}" placeholder="e.g., center 30%"></div>`; 
        const aspectRatioField = `<div class="control-group"><label>Block Shape (Height)</label><select data-key="aspectRatio"> <option value="21/9" ${c.aspectRatio === '21/9' ? 'selected' : ''}>Cinematic</option> <option value="16/9" ${c.aspectRatio === '16/9' ? 'selected' : ''}>Widescreen</option> <option value="8/5" ${c.aspectRatio === '8/5' ? 'selected' : ''}>Landscape (Wide)</option> <option value="3/2"  ${c.aspectRatio === '3/2' ? 'selected' : ''}>Landscape (Classic)</option> <option value="4/3"  ${c.aspectRatio === '4/3' ? 'selected' : ''}>Standard (4:3)</option> <option value="1/1"  ${c.aspectRatio === '1/1' ? 'selected' : ''}>Square</option> <option value="9/12" ${c.aspectRatio === '9/12' ? 'selected' : ''}>Portrait (Standard)</option> <option value="9/16" ${c.aspectRatio === '9/16' ? 'selected' : ''}>Portrait (Tall)</option> </select></div>`; 
        const titleStyleField = (styleObj) => `<label>Title Style</label>${createStyleControlsHTML('titleStyle', styleObj, { textAlign: true, color: true, size: true, weight: true, family: true })}`; 
        const sectionTitleField = (title) => `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${title}"></div>`; 
        const createOptionalElementEditor = (key, label) => { 
            const element = c[key]; 
            if (!element) return ''; 
            return `<div class="control-group"> <div class="optional-element-header"> <label>${label}</label> <label><input type="checkbox" data-key="${key}.enabled" ${element.enabled ? 'checked' : ''}> Show</label> </div> <input type="text" data-key="${key}.text" value="${element.text}"> ${createStyleControlsHTML(`${key}.style`, element.style)} </div>`; 
        };
        
        switch(block.type) { 
            case 'hero': 
                fieldsHTML = `${createImageInputHTML('imageUrl', c.imageUrl, 'Background Image URL')}
                    ${createOpacityControl('opacity', c.opacity, 'Background Opacity')}
                    ${createOptionalElementEditor('names', 'Names')} 
                    <hr class="style-separator"> 
                    ${createOptionalElementEditor('subtitle', 'Subtitle')} 
                    <hr class="style-separator"> 
                    ${createOptionalElementEditor('date', 'Date')} 
                    <hr class="style-separator"> 
                    ${aspectRatioField}${bgPosField} 
                    ${createStickerEditor(block)}`; 
                break; 

            case 'text-block': 
                fieldsHTML = `<div class="control-group"><label>Title (optional)</label><input type="text" data-key="title" value="${c.title || ''}"></div>${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${c.text || ''}</textarea></div>${createStyleControlsHTML('textStyle', c.textStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}${createStickerEditor(block)}`; 
                break; 

            case 'rsvp': 
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle || ''}</textarea></div><hr class="style-separator"><label>Button Style</label><div class="style-controls"><div class="style-controls-grid"><div class="control-group"><label>Background Color</label><input type="color" data-key="buttonStyle.backgroundColor" value="${c.buttonStyle.backgroundColor || '#c5a98b'}"></div><div class="control-group"><label>Text Color</label><input type="color" data-key="buttonStyle.color" value="${c.buttonStyle.color || '#FFFFFF'}"></div></div><div style="margin-top: 10px;">${createStyleControlsHTML('buttonStyle', c.buttonStyle, {color: false, size: true, weight: true, family: true})}</div></div>${createStickerEditor(block)}`; 
                break; 
            
            case 'countdown': 
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${c.targetDate || ''}"></div>${createStickerEditor(block)}`;
                break;

            case 'schedule':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}`;
                let items = (c.items || []).map((item, index) => 
                    `<div class="sub-item-editor" data-item-index="${index}">
                        <button type="button" class="delete-sub-item-btn">×</button>
                        <input type="text" placeholder="Time" class="sub-item-input" data-key="items.${index}.time" value="${item.time || ''}">
                        <input type="text" placeholder="Title" class="sub-item-input" data-key="items.${index}.title" value="${item.title || ''}">
                        <textarea class="sub-item-input" data-key="items.${index}.desc" placeholder="Description">${item.desc || ''}</textarea>
                    </div>`
                ).join(''); 
                fieldsHTML += `<hr class="style-separator"><div class="control-group"><label>Items</label>${items}</div><button type="button" class="add-sub-item-btn" style="font-size: 12px; padding: 5px; margin-top: 10px;">+ Add Item</button>`;
                fieldsHTML += createStickerEditor(block);
                break;

            case 'location': 
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Address</label><textarea data-key="address">${c.address || ''}</textarea></div>${createImageInputHTML('imageUrl', c.imageUrl, 'Photo URL')}${createOpacityControl('opacity', c.opacity, 'Photo Opacity')}<div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${c.mapLink || ''}"></div>${createStickerEditor(block)}`; 
                break; 

            case 'image':
                fieldsHTML = `${createImageInputHTML('imageUrl', c.imageUrl, 'Image URL')}
                    ${createOpacityControl('opacity', c.opacity, 'Image Opacity')}
                    <div class="control-group"><label>Caption (optional)</label><input type="text" data-key="caption" value="${c.caption || ''}"></div>
                    ${createStickerEditor(block)}`;
                break;
            
            case 'form-header':
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle || ''}</textarea></div>${createImageInputHTML('imageUrl', c.imageUrl, 'Background Image URL')}${createOpacityControl('opacity', c.opacity, 'Background Opacity')}${aspectRatioField}${createStickerEditor(block)}`;
                break;
            
            default: 
                fieldsHTML = 'No editor available for this block type.'; 
        }
    
    function renderEditor() { 
        const container = document.getElementById('editor-content'); 
        const currentlyOpen = [...container.querySelectorAll('.editor-block-content.is-open')].map(el => el.closest('.editor-block').dataset.id); 
        container.innerHTML = ''; 
        pageBlocks.forEach(block => { 
            const tpl = document.getElementById('editor-block-template').content.cloneNode(true); 
            const editorBlock = tpl.querySelector('.editor-block'); 
            editorBlock.dataset.id = block.id; 
            const title = block.type.charAt(0).toUpperCase() + block.type.slice(1).replace(/-/g, ' '); 
            editorBlock.querySelector('.editor-block-title').textContent = title; 
            const contentDiv = editorBlock.querySelector('.editor-block-content'); 
            contentDiv.innerHTML = createEditorFieldsForBlock(block); 
            if (currentlyOpen.includes(block.id)) { 
                contentDiv.classList.add('is-open'); 
                editorBlock.querySelector('.toggle-btn').textContent = '▲'; 
            } 
            container.appendChild(tpl); 
        }); 
        initializeMapsForEditor(); 
    }
    
    async function handleMapLinkBlur(url, blockIndex) { 
        const trimmedUrl = url.trim(); 
        if (!trimmedUrl.startsWith('http') || !trimmedUrl.includes('goo.gl')) return; 
        const statusText = document.getElementById('status-text'); 
        try { 
            statusText.innerText = 'Analyzing shortened link...'; 
            const response = await fetch(`/.netlify/functions/unshorten-url?url=${encodeURIComponent(trimmedUrl)}`); 
            const data = await response.json(); 
            if (!response.ok || data.error) throw new Error(data.error || 'Could not get data from link.'); 
            statusText.innerText = 'Searching for place details...'; 
            const service = new google.maps.places.PlacesService(document.createElement('div')); 
            const place = await new Promise((resolve, reject) => { 
                service.textSearch({ query: data.placeName, fields: ['name', 'formatted_address', 'photos', 'url'] }, (results, status) => { 
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) { 
                        resolve(results[0]); 
                    } else { 
                        reject(new Error('Place details not found.')); 
                    } 
                }); 
            }); 
            const block = pageBlocks[blockIndex]; 
            block.content.title = place.name || ''; 
            block.content.address = place.formatted_address || ''; 
            block.content.mapLink = place.url || trimmedUrl; 
            if (place.photos && place.photos.length > 0) { 
                block.content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); 
            } 
            statusText.innerText = 'Location data updated!'; 
            renderEditor(); 
            renderPreview(); 
        } catch (error) { 
            console.error('Error fetching place data from URL:', error); 
            statusText.innerText = `Error: ${error.message}`; 
        } finally { 
            setTimeout(() => { statusText.innerText = ''; }, 4000); 
        } 
    }
    
    function initializeMapsForEditor() { 
        if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') { 
            return; 
        } 
        document.querySelectorAll('.smart-location-search').forEach(input => { 
            if (input.dataset.mapsInitialized) return; 
            input.dataset.mapsInitialized = 'true'; 
            const autocomplete = new google.maps.places.Autocomplete(input, { 
                fields: ["name", "formatted_address", "photos", "url"], 
                types: ["establishment"] 
            }); 
            autocomplete.addListener('place_changed', () => { 
                const place = autocomplete.getPlace(); 
                if (!place) return; 
                const blockDiv = input.closest('.editor-block'); 
                const blockId = blockDiv.dataset.id; 
                const blockIndex = pageBlocks.findIndex(b => b.id === blockId); 
                if (blockIndex === -1) return; 
                const content = pageBlocks[blockIndex].content; 
                content.title = place.name || ''; 
                content.address = place.formatted_address || ''; 
                content.mapLink = place.url || ''; 
                if (place.photos && place.photos.length > 0) { 
                    content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); 
                } 
                renderEditor(); 
                renderPreview(); 
            }); 
        }); 
    }
    
    function setupEventListeners() { 
        const editorContent = document.getElementById('editor-content'); 
        const handleEditorChange = (e) => { 
            const input = e.target; 
            const blockDiv = input.closest('.editor-block'); 
            if (!blockDiv) return; 
            const blockId = blockDiv.dataset.id; 
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId); 
            if (blockIndex === -1) return; 
            const key = input.dataset.key; 
            if (input.matches('.sub-item-input')) { 
                const subItemDiv = input.closest('.sub-item-editor'); 
                const subItemId = subItemDiv.dataset.itemId; 
                const subItemKey = input.dataset.itemKey; 
                const listKey = pageBlocks[blockIndex].content.items ? 'items' : 'options'; 
                const subItemIndex = pageBlocks[blockIndex].content[listKey].findIndex(i => i.id === subItemId); 
                if (subItemIndex > -1) pageBlocks[blockIndex].content[listKey][subItemIndex][subItemKey] = input.value; 
            } else if (key) { 
                let value = input.type === 'checkbox' ? input.checked : input.value; 
                if (input.type === 'number') value = parseFloat(value) || 0; 
                if (input.type === 'range') value = parseFloat(value);
                const keys = key.split('.'); 
                let current = pageBlocks[blockIndex].content; 
                for (let i = 0; i < keys.length - 1; i++) { 
                    current = current[keys[i]] = current[keys[i]] || {}; 
                } 
                current[keys[keys.length - 1]] = value; 
                
                // Update opacity display
                if (input.type === 'range' && input.classList.contains('opacity-slider')) {
                    const span = input.nextElementSibling;
                    if (span) span.textContent = `${Math.round(value * 100)}%`;
                }
            } 
            renderPreview(); 
        }; 
        editorContent.addEventListener('input', handleEditorChange); 
        editorContent.addEventListener('change', handleEditorChange); 
        editorContent.addEventListener('blur', (e) => { 
            const input = e.target; 
            const blockDiv = input.closest('.editor-block'); 
            if (blockDiv && pageBlocks[pageBlocks.findIndex(b => b.id === blockDiv.dataset.id)]?.type === 'location' && input.dataset.key === 'mapLink') { 
                const blockIndex = pageBlocks.findIndex(b => b.id === blockDiv.dataset.id); 
                handleMapLinkBlur(input.value, blockIndex); 
            } 
        }, true);
        
        editorContent.addEventListener('click', e => {
            const target = e.target;
            const blockDiv = target.closest('.editor-block');
            if (!blockDiv) return;
            const blockId = blockDiv.dataset.id;
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
            if (blockIndex === -1) return;

            if (target.matches('.browse-image-btn')) {
                openImageLibrary({ blockId, key: target.dataset.targetKey, isSticker: false });
            } else if (target.matches('.add-sticker-btn')) {
                openImageLibrary({ blockId, key: null, isSticker: true });
            } else if (target.matches('.delete-sticker-btn')) {
                const stickerIndex = parseInt(target.closest('.sticker-editor').dataset.stickerIndex, 10);
                pageBlocks[blockIndex].content.stickers.splice(stickerIndex, 1);
                renderEditor();
                renderPreview();
            } else if (target.matches('.add-sub-item-btn')) { // Кнопка "+ Add Item" для Расписания
                if (!pageBlocks[blockIndex].content.items) {
                    pageBlocks[blockIndex].content.items = [];
                }
                pageBlocks[blockIndex].content.items.push({ id: `item-${Date.now()}`, time: '', title: '', desc: '' });
                renderEditor();
                renderPreview();
            } else if (target.matches('.delete-sub-item-btn')) { // Кнопка "x" для пункта Расписания
                const itemIndex = parseInt(target.closest('.sub-item-editor').dataset.itemIndex, 10);
                if (!isNaN(itemIndex)) {
                    pageBlocks[blockIndex].content.items.splice(itemIndex, 1);
                    renderEditor();
                    renderPreview();
                }
            } else if (target.closest('.delete-block-btn')) {
                if (confirm('Are you sure?')) {
                    pageBlocks.splice(blockIndex, 1);
                    renderEditor();
                    renderPreview();
                }
            } else if (target.closest('.editor-block-header')) {
                const content = blockDiv.querySelector('.editor-block-content');
                if (content) {
                    content.classList.toggle('is-open');
                    blockDiv.querySelector('.toggle-btn').textContent = content.classList.contains('is-open') ? '▲' : '▼';
                }
            }
        });
    
    const addBlockModal = document.getElementById('add-block-modal'); 
    document.getElementById('add-block-btn').addEventListener('click', () => addBlockModal.classList.add('is-visible')); 
    document.getElementById('modal-close-btn').addEventListener('click', () => addBlockModal.classList.remove('is-visible')); 
    addBlockModal.addEventListener('click', (e) => { 
        if (e.target === addBlockModal) addBlockModal.classList.remove('is-visible'); 
    }); 
    document.getElementById('add-block-options').addEventListener('click', (e) => { 
        if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { 
            const newBlock = getNewBlockData(e.target.dataset.type); 
            pageBlocks.push(newBlock); 
            renderEditor(); 
            renderPreview(); 
            addBlockModal.classList.remove('is-visible'); 
        } 
    });
    
    let resizeObserver; 
    function setupResizeObserver() { 
        if (resizeObserver) resizeObserver.disconnect(); 
        const previewBody = iframe.contentWindow.document.body; 
        if (!previewBody) return; 
        resizeObserver = new ResizeObserver(() => { 
            iframe.style.height = previewBody.scrollHeight + 'px'; 
        }); 
        resizeObserver.observe(previewBody); 
        iframe.style.height = previewBody.scrollHeight + 'px'; 
    }
    
    function renderPreview() { 
        if (iframe.contentWindow && typeof iframe.contentWindow.renderPage === 'function') { 
            iframe.contentWindow.renderPage(pageBlocks, pageSettings); 
        } 
    }
    
    function initSortable() { 
        const c = document.getElementById('editor-content'); 
        Sortable.create(c, { 
            handle: '.drag-handle', 
            animation: 150, 
            onEnd: (evt) => { 
                const mi = pageBlocks.splice(evt.oldIndex, 1)[0]; 
                pageBlocks.splice(evt.newIndex, 0, mi); 
                renderPreview(); 
            }
        }); 
    }
    
    document.getElementById('share-button').addEventListener('click', async function() { 
        const statusText = document.getElementById('status-text'); 
        this.disabled = true; 
        statusText.innerText = 'Saving...'; 
        saveCurrentPageData(); 
        const dataToSave = { main: mainPageData, rsvp: rsvpFormData }; 
        try { 
            const response = await fetch('/.netlify/functions/create-bundle', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(dataToSave) 
            }); 
            const result = await response.json(); 
            if (!response.ok) throw new Error(result.error || `Server Error (${response.status})`); 
            const mainLink = result.link; 
            await navigator.clipboard.writeText(mainLink); 
            statusText.innerText = 'Invitation link copied!'; 
            alert(`Invitation Link (copied to clipboard):\n${mainLink}`); 
        } catch (err) { 
            statusText.innerText = `Error: ${err.message}`; 
        } finally { 
            this.disabled = false; 
            setTimeout(() => { statusText.innerText = ''; }, 5000); 
        } 
    });
    
    const editMainBtn = document.getElementById('edit-main-btn'), 
          editRsvpBtn = document.getElementById('edit-rsvp-btn'), 
          globalWidthInput = document.getElementById('global-width-input'), 
          globalStyleSelect = document.getElementById('global-style-select'), 
          globalBgImageGroup = document.getElementById('global-bg-image-group'), 
          globalBgImageInput = document.getElementById('global-bg-image-input'); 
    
    function toggleBgImageField() { 
        globalBgImageGroup.style.display = (pageSettings.style === 'modern') ? 'block' : 'none'; 
    } 
    
    globalStyleSelect.addEventListener('change', () => { 
        pageSettings.style = globalStyleSelect.value; 
        toggleBgImageField(); 
        renderPreview(); 
    }); 
    
    globalBgImageInput.addEventListener('input', () => { 
        pageSettings.backgroundImage = globalBgImageInput.value; 
        renderPreview(); 
    }); 
    
    globalWidthInput.addEventListener('input', () => { 
        pageSettings.maxWidth = globalWidthInput.value; 
        renderPreview(); 
    }); 
    
    function saveCurrentPageData() { 
        const data = { 
            settings: JSON.parse(JSON.stringify(pageSettings)), 
            blocks: JSON.parse(JSON.stringify(pageBlocks)) 
        }; 
        if (currentTemplate === mainPageData.template) { 
            mainPageData = {...mainPageData, ...data}; 
        } else { 
            rsvpFormData = {...rsvpFormData, ...data}; 
        } 
    }
    
    function switchEditorMode(target) { 
        currentTemplate = target.template; 
        pageSettings = JSON.parse(JSON.stringify(target.settings)); 
        pageBlocks = JSON.parse(JSON.stringify(target.blocks)); 
        globalWidthInput.value = pageSettings.maxWidth; 
        globalStyleSelect.value = pageSettings.style; 
        globalBgImageInput.value = pageSettings.backgroundImage; 
        toggleBgImageField(); 
        iframe.src = `templates/${currentTemplate}?v=${Date.now()}`; 
        editMainBtn.classList.toggle('active', currentTemplate === mainPageData.template); 
        editRsvpBtn.classList.toggle('active', currentTemplate === rsvpFormData.template); 
    }
    
    editMainBtn.addEventListener('click', () => { 
        if (currentTemplate !== mainPageData.template) { 
            saveCurrentPageData(); 
            switchEditorMode(mainPageData); 
        } 
    }); 
    
    editRsvpBtn.addEventListener('click', () => { 
        if (currentTemplate !== rsvpFormData.template) { 
            saveCurrentPageData(); 
            switchEditorMode(rsvpFormData); 
        } 
    });
    
    async function initEditor() {
        // Fetch API keys from server function
        try {
            const response = await fetch('/.netlify/functions/get-api-keys');
            if (response.ok) {
                apiKeys = await response.json();
            } else {
                console.warn('Could not fetch API keys from server');
            }
        } catch (error) {
            console.warn('Error fetching API keys:', error);
        }

        window.addEventListener('message', (event) => {
            if (event.source !== iframe.contentWindow) return; // Security check
            const { type, payload } = event.data;
            if (type === 'UPDATE_STICKER') {
                const { blockId, stickerId, newProps } = payload;
                const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
                if (blockIndex === -1) return;
                const stickerIndex = pageBlocks[blockIndex].content.stickers.findIndex(s => s.id === stickerId);
                if (stickerIndex === -1) return;
                
                Object.assign(pageBlocks[blockIndex].content.stickers[stickerIndex], newProps);
                renderEditor(); // Update the editor inputs with new values
            }
        });

        const params = new URLSearchParams(window.location.search), 
              id = params.get('id'), 
              isCustomerMode = !!id;
        
        const initialize = () => { 
            if (isCustomerMode) document.querySelector('.global-settings')?.remove(); 
            initSortable(); 
            setupEventListeners(); 
            iframe.onload = () => { 
                renderEditor(); 
                renderPreview(); 
                setupResizeObserver(); 
            }; 
            switchEditorMode(mainPageData); 
        };
        
        if (isCustomerMode) { 
            const status = document.getElementById('status-text'); 
            status.innerText = 'Loading...'; 
            fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, { 
                headers: { 'X-Access-Key': '$2a$10$c.QWLI8NIw84W3uqmH/mUez32F1LK7KPBirRW7hr1nE0mJ9CAATC6' } 
            }).then(r => r.ok ? r.json() : Promise.reject(new Error('Could not load template.')))
            .then(d => { 
                mainPageData = d.record.main; 
                rsvpFormData = d.record.rsvp; 
                status.innerText = ''; 
                initialize(); 
            }).catch(e => document.body.innerHTML = `<h1>Error</h1><p>${e.message}</p>`); 
        } else { 
            initialize(); 
        }
    }
    
    function mapsReady() { 
        initializeMapsForEditor(); 
    }
    
    initEditor();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRylKwrQtZHNk3PvtpPqRbLpPwKQNF26k&libraries=places&callback=mapsReady"></script>
</body>
</html>
