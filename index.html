<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <!-- ... (весь <head> остается таким же) ... -->
    <style> /* ... (все стили остаются такими же) ... */ </style>
</head>
<body>
    <!-- ... (вся HTML структура остается такой же) ... -->
    <script>
    const LOCK_STYLE_CHOICE = false;
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; let pageSettings = {}; let currentTemplate = ''; let previewResizeObserver;
    
    // ИЗМЕНЕНИЕ 1: Убираем 'height', оно больше не нужно.
    let mainPageData = { template: 'wedding-classic.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ { type: 'hero', id: `block-${Date.now()}-1`, content: { subtitle: 'WE ARE GETTING MARRIED', names: 'John & Jane', date: 'September 15, 2025', imageUrl: 'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg', backgroundPosition: 'center 30%' }}, { type: 'countdown', id: `block-${Date.now()}-2`, content: { title: 'Until Our Big Day', targetDate: '2025-09-15T16:00' }}, /* ... (остальные блоки без изменений) ... */ ] };
    let rsvpFormData = { /* ... (без изменений) ... */ };
    
    // ИЗМЕНЕНИЕ 2: Убираем 'height' из данных для новых блоков
    function getNewBlockData(type) { const newBlock = { type: type, id: `block-${Date.now()}`, content: {} }; switch(type) { case 'hero': newBlock.content = { subtitle: 'New Subtitle', names: 'New Names', date: 'New Date', imageUrl: '', backgroundPosition: 'center center' }; break; /* ... (остальные case без изменений) ... */ } return newBlock; }
    
    // ИЗМЕНЕНИЕ 3: Убираем поле "Block Height" из HTML редактора
    function createEditorFieldsForBlock(block) {
        let fieldsHTML = '';
        // УДАЛЯЕМ heightField
        const bgPosField = `<div class="control-group"><label>Background Position</label><input type="text" data-key="backgroundPosition" value="${block.content.backgroundPosition || 'center center'}" placeholder="e.g., center center, center 30%"></div>`;
        switch(block.type) {
            case 'hero':
                fieldsHTML = `<div class="control-group"><label>Subtitle</label><input type="text" data-key="subtitle" value="${block.content.subtitle}"></div><div class="control-group"><label>Names</label><input type="text" data-key="names" value="${block.content.names}"></div><div class="control-group"><label>Date (text)</label><input type="text" data-key="date" value="${block.content.date}"></div><div class="control-group"><label>Background Image URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl}"></div>${bgPosField}`; // heightField убран
                break;
            // ... (остальные case без изменений, но если где-то был heightField, он тоже удаляется) ...
            case 'image':
                 fieldsHTML = `<div class="control-group"><label>Image URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl}"></div><div class="control-group"><label>Caption</label><input type="text" data-key="caption" value="${block.content.caption}"></div>`; // heightField убран
                 break;
            case 'paragraph':
                 fieldsHTML = `<div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${block.content.text}</textarea></div>`; // heightField убран
                 break;
            case 'form-header':
                 fieldsHTML = `<div class="control-group"><label>Image URL (optional)</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl || ''}"></div><div class="control-group"><label>Title</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${block.content.subtitle}</textarea></div>`; // heightField убран
                 break;
             // ... (продолжение switch без изменений) ...
             case 'countdown': fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${block.content.targetDate}"></div>`; break; case 'schedule': let scheduleItems = block.content.items.map(item => `<div class="sub-item-editor schedule-item-editor" data-item-id="${item.id}"><input type="text" placeholder="Time" class="sub-item-input" data-item-key="time" value="${item.time}"><input type="text" placeholder="Title" class="sub-item-input" data-item-key="title" value="${item.title}"><button class="delete-sub-item-btn">×</button><textarea class="sub-item-input" data-item-key="desc" placeholder="Description">${item.desc}</textarea></div>`).join(''); fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label>Items</label>${scheduleItems}</div><button class="add-sub-item-btn action-button" data-list-key="items" style="font-size: 12px; padding: 5px; margin-top: 10px;">+ Add Item</button>`; break; case 'location': fieldsHTML = `<div class="control-group"><label>Smart Location Search</label><input type="text" class="smart-location-search" placeholder="e.g., Per Se, New York"></div><hr style="border:none; border-top: 1px solid #eee; margin: 20px 0;"><div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label>Address</label><textarea data-key="address">${block.content.address}</textarea></div><div class="control-group"><label>Photo URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl}"></div><div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${block.content.mapLink}"></div>`; break; case 'rsvp': fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${block.content.subtitle}</textarea></div><div class="control-group"><label>"I'll Attend" Link (auto-generated)</label><input type="url" data-key="acceptLink" value="${block.content.acceptLink}" disabled></div><div class="control-group"><label>"Can't Attend" Link (optional)</label><input type="url" data-key="declineLink" value="${block.content.declineLink}"></div>`; break; case 'heading': fieldsHTML = `<div class="control-group"><label>Heading Text</label><input type="text" data-key="text" value="${block.content.text}"></div>`; break; case 'input-question': case 'textarea-question': fieldsHTML = `<div class="control-group"><label>Question Text</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label><input type="checkbox" data-key="required" ${block.content.required ? 'checked' : ''}> Required Question</label></div>`; break; case 'radio-question': let radioOptions = block.content.options.map(opt => `<div class="sub-item-editor" data-item-id="${opt.id}"><input type="text" class="sub-item-input" data-item-key="text" value="${opt.text}" placeholder="Option text"><button class="delete-sub-item-btn">×</button></div>`).join(''); fieldsHTML = `<div class="control-group"><label>Question Text</label><input type="text" data-key="title" value="${block.content.title}"></div><div class="control-group"><label><input type="checkbox" data-key="required" ${block.content.required ? 'checked' : ''}> Required Question</label></div><div class="control-group"><label>Options</label>${radioOptions}</div><button class="add-sub-item-btn action-button" data-list-key="options" style="font-size: 12px; padding: 5px; margin-top: 10px;">+ Add Option</button>`; break; case 'form-footer': fieldsHTML = `<div class="control-group"><label>Footer Text</label><input type="text" data-key="text" value="${block.content.text}"></div>`; break; default: fieldsHTML = 'No editor available for this block type.';
        }
        return fieldsHTML;
    }

    // ... (весь остальной JS код в этом файле остается без изменений) ...
    function renderEditor() { const container = document.getElementById('editor-content'); const currentlyOpen = [...container.querySelectorAll('.editor-block-content.is-open')].map(el => el.closest('.editor-block').dataset.id); container.innerHTML = ''; pageBlocks.forEach(block => { const tpl = document.getElementById('editor-block-template').content.cloneNode(true); const editorBlock = tpl.querySelector('.editor-block'); editorBlock.dataset.id = block.id; const title = block.type.charAt(0).toUpperCase() + block.type.slice(1).replace(/-/g, ' '); editorBlock.querySelector('.editor-block-title').textContent = title; const contentDiv = editorBlock.querySelector('.editor-block-content'); contentDiv.innerHTML = createEditorFieldsForBlock(block); if (currentlyOpen.includes(block.id)) { contentDiv.classList.add('is-open'); editorBlock.querySelector('.toggle-btn').textContent = '▲'; } container.appendChild(tpl); }); initializeMapsForEditor(); }
    function initializeMapsForEditor() { if (typeof google === 'undefined' || typeof google.maps === 'undefined') { console.warn("Google Maps script not loaded yet. Deferring init."); return; } document.querySelectorAll('.smart-location-search').forEach(input => { if (input.dataset.mapsInitialized) return; input.dataset.mapsInitialized = 'true'; const autocomplete = new google.maps.places.Autocomplete(input, { fields: ["name", "formatted_address", "photos", "url"], types: ["establishment"] }); autocomplete.addListener('place_changed', () => { const place = autocomplete.getPlace(); if (!place) return; const blockDiv = input.closest('.editor-block'); const blockId = blockDiv.dataset.id; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; const block = pageBlocks[blockIndex]; block.content.title = place.name || block.content.title; block.content.address = place.formatted_address || block.content.address; block.content.mapLink = place.url || block.content.mapLink; if (place.photos && place.photos.length > 0) { block.content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); } renderEditor(); renderPreview(); }); }); }
    function setupEventListeners() { const editorContent = document.getElementById('editor-content'); editorContent.addEventListener('input', (e) => { const input = e.target; const blockDiv = input.closest('.editor-block'); if (!blockDiv) return; const blockId = blockDiv.dataset.id; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; if (input.matches('[data-key]')) { const key = input.dataset.key; const value = input.type === 'checkbox' ? input.checked : input.value; pageBlocks[blockIndex].content[key] = value; } else if (input.matches('.sub-item-input')) { const subItemDiv = input.closest('.sub-item-editor'); const subItemId = subItemDiv.dataset.itemId; const subItemKey = input.dataset.itemKey; const listKey = pageBlocks[blockIndex].content.items ? 'items' : 'options'; const subItemIndex = pageBlocks[blockIndex].content[listKey].findIndex(i => i.id === subItemId); if (subItemIndex > -1) pageBlocks[blockIndex].content[listKey][subItemIndex][subItemKey] = input.value; } renderPreview(); }); editorContent.addEventListener('change', async (e) => { if (e.target.matches('input[data-key="mapLink"]')) { const input = e.target; const url = input.value.trim(); if (!url) return; const statusText = document.getElementById('status-text'); const blockDiv = input.closest('.editor-block'); const blockId = blockDiv.dataset.id; statusText.innerText = 'Analyzing map link...'; try { const unshortenResponse = await fetch(`/.netlify/functions/unshorten-url?url=${encodeURIComponent(url)}`); const unshortenData = await unshortenResponse.json(); if (!unshortenResponse.ok || !unshortenData.placeName) { throw new Error(unshortenData.error || 'Could not extract place name from URL.'); } const placeName = unshortenData.placeName; const service = new google.maps.places.PlacesService(document.createElement('div')); service.textSearch({ query: placeName, fields: ['name', 'formatted_address', 'photos', 'url'] }, (results, status) => { if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) { const place = results[0]; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; const block = pageBlocks[blockIndex]; block.content.title = place.name || ''; block.content.address = place.formatted_address || ''; block.content.mapLink = place.url || url; if (place.photos && place.photos.length > 0) { block.content.imageUrl = place.photos[0].getUrl({ 'maxWidth': 1600 }); } statusText.innerText = 'Location data populated!'; renderEditor(); renderPreview(); } else { statusText.innerText = 'Error: Place not found.'; } }); } catch (error) { console.error('Error processing map link:', error); statusText.innerText = `Error: ${error.message}`; } finally { setTimeout(() => { if(statusText.innerText !== '') statusText.innerText = ''; }, 4000); } } }, true); editorContent.addEventListener('click', (e) => { const target = e.target; const blockDiv = target.closest('.editor-block'); if (!blockDiv) return; const blockId = blockDiv.dataset.id; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (target.closest('.delete-block-btn')) { if (confirm('Are you sure you want to delete this block?')) { pageBlocks.splice(blockIndex, 1); renderEditor(); renderPreview(); } } else if (target.closest('.add-sub-item-btn')) { const listKey = target.dataset.listKey; const newItem = listKey === 'items' ? { id: `s-${Date.now()}`, time: 'New Time', title: 'New Event', desc: '' } : { id: `opt-${Date.now()}`, text: 'New Option' }; pageBlocks[blockIndex].content[listKey].push(newItem); renderEditor(); renderPreview(); } else if (target.closest('.delete-sub-item-btn')) { const subItemDiv = target.closest('.sub-item-editor'); const subItemId = subItemDiv.dataset.itemId; const listKey = pageBlocks[blockIndex].content.items ? 'items' : 'options'; pageBlocks[blockIndex].content[listKey] = pageBlocks[blockIndex].content[listKey].filter(i => i.id !== subItemId); renderEditor(); renderPreview(); } else if (target.closest('.editor-block-header')) { const content = blockDiv.querySelector('.editor-block-content'); if (content) { content.classList.toggle('is-open'); blockDiv.querySelector('.toggle-btn').textContent = content.classList.contains('is-open') ? '▲' : '▼'; } } }); }
    const addBlockModal = document.getElementById('add-block-modal'); document.getElementById('add-block-btn').addEventListener('click', () => addBlockModal.classList.add('is-visible')); document.getElementById('modal-close-btn').addEventListener('click', () => addBlockModal.classList.remove('is-visible')); addBlockModal.addEventListener('click', (e) => { if (e.target === addBlockModal) { addBlockModal.classList.remove('is-visible'); } }); document.getElementById('add-block-options').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { pageBlocks.push(getNewBlockData(e.target.dataset.type)); renderEditor(); renderPreview(); addBlockModal.classList.remove('is-visible'); } });
    function setupResizeObserver() { if (previewResizeObserver) { previewResizeObserver.disconnect(); } const previewBody = iframe.contentWindow.document.body; if (!previewBody) return; previewResizeObserver = new ResizeObserver(() => { iframe.style.height = previewBody.scrollHeight + 'px'; }); previewResizeObserver.observe(previewBody); iframe.style.height = previewBody.scrollHeight + 'px'; }
    function renderPreview() { if (iframe.contentWindow && typeof iframe.contentWindow.renderPage === 'function') { iframe.contentWindow.renderPage(pageBlocks, pageSettings); } }
    function initSortable() { const c = document.getElementById('editor-content'); Sortable.create(c, { handle: '.drag-handle', animation: 150, onEnd: (evt) => { const mi = pageBlocks.splice(evt.oldIndex, 1)[0]; pageBlocks.splice(evt.newIndex, 0, mi); renderPreview(); }}); }
    document.getElementById('share-button').addEventListener('click', async function() { const statusText = document.getElementById('status-text'); this.disabled = true; statusText.innerText = 'Saving...'; saveCurrentPageData(); const dataToSave = { main: mainPageData, rsvp: rsvpFormData }; try { const response = await fetch('/.netlify/functions/create-bundle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSave) }); const result = await response.json(); if (!response.ok) { throw new Error(result.error || `Server Error (${response.status})`); } const mainLink = result.link; await navigator.clipboard.writeText(mainLink); statusText.innerText = 'Invitation link copied!'; alert(`Invitation Link (copied to clipboard):\n${mainLink}\n\nUse this link to share the invitation. The RSVP button inside will automatically link to the form.`); } catch (err) { statusText.innerText = `Error: ${err.message}`; console.error(err); } finally { this.disabled = false; setTimeout(() => { if (statusText.innerText !== '') statusText.innerText = ''; }, 5000); } });
    const editMainBtn = document.getElementById('edit-main-btn'); const editRsvpBtn = document.getElementById('edit-rsvp-btn'); const globalWidthInput = document.getElementById('global-width-input'); const globalStyleSelect = document.getElementById('global-style-select'); const globalBgImageGroup = document.getElementById('global-bg-image-group'); const globalBgImageInput = document.getElementById('global-bg-image-input');
    function toggleBgImageField() { globalBgImageGroup.style.display = (pageSettings.style === 'modern') ? 'block' : 'none'; }
    globalStyleSelect.addEventListener('change', () => { pageSettings.style = globalStyleSelect.value; toggleBgImageField(); renderPreview(); });
    globalBgImageInput.addEventListener('input', () => { pageSettings.backgroundImage = globalBgImageInput.value; renderPreview(); });
    globalWidthInput.addEventListener('input', () => { pageSettings.maxWidth = globalWidthInput.value; renderPreview(); });
    function saveCurrentPageData() { const dataToSave = { settings: JSON.parse(JSON.stringify(pageSettings)), blocks: JSON.parse(JSON.stringify(pageBlocks)) }; if (currentTemplate === mainPageData.template) { mainPageData.settings = dataToSave.settings; mainPageData.blocks = dataToSave.blocks; } else if (currentTemplate === rsvpFormData.template) { rsvpFormData.settings = dataToSave.settings; rsvpFormData.blocks = dataToSave.blocks; } }
    function switchEditorMode(targetTemplateData) { currentTemplate = targetTemplateData.template; pageSettings = JSON.parse(JSON.stringify(targetTemplateData.settings)); pageBlocks = JSON.parse(JSON.stringify(targetTemplateData.blocks)); globalWidthInput.value = pageSettings.maxWidth; globalStyleSelect.value = pageSettings.style; globalBgImageInput.value = pageSettings.backgroundImage; toggleBgImageField(); iframe.src = `templates/${currentTemplate}?v=${Date.now()}`; editMainBtn.classList.toggle('active', currentTemplate === mainPageData.template); editRsvpBtn.classList.toggle('active', currentTemplate === rsvpFormData.template); }
    editMainBtn.addEventListener('click', () => { if (currentTemplate !== mainPageData.template) { saveCurrentPageData(); switchEditorMode(mainPageData); } });
    editRsvpBtn.addEventListener('click', () => { if (currentTemplate !== rsvpFormData.template) { saveCurrentPageData(); switchEditorMode(rsvpFormData); } });
    async function initApp() { const params = new URLSearchParams(window.location.search); const binIdToLoad = params.get('id'); let isCustomerMode = !!binIdToLoad; const initializeEditor = () => { if (isCustomerMode || LOCK_STYLE_CHOICE) { const globalSettings = document.querySelector('.global-settings'); if(globalSettings) globalSettings.style.display = 'none'; } initSortable(); setupEventListeners(); initializeMapsForEditor(); iframe.onload = () => { renderEditor(); renderPreview(); setupResizeObserver(); }; switchEditorMode(mainPageData); }; if (isCustomerMode) { const statusText = document.getElementById('status-text'); statusText.innerText = 'Loading your template...'; try { const response = await fetch(`https://api.jsonbin.io/v3/b/${binIdToLoad}/latest`, { headers: { 'X-Access-Key': '__JSONBIN_ACCESS_KEY__' } }); if (!response.ok) { throw new Error('Could not load your purchased template. Please check the link.'); } const data = (await response.json()).record; mainPageData = data.main; rsvpFormData = data.rsvp; statusText.innerText = ''; initializeEditor(); } catch (err) { document.body.innerHTML = `<h1>Error Loading Template</h1><p>${err.message}</p>`; return; } } else { initializeEditor(); } }
    </script>
    <script async defer src="https://maps.googleapis.com/ajax/libs/api/js?key=__GOOGLE_MAPS_API_KEY__&libraries=places&callback=initApp"></script>
</body>
</html>