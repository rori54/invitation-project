<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } body { margin: 0; display: grid; grid-template-columns: 400px 1fr; background-color: #f0f2f5; } #editor-panel { grid-column: 1; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; } #preview-panel { grid-column: 2; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; } #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; } iframe { width: 100%; height: 100%; border: none; display: block; } #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } #editor-header h2 { margin: 0 0 10px 0; } #editor-header .template-switcher { display: flex; gap: 10px; } #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } #editor-content { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 0; } #editor-footer { padding: 20px; border-top: 1px solid #eee; background: #fff; } .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } .editor-block-title { font-weight: bold; flex-grow: 1; } .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } .delete-block-btn { color: crimson !important; } .editor-block-content { padding: 15px; display: none; } .editor-block-content.is-open { display: block; } .control-group { margin-bottom: 15px; } .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } .style-editor-group { border-top: 1px solid #e0e0e0; margin-top: 15px; padding-top: 15px; } .style-editor-group > label { font-size: 0.9em; color: #007bff; font-weight: bold; margin-bottom: 10px; } .style-controls-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; } .style-controls-grid .control-group { margin-bottom: 0; } .color-picker-wrapper input[type="color"] { width: 100%; height: 38px; padding: 2px; box-sizing: border-box; } .bold-toggle-wrapper label { display: flex; align-items: center; justify-content: center; background: #f0f2f5; padding: 8px; border-radius: 4px; height: 100%; box-sizing: border-box; } .bold-toggle-wrapper input { width: auto; margin-right: 5px; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } textarea { min-height: 80px; } .action-button { background-color: #007bff; color: white; border: none; padding: 12px; width: 100%; font-size: 16px; border-radius: 5px; cursor: pointer; } .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; } .modal-overlay.is-visible { display: flex; } .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); } #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="editor-panel">
        <div id="editor-header">
            <h2>Editor</h2>
            <div class="template-switcher"><button id="edit-main-btn" class="active">Invitation</button><button id="edit-rsvp-btn">RSVP Form</button></div>
        </div>
        <div id="editor-content"></div>
        <div id="editor-footer">
            <button id="add-block-btn" class="action-button" style="margin-bottom: 10px; background-color: #28a745;">+ Add New Block</button>
            <button id="share-button" class="action-button">Generate & Copy Link</button>
        </div>
    </div>
    <div id="preview-panel"><div id="preview-wrapper"><iframe id="preview-frame"></iframe></div></div>
    <template id="editor-block-template"><div class="editor-block"><div class="editor-block-header"><span class="drag-handle">☰</span><span class="editor-block-title">Block Title</span><div class="editor-block-controls"><button class="toggle-btn">▼</button><button class="delete-block-btn">×</button></div></div><div class="editor-block-content"></div></div></template>
    <div id="add-block-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close" id="modal-close-btn">×</span><h3>Choose a Block to Add</h3><div id="add-block-options"></div></div></div>

    <script>
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = [], pageSettings = {}, currentTemplate = '';

    const fontOptions = { "SCRIPT/HANDWRITTEN": ["Great Vibes", "Dancing Script", "Allura", "Sacramento", "Alex Brush", "Satisfy", "Kaushan Script", "Pacifico", "Caveat", "Cookie"], "ELEGANT SERIF": ["Playfair Display", "Crimson Text", "Cormorant Garamond", "EB Garamond", "Libre Baskerville", "Lora", "Merriweather", "Vollkorn"], "DECORATIVE": ["Cinzel", "Abril Fatface", "Amatic SC", "Fredoka One", "Lobster"], "MODERN SANS-SERIF": ["Montserrat", "Raleway", "Lato", "Open Sans", "Poppins"] };
    const defaultTextStyle = { color: '#333333', fontFamily: 'Montserrat', fontSize: '1', fontWeight: '400' };
    const defaultHeadingStyle = { ...defaultTextStyle, fontFamily: 'Playfair Display', fontSize: '2.2', fontWeight: '700' };

    let mainPageData = {
        template: 'wedding-classic.html',
        settings: {},
        blocks: [] // Will be populated by getNewBlockData
    };
    
    // ИСПРАВЛЕНО: Надежная функция для создания новых блоков со всеми стилями
    function getNewBlockData(type) {
        const baseBlock = { id: `b-${Date.now()}`, type, content: {} };
        switch(type) {
            case 'hero':
                baseBlock.content = { subtitle: 'WE ARE GETTING MARRIED', names: 'John & Jane', date: 'September 15, 2025', imageUrl: 'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg', backgroundPosition: 'center 30%', aspectRatio: '16/9', subtitleStyle: { ...defaultTextStyle, color: '#FFFFFF', fontSize: '1.2' }, namesStyle: { ...defaultHeadingStyle, color: '#FFFFFF', fontSize: '4' }, dateStyle: { ...defaultTextStyle, color: '#FFFFFF', fontSize: '1.2' } };
                break;
            case 'countdown':
                baseBlock.content = { title: 'Until Our Big Day', titleStyle: { ...defaultHeadingStyle } , numberStyle: { ...defaultTextStyle, color: '#C5A98B', fontSize: '2.5', fontWeight: '700'}, labelStyle: { ...defaultTextStyle, fontSize: '1' } };
                break;
            case 'paragraph':
                baseBlock.content = { heading: 'Our Story', text: 'We are excited to share this special day with our closest family and friends. Your presence is the greatest gift to us as we begin this beautiful new chapter of our lives.', headingStyle: { ...defaultHeadingStyle, fontSize: '1.8' }, textStyle: { ...defaultTextStyle, fontSize: '1.1' } };
                break;
            case 'schedule':
                baseBlock.content = { title: 'The Day\'s Schedule', titleStyle: { ...defaultHeadingStyle }, timeStyle: { ...defaultTextStyle, color: '#C5A98B', fontWeight: '700', fontSize: '1.2' }, eventTitleStyle: { ...defaultHeadingStyle, fontSize: '1.4' }, eventDescStyle: { ...defaultTextStyle }, items: [ { time: '16:00', title: 'Ceremony', desc: 'The main event!' } ] };
                break;
            case 'location':
                baseBlock.content = { title: 'Venue', address: 'The Grand Hall, 123 Celebration Ave', imageUrl: 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', mapLink: 'https://maps.google.com', titleStyle: { ...defaultHeadingStyle }, addressStyle: { ...defaultTextStyle }, buttonStyle: { accentColor: '#C5A98B' } };
                break;
            case 'rsvp':
                 baseBlock.content = { title: 'Confirm Your Attendance', subtitle: 'Please reply by September 1st.', titleStyle: { ...defaultHeadingStyle }, subtitleStyle: { ...defaultTextStyle }, buttonStyle: { accentColor: '#C5A98B' } };
                break;
        }
        return baseBlock;
    }
    
    // --- UI RENDERING ---
    function createFontSelector(selectedFont) { let html = `<select data-style-key="fontFamily">`; for (const group in fontOptions) { html += `<optgroup label="${group}">`; fontOptions[group].forEach(font => { html += `<option value="${font}" ${selectedFont === font ? 'selected' : ''}>${font}</option>`; }); html += `</optgroup>`; } html += `</select>`; return html; }
    function createStyleControls(prefix, styleObj = {}) { const s = { ...defaultTextStyle, ...styleObj }; return `<div class="style-editor-group"><label>${prefix} Style</label><div class="style-controls-grid"><div class="control-group"><div><label>Font</label>${createFontSelector(s.fontFamily)}</div></div><div class="control-group"><div><label>Size (em)</label><input type="number" step="0.1" value="${s.fontSize}" data-style-key="fontSize"></div></div><div class="control-group"><div class="color-picker-wrapper"><label>Color</label><input type="color" value="${s.color}" data-style-key="color"></div></div><div class="control-group"><div class="bold-toggle-wrapper"><label><input type="checkbox" ${s.fontWeight === '700' ? 'checked' : ''} data-style-key="fontWeight"> Bold</label></div></div></div></div>`.replace(/data-style-key/g, `data-style-group="${prefix.toLowerCase().replace(/\s+/g, '')}Style" data-style-key`); }
    function createAspectRatioSelect(selectedRatio) { return `<div class="control-group"><label>Block Shape (Height)</label><select data-key="aspectRatio"><option value="21/9" ${selectedRatio === '21/9' ? 'selected' : ''}>Cinematic</option><option value="16/9" ${selectedRatio === '16/9' ? 'selected' : ''}>Widescreen</option><option value="8/5" ${selectedRatio === '8/5' ? 'selected' : ''}>Landscape (8:5)</option><option value="3/2" ${selectedRatio === '3/2' ? 'selected' : ''}>Classic Photo</option><option value="4/3" ${selectedRatio === '4/3' ? 'selected' : ''}>Standard</option><option value="1/1" ${selectedRatio === '1/1' ? 'selected' : ''}>Square</option><option value="9/12" ${selectedRatio === '9/12' ? 'selected' : ''}>Portrait</option><option value="9/16" ${selectedRatio === '9/16' ? 'selected' : ''}>Tall Portrait</option></select></div>`; }

    function createEditorFieldsForBlock(block) {
        const c = block.content; let fieldsHTML = '';
        switch (block.type) {
            case 'hero': fieldsHTML = `<div class="control-group"><label>Subtitle</label><input type="text" data-key="subtitle" value="${c.subtitle || ''}"></div><div class="control-group"><label>Names</label><input type="text" data-key="names" value="${c.names || ''}"></div><div class="control-group"><label>Date</label><input type="text" data-key="date" value="${c.date || ''}"></div><div class="control-group"><label>Image URL</label><input type="url" data-key="imageUrl" value="${c.imageUrl || ''}"></div><div class="control-group"><label>Focus Point</label><input type="text" data-key="backgroundPosition" value="${c.backgroundPosition || 'center center'}"></div>` + createAspectRatioSelect(c.aspectRatio) + createStyleControls('Subtitle', c.subtitleStyle) + createStyleControls('Names', c.namesStyle) + createStyleControls('Date', c.dateStyle); break;
            case 'paragraph': fieldsHTML = `<div class="control-group"><label>Heading (optional)</label><input type="text" data-key="heading" value="${c.heading || ''}"></div><div class="control-group"><label>Text</label><textarea data-key="text">${c.text || ''}</textarea></div>` + createStyleControls('Heading', c.headingStyle) + createStyleControls('Text', c.textStyle); break;
            case 'countdown': fieldsHTML = `<div class="control-group"><label>Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>` + createStyleControls('Title', c.titleStyle) + createStyleControls('Number', c.numberStyle) + createStyleControls('Label', c.labelStyle); break;
            case 'schedule': fieldsHTML = `<div class="control-group"><label>Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>` + createStyleControls('Section Title', c.titleStyle) + createStyleControls('Time', c.timeStyle) + createStyleControls('Event Title', c.eventTitleStyle) + createStyleControls('Event Desc', c.eventDescStyle); break;
            case 'location': fieldsHTML = `<div class="control-group"><label>Title</label><input type="text" data-key="title" value="${c.title || ''}"></div><div class="control-group"><label>Address</label><textarea data-key="address">${c.address || ''}</textarea></div><div class="control-group"><label>Image URL</label><input type="url" data-key="imageUrl" value="${c.imageUrl || ''}"></div><div class="control-group"><label>Button Color</label><input type="color" data-style-group="buttonStyle" data-style-key="accentColor" value="${(c.buttonStyle && c.buttonStyle.accentColor) || '#C5A98B'}"></div>` + createStyleControls('Title', c.titleStyle) + createStyleControls('Address', c.addressStyle); break;
            case 'rsvp': fieldsHTML = `<div class="control-group"><label>Title</label><input type="text" data-key="title" value="${c.title || ''}"></div><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle || ''}</textarea></div><div class="control-group"><label>Button Color</label><input type="color" data-style-group="buttonStyle" data-style-key="accentColor" value="${(c.buttonStyle && c.buttonStyle.accentColor) || '#C5A98B'}"></div>` + createStyleControls('Title', c.titleStyle) + createStyleControls('Subtitle', c.subtitleStyle); break;
            default: fieldsHTML = 'No settings available.';
        }
        return fieldsHTML;
    }
    function renderEditor() { const container = document.getElementById('editor-content'); container.innerHTML = ''; pageBlocks.forEach(block => { const tpl = document.getElementById('editor-block-template').content.cloneNode(true); const editorBlock = tpl.querySelector('.editor-block'); editorBlock.dataset.id = block.id; editorBlock.querySelector('.editor-block-title').textContent = block.type.charAt(0).toUpperCase() + block.type.slice(1); editorBlock.querySelector('.editor-block-content').innerHTML = createEditorFieldsForBlock(block); container.appendChild(tpl); }); }

    // --- LOGIC ---
    function handleEditorChange(e) {
        const input = e.target;
        const blockDiv = input.closest('.editor-block');
        if (!blockDiv) return;
        const blockId = blockDiv.dataset.id;
        const block = pageBlocks.find(b => b.id === blockId);
        if (!block) return;

        const key = input.dataset.key;
        const styleGroup = input.dataset.styleGroup;
        const styleKey = input.dataset.styleKey;
        let value = input.type === 'checkbox' ? (input.checked ? '700' : '400') : input.value;

        if (styleGroup && styleKey) {
            if (!block.content[styleGroup]) block.content[styleGroup] = {};
            block.content[styleGroup][styleKey] = value;
        } else if (key) {
            block.content[key] = value;
        }
        renderPreview();
    }
    
    function setupEventListeners() {
        const editorContent = document.getElementById('editor-content');
        editorContent.addEventListener('input', handleEditorChange);
        editorContent.addEventListener('change', handleEditorChange);
        editorContent.addEventListener('click', e => {
            const blockDiv = e.target.closest('.editor-block');
            if (!blockDiv) return;
            if (e.target.closest('.delete-block-btn')) { pageBlocks = pageBlocks.filter(b => b.id !== blockDiv.dataset.id); renderEditor(); renderPreview(); }
            if (e.target.closest('.editor-block-header')) { blockDiv.querySelector('.editor-block-content').classList.toggle('is-open'); }
        });
        const addBlockOptions = document.getElementById('add-block-options');
        addBlockOptions.innerHTML = ['Hero', 'Countdown', 'Paragraph', 'Schedule', 'Location', 'RSVP'].map(type => `<button data-type="${type}">${type}</button>`).join('');
        document.getElementById('add-block-btn').addEventListener('click', () => document.getElementById('add-block-modal').classList.add('is-visible'));
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('add-block-modal').classList.remove('is-visible'));
        addBlockOptions.addEventListener('click', e => { if (e.target.dataset.type) { const type = e.target.dataset.type.toLowerCase(); pageBlocks.push(getNewBlockData(type)); renderEditor(); renderPreview(); document.getElementById('add-block-modal').classList.remove('is-visible'); }});
    }

    function renderPreview() { if (iframe.contentWindow && typeof iframe.contentWindow.renderPage === 'function') { iframe.contentWindow.renderPage(pageBlocks, pageSettings); } }
    function switchEditorMode() { currentTemplate = mainPageData.template; pageSettings = { ...mainPageData.settings }; pageBlocks = [getNewBlockData('hero'), getNewBlockData('paragraph'), getNewBlockData('countdown')]; iframe.src = `templates/${currentTemplate}?v=${Date.now()}`; }
    
    function initApp() {
        setupEventListeners();
        iframe.onload = () => { renderEditor(); renderPreview(); };
        // Запускаем приложение с начальным набором блоков
        pageBlocks = [getNewBlockData('hero'), getNewBlockData('countdown'), getNewBlockData('paragraph'), getNewBlockData('schedule')];
        currentTemplate = mainPageData.template;
        iframe.src = `templates/${currentTemplate}?v=${Date.now()}`;
    }
    initApp();
    </script>
</body>
</html>