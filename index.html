<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } body { margin: 0; display: grid; grid-template-columns: 400px 1fr; background-color: #f0f2f5; } #editor-panel { grid-column: 1; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; } #preview-panel { grid-column: 2; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; } #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; } iframe { width: 100%; height: 100%; border: none; display: block; } #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } .global-settings { margin-top: 15px; } .global-settings .control-group { margin-bottom: 10px; } #global-bg-image-group { display: none; } #editor-content { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 0; } #editor-footer { padding: 20px; border-top: 1px solid #eee; } .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } .editor-block-title { font-weight: bold; flex-grow: 1; } .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } .delete-block-btn { color: crimson !important; } .editor-block-content { padding: 15px; display: none; } .editor-block-content.is-open { display: block; } .control-group { margin-bottom: 15px; } .control-group.color-picker { display: flex; align-items: center; gap: 10px; } .control-group.color-picker input[type="color"] { padding: 0; height: 38px; width: 60px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; } .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; } label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } input.smart-location-search { border-left: 4px solid #28a745; } textarea { min-height: 80px; } .action-button { background-color: #007bff; color: white; border: none; padding: 12px; width: 100%; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; } .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } .modal-overlay.is-visible { display: flex; } .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; } .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; } #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px; }
        @media (max-width: 1024px) { body { grid-template-columns: 320px 1fr; } } @media (max-width: 768px) { body { display: flex; flex-direction: column; } #editor-panel { position: relative; height: auto; max-height: 60vh; border-right: none; border-bottom: 2px solid #ddd; } #preview-panel { padding: 10px; } }
    </style>
</head>
<body>
    <div id="editor-panel">
        <div id="editor-header">
            <h2>Editor</h2>
            <div class="template-switcher"><button id="edit-main-btn" class="active">Invitation</button><button id="edit-rsvp-btn">RSVP Form</button></div>
            
            <div class="global-settings">
                <h3 style="margin-top:20px; margin-bottom:10px;">Page Layout</h3>
                <div class="control-group"><label for="global-style-select">Page Style</label><select id="global-style-select"><option value="classic">Classic (Cards)</option><option value="modern">Modern (Shared Background)</option></select></div>
                <div class="control-group" id="global-bg-image-group"><label for="global-bg-image-input">Background Image URL</label><input type="url" id="global-bg-image-input" placeholder="https://images.unsplash.com/photo-..."></div>
                <div class="control-group"><label for="global-width-input">Global Block Width</label><input type="text" id="global-width-input" placeholder="e.g., 800px or 90%"></div>
                
                <h3 style="margin-top:20px; margin-bottom:10px;">Global Design</h3>
                <div class="control-group color-picker"><label for="global-accent-color-input">Accent Color</label><input type="color" id="global-accent-color-input"></div>
                <div class="control-group"><label for="global-heading-font-select">Heading Font</label><select id="global-heading-font-select"></select></div>
                <div class="control-group"><label for="global-body-font-select">Body Text Font</label><select id="global-body-font-select"></select></div>
            </div>
        </div>

        <div id="editor-content"></div>

        <div id="editor-footer">
            <button id="add-block-btn" class="action-button" style="margin-bottom: 15px; background-color: #28a745;">+ Add New Block</button>
            <button id="share-button" class="action-button">Generate & Copy Link</button>
            <p id="status-text" style="text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="preview-panel"><div id="preview-wrapper"><iframe id="preview-frame" scrolling="no"></iframe></div></div>
    
    <template id="editor-block-template"><div class="editor-block"><div class="editor-block-header"><span class="drag-handle">☰</span><span class="editor-block-title">Block Title</span><div class="editor-block-controls"><button class="toggle-btn">▼</button><button class="delete-block-btn" title="Delete Block">×</button></div></div><div class="editor-block-content"></div></div></template>
    
    <div id="add-block-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close" id="modal-close-btn">×</span><h3>Choose a Block to Add</h3><div id="add-block-options"><button data-type="heading">Heading</button><button data-type="paragraph">Paragraph</button><button data-type="image">Image</button><hr><button data-type="hero">Hero Block</button><button data-type="schedule">Schedule</button><button data-type="location">Location</button><button data-type="countdown">Countdown</button><button data-type="rsvp">RSVP Button</button><hr><button data-type="form-header">Form: Header</button><button data-type="input-question">Form: Text Input</button><button data-type="textarea-question">Form: Text Area</button><button data-type="radio-question">Form: Radio Choice</button><button data-type="form-footer">Form: Footer</button></div></div></div>

    <script>
    const LOCK_STYLE_CHOICE = false;
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; let pageSettings = {}; let currentTemplate = '';
    
    // --- ДАННЫЕ И НАСТРОЙКИ ---

    const fontOptions = {
        "SCRIPT/HANDWRITTEN": ["Great Vibes", "Dancing Script", "Allura", "Sacramento", "Alex Brush", "Satisfy", "Kaushan Script", "Pacifico", "Caveat", "Cookie"],
        "ELEGANT SERIF": ["Playfair Display", "Crimson Text", "Cormorant Garamond", "EB Garamond", "Libre Baskerville", "Lora", "Merriweather", "Vollkorn"],
        "DECORATIVE": ["Cinzel", "Abril Fatface", "Amatic SC", "Fredoka One", "Lobster"],
        "MODERN SANS-SERIF": ["Montserrat", "Raleway", "Lato", "Open Sans", "Poppins"]
    };

    let mainPageData = {
        template: 'wedding-classic.html',
        settings: {
            maxWidth: '800px', style: 'classic', backgroundImage: '',
            accentColor: '#c5a98b', headingFont: 'Playfair Display', bodyFont: 'Montserrat'
        },
        blocks: [ { type: 'hero', id: `b1`, content: { subtitle: 'WE ARE GETTING MARRIED', names: 'John & Jane', date: 'September 15, 2025', imageUrl: 'https://cdn.pixabay.com/photo/2018/03/01/01/07/blossom-3189810_1280.jpg', backgroundPosition: 'center 30%', aspectRatio: '16/9', innerBlocks: [] }}, { type: 'countdown', id: `b2`, content: { title: 'Until Our Big Day', targetDate: '2025-09-15T16:00' }}, { type: 'paragraph', id: `b3`, content: { heading: 'Our Story', text: 'We are excited to share this special day with our closest family and friends.\n\nYour presence is the greatest gift to us as we begin this beautiful new chapter of our lives.' }}, { type: 'schedule', id: `b4`, content: { title: 'The Day\'s Schedule', items: [ { id: `s-1`, time: '15:00', title: 'Guest Arrival', desc: 'Welcome drinks and light music.'}, { id: `s-2`, time: '16:00', title: 'Ceremony', desc: 'The main event!'}, { id: `s-3`, time: '18:00', title: 'Dinner & Party', desc: 'Let\'s celebrate together.'} ]}}, { type: 'location', id: `b5`, content: { title: 'Venue', address: 'The Grand Hall, 123 Celebration Ave, New York', imageUrl: 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', mapLink: 'https://maps.google.com' }}, { type: 'rsvp', id: `b6`, content: { title: 'Confirm Your Attendance', subtitle: 'Please reply by September 1st.\nClick the button to fill out the RSVP form.', acceptLink: '#', declineLink: '#' }} ]
    };
    let rsvpFormData = {
        template: 'rsvp-form.html',
        settings: {
            maxWidth: '800px', style: 'classic', backgroundImage: '',
            accentColor: '#c5a98b', headingFont: 'Playfair Display', bodyFont: 'Montserrat'
        },
        blocks: [ { type: 'form-header', id: `f1`, content: { title: 'Confirm Your Attendance', subtitle: 'We can\'t wait to celebrate with you!', imageUrl: 'https://images.unsplash.com/photo-1595398638959-529255a58a36?q=80&w=2070&auto=format&fit=crop', aspectRatio: '4/3', innerBlocks: [] }}, { type: 'input-question', id: `f2`, content: { id: 'name', title: '♥ Your Full Name', required: true }}, { type: 'radio-question', id: `f3`, content: { id: 'attendance', title: '♥ Will you be able to join us?', required: true, options: [{ id: `o1`, text: 'Yes, I\'ll be there!' }, { id: `o2`, text: 'Sadly, I can\'t make it.' }] }}, { type: 'form-footer', id: `f7`, content: { text: 'Thank you for your response! ♥' }} ]
    };
    
    // --- ГЕНЕРАЦИЯ ЭЛЕМЕНТОВ РЕДАКТОРА ---

    function getNewBlockData(type) { const newBlock = { type: type, id: `block-${Date.now()}`, content: {} }; switch(type) { case 'hero': newBlock.content = { subtitle: 'New Subtitle', names: 'New Names', date: 'New Date', imageUrl: '', backgroundPosition: 'center center', aspectRatio: '16/9', innerBlocks: [] }; break; case 'paragraph': newBlock.content = { heading: 'New Heading', text: 'This is a new paragraph.' }; break; case 'countdown': newBlock.content = { title: 'New Countdown', targetDate: '' }; break; case 'schedule': newBlock.content = { title: 'New Schedule', items: [] }; break; case 'location': newBlock.content = { title: 'New Location', address: '', imageUrl: '', mapLink: '#' }; break; case 'rsvp': newBlock.content = { title: 'New RSVP Block', subtitle: 'New subtitle text' }; break; case 'heading': newBlock.content = { text: 'New Heading' }; break; case 'image': newBlock.content = { imageUrl: 'https://via.placeholder.com/800x400', caption: 'Image caption' }; break; default: break; } return newBlock; }
    
    function createEditorFieldsForBlock(block) {
        let fieldsHTML = '';
        const bgPosField = `<div class="control-group"><label>Background Focus Point</label><input type="text" data-key="backgroundPosition" value="${block.content.backgroundPosition || 'center center'}" placeholder="e.g., center 30%"></div>`;
        const aspectRatioSelect = `
            <div class="control-group">
                <label for="aspect-ratio-select-${block.id}">Block Shape (Height)</label>
                <select id="aspect-ratio-select-${block.id}" data-key="aspectRatio">
                    <option value="21/9" ${block.content.aspectRatio === '21/9' ? 'selected' : ''}>Cinematic (Very Wide)</option>
                    <option value="16/9" ${block.content.aspectRatio === '16/9' ? 'selected' : ''}>Widescreen (Standard)</option>
                    <option value="8/5"  ${block.content.aspectRatio === '8/5' ? 'selected' : ''}>Landscape (8:5)</option>
                    <option value="3/2"  ${block.content.aspectRatio === '3/2' ? 'selected' : ''}>Landscape (Classic Photo)</option>
                    <option value="4/3"  ${block.content.aspectRatio === '4/3' ? 'selected' : ''}>Standard (Monitor)</option>
                    <option value="1/1"  ${block.content.aspectRatio === '1/1' ? 'selected' : ''}>Square</option>
                    <option value="9/12" ${block.content.aspectRatio === '9/12' ? 'selected' : ''}>Portrait (Standard)</option>
                    <option value="9/16" ${block.content.aspectRatio === '9/16' ? 'selected' : ''}>Portrait (Tall)</option>
                </select>
            </div>`;

        switch(block.type) {
            case 'hero': fieldsHTML = `<div class="control-group"><label>Subtitle</label><input type="text" data-key="subtitle" value="${block.content.subtitle || ''}"></div><div class="control-group"><label>Names</label><input type="text" data-key="names" value="${block.content.names || ''}"></div><div class="control-group"><label>Date (text)</label><input type="text" data-key="date" value="${block.content.date || ''}"></div><div class="control-group"><label>Background Image URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl || ''}"></div>${aspectRatioSelect}${bgPosField}`; break;
            case 'paragraph': fieldsHTML = `<div class="control-group"><label>Heading (optional)</label><input type="text" data-key="heading" value="${block.content.heading || ''}"></div><div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${block.content.text || ''}</textarea></div>`; break;
            case 'schedule': let scheduleItems = (block.content.items || []).map(item => `<div class="sub-item-editor" data-item-id="${item.id}"><input type="text" placeholder="Time" class="sub-item-input" data-item-key="time" value="${item.time || ''}"><input type="text" placeholder="Title" class="sub-item-input" data-item-key="title" value="${item.title || ''}"><button class="delete-sub-item-btn">×</button><textarea class="sub-item-input" data-item-key="desc" placeholder="Description">${item.desc || ''}</textarea></div>`).join(''); fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title || ''}"></div><div class="control-group"><label>Items</label>${scheduleItems}</div><button class="add-sub-item-btn action-button" data-list-key="items" style="font-size: 12px; padding: 5px; margin-top: 10px;">+ Add Item</button>`; break;
            case 'countdown': fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title || ''}"></div><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${block.content.targetDate || ''}"></div>`; break;
            case 'location': fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title || ''}"></div><div class="control-group"><label>Address</label><textarea data-key="address">${block.content.address || ''}</textarea></div><div class="control-group"><label>Photo URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl || ''}"></div><div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${block.content.mapLink || ''}"></div>`; break;
            case 'rsvp': fieldsHTML = `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${block.content.title || ''}"></div><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${block.content.subtitle || ''}</textarea></div>`; break;
            case 'heading': fieldsHTML = `<div class="control-group"><label>Heading Text</label><input type="text" data-key="text" value="${block.content.text || ''}"></div>`; break;
            case 'image': fieldsHTML = `<div class="control-group"><label>Image URL</label><input type="url" data-key="imageUrl" value="${block.content.imageUrl || ''}"></div><div class="control-group"><label>Caption</label><input type="text" data-key="caption" value="${block.content.caption || ''}"></div>`; break;
            default: fieldsHTML = 'No editor available for this block type.';
        }
        return fieldsHTML;
    }

    function renderEditor() { const container = document.getElementById('editor-content'); const currentlyOpen = [...container.querySelectorAll('.editor-block-content.is-open')].map(el => el.closest('.editor-block').dataset.id); container.innerHTML = ''; pageBlocks.forEach(block => { const tpl = document.getElementById('editor-block-template').content.cloneNode(true); const editorBlock = tpl.querySelector('.editor-block'); editorBlock.dataset.id = block.id; const title = block.type.charAt(0).toUpperCase() + block.type.slice(1).replace(/-/g, ' '); editorBlock.querySelector('.editor-block-title').textContent = title; const contentDiv = editorBlock.querySelector('.editor-block-content'); contentDiv.innerHTML = createEditorFieldsForBlock(block); if (currentlyOpen.includes(block.id)) { contentDiv.classList.add('is-open'); editorBlock.querySelector('.toggle-btn').textContent = '▲'; } container.appendChild(tpl); }); }
    
    // --- ОСНОВНАЯ ЛОГИКА ---
    
    function populateFontSelectors() {
        const headingSelect = document.getElementById('global-heading-font-select');
        const bodySelect = document.getElementById('global-body-font-select');
        [headingSelect, bodySelect].forEach(select => {
            select.innerHTML = '';
            for (const group in fontOptions) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;
                fontOptions[group].forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    option.style.fontFamily = font;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        });
    }

    function handleEditorChange(e) {
        const input = e.target;
        const key = input.dataset.key;
        const value = input.type === 'checkbox' ? input.checked : (input.type === 'color' ? input.value.toUpperCase() : input.value);
        
        // Глобальные настройки
        if (['accentColor', 'headingFont', 'bodyFont', 'style', 'backgroundImage', 'maxWidth'].includes(key)) {
            pageSettings[key] = value;
        }
        // Настройки блоков
        else {
            const blockDiv = input.closest('.editor-block');
            if (!blockDiv) return;
            const blockId = blockDiv.dataset.id;
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
            if (blockIndex > -1) pageBlocks[blockIndex].content[key] = value;
        }
        renderPreview();
    }
    
    function setupEventListeners() {
        const editorPanel = document.getElementById('editor-panel');
        editorPanel.addEventListener('input', handleEditorChange);
        editorPanel.addEventListener('change', handleEditorChange);
        
        document.getElementById('editor-content').addEventListener('click', (e) => {
            const target = e.target;
            const blockDiv = target.closest('.editor-block');
            if (!blockDiv) return;
            const blockId = blockDiv.dataset.id;
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId);

            if (target.closest('.delete-block-btn')) { if (confirm('Are you sure?')) { pageBlocks.splice(blockIndex, 1); renderEditor(); renderPreview(); } }
            else if (target.closest('.editor-block-header')) { blockDiv.querySelector('.editor-block-content').classList.toggle('is-open'); blockDiv.querySelector('.toggle-btn').textContent = blockDiv.querySelector('.editor-block-content').classList.contains('is-open') ? '▲' : '▼'; }
        });

        document.getElementById('add-block-btn').addEventListener('click', () => document.getElementById('add-block-modal').classList.add('is-visible'));
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('add-block-modal').classList.remove('is-visible'));
        document.getElementById('add-block-options').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { pageBlocks.push(getNewBlockData(e.target.dataset.type)); renderEditor(); renderPreview(); document.getElementById('add-block-modal').classList.remove('is-visible'); } });
    }

    function renderPreview() { if (iframe.contentWindow && typeof iframe.contentWindow.renderPage === 'function') { iframe.contentWindow.renderPage(pageBlocks, pageSettings); } }
    
    function updateGlobalControls() {
        document.getElementById('global-style-select').value = pageSettings.style;
        document.getElementById('global-bg-image-group').style.display = (pageSettings.style === 'modern') ? 'block' : 'none';
        document.getElementById('global-bg-image-input').value = pageSettings.backgroundImage || '';
        document.getElementById('global-width-input').value = pageSettings.maxWidth;
        document.getElementById('global-accent-color-input').value = pageSettings.accentColor;
        document.getElementById('global-heading-font-select').value = pageSettings.headingFont;
        document.getElementById('global-body-font-select').value = pageSettings.bodyFont;
    }

    function switchEditorMode(targetTemplateData) {
        currentTemplate = targetTemplateData.template;
        pageSettings = JSON.parse(JSON.stringify(targetTemplateData.settings));
        pageBlocks = JSON.parse(JSON.stringify(targetTemplateData.blocks));
        updateGlobalControls();
        iframe.src = `templates/${currentTemplate}?v=${Date.now()}`;
        document.getElementById('edit-main-btn').classList.toggle('active', currentTemplate === mainPageData.template);
        document.getElementById('edit-rsvp-btn').classList.toggle('active', currentTemplate === rsvpFormData.template);
    }
    
    function saveCurrentPageData() {
        const dataToSave = { settings: JSON.parse(JSON.stringify(pageSettings)), blocks: JSON.parse(JSON.stringify(pageBlocks)) };
        if (currentTemplate === mainPageData.template) { mainPageData = { ...mainPageData, ...dataToSave }; }
        else { rsvpFormData = { ...rsvpFormData, ...dataToSave }; }
    }

    // --- ИНИЦИАЛИЗАЦИЯ ---
    
    function initApp() {
        populateFontSelectors();
        setupEventListeners();

        iframe.onload = () => { renderEditor(); renderPreview(); };
        
        document.getElementById('edit-main-btn').addEventListener('click', () => { if (currentTemplate !== mainPageData.template) { saveCurrentPageData(); switchEditorMode(mainPageData); } });
        document.getElementById('edit-rsvp-btn').addEventListener('click', () => { if (currentTemplate !== rsvpFormData.template) { saveCurrentPageData(); switchEditorMode(rsvpFormData); } });

        switchEditorMode(mainPageData);
    }

    initApp();
    </script>
</body>
</html>