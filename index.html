<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } body { margin: 0; display: grid; grid-template-columns: 420px 1fr; background-color: #f0f2f5; } #editor-panel { grid-column: 1; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; } #preview-panel { grid-column: 2; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; } #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; } iframe { width: 100%; height: 100%; border: none; display: block; } #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } .global-settings { margin-top: 15px; } #editor-content { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 0; } #editor-footer { padding: 20px; border-top: 1px solid #eee; text-align: center; } #editor-footer button { padding: 10px 15px; width: auto; display: inline-block; margin: 0 5px; } .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } .editor-block-title { font-weight: bold; flex-grow: 1; } .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } .delete-block-btn { color: crimson !important; } .editor-block-content { padding: 15px; display: none; } .editor-block-content.is-open { display: block; }
        .control-group { margin-bottom: 15px; } .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } textarea { min-height: 80px; }
        .image-input-group { display: flex; align-items: center; gap: 8px; } .image-input-group input { flex-grow: 1; } .image-input-group button { flex-shrink: 0; padding: 8px 12px; }
        .style-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; } .style-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; } .style-controls .control-group { margin-bottom: 0; } input[type="color"] { padding: 2px; min-height: 38px; } .style-controls label { font-size: 0.9em; font-weight: 600; color: #555; } hr.style-separator { border: none; border-top: 1px dashed #ccc; margin: 15px 0; }
        .optional-element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } .optional-element-header label { margin-bottom: 0; }
        .sticker-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #6f42c1; } .sticker-editor-header { display: flex; justify-content: space-between; align-items: center; } .sticker-editor .control-group { margin-bottom: 8px; } .sticker-editor .control-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 3px; } .delete-sticker-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-weight: bold; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } .modal-overlay.is-visible { display: flex; } .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } .modal-close { font-size: 28px; font-weight: bold; cursor: pointer; }
        .library-content { flex-grow: 1; overflow-y: auto; } .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; } .library-item { cursor: pointer; border: 2px solid transparent; border-radius: 6px; padding: 5px; background: #f0f2f5; } .library-item:hover { border-color: #007bff; } .library-item img { width: 100%; height: 100px; object-fit: contain; }
        .upload-section { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px; } .upload-section input[type="file"] { display: none; } .upload-label { display: inline-block; padding: 10px 15px; background-color: #28a745; color: white; border-radius: 5px; cursor: pointer; } #status-text { text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="editor-panel">
        <div id="editor-header"><h2>Editor</h2><div class="template-switcher"><button id="edit-main-btn" class="active">Invitation</button><button id="edit-rsvp-btn">RSVP Form</button></div><div class="global-settings"><div class="control-group"><label>Page Style</label><select id="global-style-select"><option value="classic">Classic (Cards)</option><option value="modern">Modern (Shared BG)</option></select></div><div class="control-group" id="global-bg-image-group"></div><div class="control-group"><label>Global Block Width</label><input type="text" id="global-width-input" placeholder="e.g., 800px or 90%"></div></div></div>
        <div id="editor-content"></div>
        <div id="editor-footer"><button id="add-block-btn" style="background-color: #28a745;">+ Add New Block</button><button id="share-button">Generate & Copy Link</button><p id="status-text"></p></div>
    </div>
    <div id="preview-panel"><div id="preview-wrapper"><iframe id="preview-frame" scrolling="no"></iframe></div></div>

    <template id="editor-block-template"><div class="editor-block"><div class="editor-block-header"><span class="drag-handle">☰</span><span class="editor-block-title">Block Title</span><div class="editor-block-controls"><button class="toggle-btn">▼</button><button class="delete-block-btn" title="Delete Block">×</button></div></div><div class="editor-block-content"></div></div></template>
    
    <div id="add-block-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Choose Block</h3><span class="modal-close">×</span></div><div id="add-block-options"><button data-type="hero">Hero</button><button data-type="text-block">Text Block</button><button data-type="image">Image</button><button data-type="schedule">Schedule</button><button data-type="location">Location</button><button data-type="countdown">Countdown</button><button data-type="rsvp">RSVP Button</button></div></div></div>
    
    <div id="image-library-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Image Library</h3><span class="modal-close">×</span></div>
            <div class="library-content">
                <h4>Choose from Library</h4>
                <div class="library-grid">
                    <div class="library-item" data-src="https://i.ibb.co/L9yvLgG/gold-wedding-rings.png"><img src="https://i.ibb.co/L9yvLgG/gold-wedding-rings.png" alt="Rings"></div>
                    <div class="library-item" data-src="https://i.ibb.co/N21PQQx/heart-shape-outline.png"><img src="https://i.ibb.co/N21PQQx/heart-shape-outline.png" alt="Heart"></div>
                    <div class="library-item" data-src="https://i.ibb.co/GHLwJ0y/confetti-PNG86933.png"><img src="https://i.ibb.co/GHLwJ0y/confetti-PNG86933.png" alt="Confetti"></div>
                    <div class="library-item" data-src="https://i.ibb.co/P9t1Kk1/a85c32465e94453b610c28340d829378.png"><img src="https://i.ibb.co/P9t1Kk1/a85c32465e94453b610c28340d829378.png" alt="Leaf branch"></div>
                </div>
                <div class="upload-section">
                    <h4>Or Upload Your Own</h4>
                    <input type="file" id="image-upload-input" accept="image/*">
                    <label for="image-upload-input" class="upload-label">Upload from Computer</label>
                    <p id="upload-status" style="margin-top:10px;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    const iframe = document.getElementById("preview-frame");
    let IMGBB_API_KEY; 

    let pageBlocks = []; let pageSettings = {}; let currentTemplate = '';
    const defaultTextStyle = { fontFamily: 'Montserrat', fontSize: '1rem', color: '#333333', fontWeight: '400' };
    const defaultTitleStyle = { fontFamily: 'Playfair Display', fontSize: '2.2rem', color: '#111111', fontWeight: '700' };
    let mainPageData = { template: 'wedding-classic.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ { type: 'hero', id: `block-${Date.now()}-1`, content: { subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, names: { text: 'John & Jane', enabled: true, style: { fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF', fontWeight: '400' } }, date: { text: 'September 15, 2025', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, imageUrl: 'https://i.ibb.co/mJLQ5bC/blossom-3189810-1280.jpg', backgroundPosition: 'center 30%', aspectRatio: '9/16', innerBlocks: [], stickers: [] }}, { type: 'text-block', id: `block-${Date.now()}-3`, content: { title: 'A few words', text: 'We are excited to share this special day with our closest family and friends.', titleStyle: { ...defaultTitleStyle, fontSize: '2.5rem' }, textStyle: { ...defaultTextStyle, fontSize: '1.1rem', textAlign: 'center' }, stickers: [] }} ] };
    let rsvpFormData = { template: 'rsvp-form.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [] };
    
    const fontOptionsHTML = `<optgroup label="Script/Handwritten"> <option value="Great Vibes">Great Vibes</option> <option value="Dancing Script">Dancing Script</option> <option value="Allura">Allura</option> <option value="Sacramento">Sacramento</option> <option value="Alex Brush">Alex Brush</option> <option value="Satisfy">Satisfy</option> <option value="Kaushan Script">Kaushan Script</option> <option value="Pacifico">Pacifico</option> <option value="Caveat">Caveat</option> <option value="Cookie">Cookie</option> </optgroup> <optgroup label="Elegant Serif"> <option value="Playfair Display">Playfair Display</option> <option value="Crimson Text">Crimson Text</option> <option value="Cormorant Garamond">Cormorant Garamond</option> <option value="EB Garamond">EB Garamond</option> <option value="Libre Baskerville">Libre Baskerville</option> <option value="Lora">Lora</option> <option value="Merriweather">Merriweather</option> <option value="Vollkorn">Vollkorn</option> </optgroup> <optgroup label="Decorative"> <option value="Cinzel">Cinzel</option> <option value="Abril Fatface">Abril Fatface</option> <option value="Amatic SC">Amatic SC</option> <option value="Fredoka One">Fredoka One</option> <option value="Lobster">Lobster</option> </optgroup> <optgroup label="Modern Sans-Serif"> <option value="Montserrat">Montserrat</option> <option value="Raleway">Raleway</option> <option value="Lato">Lato</option> <option value="Open Sans">Open Sans</option> <option value="Poppins">Poppins</option> </optgroup>`;
    
    function getNewBlockData(type) { const newBlock = { type, id: `block-${Date.now()}`, content: { stickers: [] } }; switch(type) { case 'hero': Object.assign(newBlock.content, { subtitle: {text:'WE ARE GETTING MARRIED',enabled:true,style:{...defaultTextStyle,color:'#FFFFFF'}}, names:{text:'John & Jane',enabled:true,style:{...defaultTitleStyle,fontFamily:'Great Vibes',fontSize:'4rem',color:'#FFFFFF'}}, date:{text:'September 15, 2025',enabled:true,style:{...defaultTextStyle,color:'#FFFFFF'}}, imageUrl:'https://i.ibb.co/hZJgVfG/photo-1522158637959-30385a09e0da.jpg', backgroundPosition:'center center', aspectRatio:'16/9', innerBlocks:[] }); break; case 'text-block': Object.assign(newBlock.content, { title:'New Title', text:'New paragraph text.', titleStyle:{...defaultTitleStyle}, textStyle:{...defaultTextStyle} }); break; case 'countdown': Object.assign(newBlock.content, { title:'New Countdown', targetDate:'', titleStyle:{...defaultTitleStyle} }); break; case 'schedule': Object.assign(newBlock.content, { title:'New Schedule', items:[], titleStyle:{...defaultTitleStyle} }); break; case 'location': Object.assign(newBlock.content, { title:'New Location', address:'', imageUrl:'https://i.ibb.co/yQvD2hH/photo-1511795408833-2a1e94992e7a.jpg', mapLink:'#', titleStyle:{...defaultTitleStyle} }); break; case 'rsvp': Object.assign(newBlock.content, { title:'New RSVP Block', subtitle:'New subtitle text', titleStyle:{...defaultTitleStyle}, buttonStyle:{fontFamily:'Montserrat',fontSize:'1.1rem',color:'#FFFFFF',fontWeight:'700',backgroundColor:'#c5a98b'} }); break; case 'image': Object.assign(newBlock.content, { imageUrl:'https://i.ibb.co/8MPG7T5/800x400.png', caption:'Image caption' }); break; } return newBlock; }
    
    function createStyleControls(prefix, styleObject, options = { color: true, size: true, weight: true, family: true, textAlign: false }) { if (!styleObject) return ''; return `<div class="style-controls"> ${options.family ? `<div class="control-group"><label>Font Family</label><select data-key="${prefix}.fontFamily">${fontOptionsHTML.replace(`value="${styleObject.fontFamily}"`, `value="${styleObject.fontFamily}" selected`)}</select></div>` : ''} <div class="style-controls-grid"> ${options.size ? `<div class="control-group"><label>Font Size</label><input type="text" data-key="${prefix}.fontSize" value="${styleObject.fontSize || ''}" placeholder="e.g. 16px or 1.2rem"></div>` : ''} ${options.color ? `<div class="control-group"><label>Color</label><input type="color" data-key="${prefix}.color" value="${styleObject.color || '#000000'}"></div>` : ''} </div> <div class="style-controls-grid" style="margin-top: 10px;"> ${options.weight ? `<div class="control-group"><label>Font Weight</label><select data-key="${prefix}.fontWeight"><option value="400" ${styleObject.fontWeight == '400' ? 'selected' : ''}>Normal</option><option value="700" ${styleObject.fontWeight == '700' ? 'selected' : ''}>Bold</option></select></div>` : ''} ${options.textAlign ? `<div class="control-group"><label>Text Align</label><select data-key="${prefix}.textAlign"><option value="left" ${styleObject.textAlign == 'left' ? 'selected' : ''}>Left</option><option value="center" ${styleObject.textAlign == 'center' ? 'selected' : ''}>Center</option><option value="right" ${styleObject.textAlign == 'right' ? 'selected' : ''}>Right</option></select></div>` : ''} </div> </div>`; }
    
    const createUniversalImageInput = (label, key, value) => `<div class="control-group"><label>${label}</label><div class="image-input-group"><input type="url" data-key="${key}" value="${value||''}" placeholder="https://..."><button type="button" class="browse-image-btn" data-target-key="${key}">Browse...</button></div></div>`;
    
    function createStickerEditor(block) { const stickersHTML = (block.content.stickers || []).map((sticker, index) => `<div class="sticker-editor" data-sticker-index="${index}"><div class="sticker-editor-header"><img src="${sticker.src}" style="width:30px;height:30px;border-radius:4px;object-fit:contain;background:#ddd;"><button class="delete-sticker-btn">Delete</button></div><div class="control-group"><label>Opacity: <span class="opacity-value">${Math.round((sticker.opacity === undefined ? 1 : sticker.opacity)*100)}%</span></label><input type="range" data-key="stickers.${index}.opacity" value="${sticker.opacity === undefined ? 1 : sticker.opacity}" min="0" max="1" step="0.05"></div><div class="style-controls-grid"><div class="control-group"><label>X</label><input type="number" data-key="stickers.${index}.x" value="${Math.round(sticker.x||0)}"></div><div class="control-group"><label>Y</label><input type="number" data-key="stickers.${index}.y" value="${Math.round(sticker.y||0)}"></div></div><div class="style-controls-grid"><div class="control-group"><label>Width</label><input type="number" data-key="stickers.${index}.width" value="${Math.round(sticker.width||100)}"></div><div class="control-group"><label>Rotation</label><input type="number" data-key="stickers.${index}.rotation" value="${Math.round(sticker.rotation||0)}"></div></div></div>`).join(''); return `<hr class="style-separator"><div class="control-group"><label>Decorative Elements</label><button class="add-sticker-btn">Add Sticker</button></div><div id="sticker-editors-container">${stickersHTML}</div>`; }
    
    function createEditorFieldsForBlock(block) {
        let c = block.content;
        let fieldsHTML = '';
        const createOptional = (k, l) => c.hasOwnProperty(k) ? `<div class="control-group"><div class="optional-element-header"><label>${l}</label><label><input type="checkbox" data-key="${k}.enabled" ${c[k].enabled ? 'checked' : ''}> Show</label></div><input type="text" data-key="${k}.text" value="${c[k].text}">${createStyleControls(`${k}.style`,c[k].style)}</div>`:'';

        switch(block.type) {
            case 'hero':
                fieldsHTML += createUniversalImageInput('Background Image URL', 'imageUrl', c.imageUrl);
                fieldsHTML += createOptional('names', 'Names');
                fieldsHTML += '<hr class="style-separator">';
                fieldsHTML += createOptional('subtitle', 'Subtitle');
                fieldsHTML += '<hr class="style-separator">';
                fieldsHTML += createOptional('date', 'Date');
                fieldsHTML += '<hr class="style-separator">';
                fieldsHTML += `<div class="control-group"><label>Background Focus Point</label><input type="text" data-key="backgroundPosition" value="${c.backgroundPosition || 'center center'}" placeholder="e.g., center 30%"></div>`;
                fieldsHTML += `<div class="control-group"><label>Block Shape (Height)</label><select data-key="aspectRatio"><option value="21/9" ${c.aspectRatio==='21/9'?'selected':''}>Cinematic</option><option value="16/9" ${c.aspectRatio==='16/9'?'selected':''}>Widescreen</option><option value="8/5" ${c.aspectRatio==='8/5'?'selected':''}>Landscape (Wide)</option><option value="3/2" ${c.aspectRatio==='3/2'?'selected':''}>Landscape (Classic)</option><option value="4/3" ${c.aspectRatio==='4/3'?'selected':''}>Standard (4:3)</option><option value="1/1" ${c.aspectRatio==='1/1'?'selected':''}>Square</option><option value="9/12" ${c.aspectRatio==='9/12'?'selected':''}>Portrait (Standard)</option><option value="9/16" ${c.aspectRatio==='9/16'?'selected':''}>Portrait (Tall)</option></select></div>`;
                break;
            case 'text-block':
                fieldsHTML += `<div class="control-group"><label>Title (optional)</label><input type="text" data-key="title" value="${c.title || ''}"></div>`;
                if(c.titleStyle) fieldsHTML += `<label>Title Style</label>${createStyleControls('titleStyle', c.titleStyle, {textAlign:true,color:true,size:true,weight:true,family:true})}`;
                fieldsHTML += '<hr class="style-separator">';
                fieldsHTML += `<div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${c.text || ''}</textarea></div>`;
                if(c.textStyle) fieldsHTML += createStyleControls('textStyle', c.textStyle, {textAlign:true,color:true,size:true,weight:true,family:true});
                break;
            case 'image':
                fieldsHTML += createUniversalImageInput('Image URL', 'imageUrl', c.imageUrl);
                fieldsHTML += `<div class="control-group"><label>Caption</label><input type="text" data-key="caption" value="${c.caption || ''}"></div>`;
                break;
            case 'location':
                fieldsHTML += `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>`;
                if(c.titleStyle) fieldsHTML += `<label>Title Style</label>${createStyleControls('titleStyle', c.titleStyle, {textAlign:true,color:true,size:true,weight:true,family:true})}`;
                fieldsHTML += '<hr class="style-separator">';
                fieldsHTML += `<div class="control-group"><label>Address</label><textarea data-key="address">${c.address || ''}</textarea></div>`;
                fieldsHTML += createUniversalImageInput('Photo URL', 'imageUrl', c.imageUrl);
                fieldsHTML += `<div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${c.mapLink || ''}"></div>`;
                break;
            case 'schedule':
                fieldsHTML += `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>`;
                if(c.titleStyle) fieldsHTML += `<label>Title Style</label>${createStyleControls('titleStyle', c.titleStyle, {textAlign:true,color:true,size:true,weight:true,family:true})}`;
                // Add editor for schedule items here
                break;
            case 'countdown':
                fieldsHTML += `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>`;
                if(c.titleStyle) fieldsHTML += `<label>Title Style</label>${createStyleControls('titleStyle', c.titleStyle, {textAlign:true,color:true,size:true,weight:true,family:true})}`;
                fieldsHTML += `<hr class="style-separator"><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${c.targetDate || ''}"></div>`;
                break;
            case 'rsvp':
                fieldsHTML += `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${c.title || ''}"></div>`;
                if(c.titleStyle) fieldsHTML += `<label>Title Style</label>${createStyleControls('titleStyle', c.titleStyle, {textAlign:true,color:true,size:true,weight:true,family:true})}`;
                fieldsHTML += `<hr class="style-separator"><div class="control-group"><label>Subtitle</label><textarea data-key="subtitle">${c.subtitle||''}</textarea></div>`;
                if(c.buttonStyle) fieldsHTML += `<hr class="style-separator"><label>Button Style</label><div class="style-controls"><div class="style-controls-grid"><div class="control-group"><label>Background Color</label><input type="color" data-key="buttonStyle.backgroundColor" value="${c.buttonStyle.backgroundColor||'#c5a98b'}"></div><div class="control-group"><label>Text Color</label><input type="color" data-key="buttonStyle.color" value="${c.buttonStyle.color||'#FFFFFF'}"></div></div><div style="margin-top:10px;">${createStyleControls('buttonStyle',c.buttonStyle,{color:false,size:true,weight:true,family:true})}</div></div>`;
                break;
        }
        return fieldsHTML + createStickerEditor(block);
    }
    
    function renderEditor() { const container = document.getElementById('editor-content'); const currentlyOpen = [...container.querySelectorAll('.editor-block-content.is-open')].map(el => el.closest('.editor-block').dataset.id); container.innerHTML = ''; pageBlocks.forEach(block => { const tpl = document.getElementById('editor-block-template').content.cloneNode(true); const editorBlock = tpl.querySelector('.editor-block'); editorBlock.dataset.id = block.id; editorBlock.querySelector('.editor-block-title').textContent = block.type.charAt(0).toUpperCase() + block.type.slice(1).replace(/-/g, ' '); const contentDiv = editorBlock.querySelector('.editor-block-content'); contentDiv.innerHTML = createEditorFieldsForBlock(block); if (currentlyOpen.includes(block.id)) { contentDiv.classList.add('is-open'); editorBlock.querySelector('.toggle-btn').textContent = '▲'; } container.appendChild(tpl); }); }
    
    async function uploadToImgBB(file) { if (!IMGBB_API_KEY) { alert('Error: ImgBB API Key could not be loaded. Please check server configuration and refresh.'); return null; } const statusEl = document.getElementById('upload-status'); statusEl.textContent = 'Uploading...'; const formData = new FormData(); formData.append('image', file); try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const data = await response.json(); if (data.success) { statusEl.textContent = 'Upload successful!'; return data.data.url; } else { throw new Error(data.error.message || 'Unknown error'); } } catch (error) { statusEl.textContent = `Upload failed: ${error.message}`; return null; } }
    
    let imageTarget = { blockId: null, key: null, isSticker: false }; 
    const imageLibraryModal = document.getElementById('image-library-modal'); 
    function openImageLibrary(target) { imageTarget = target; document.getElementById('upload-status').textContent = ''; imageLibraryModal.classList.add('is-visible'); }
    
    function handleImageSelection(src) { const {blockId, key, isSticker} = imageTarget; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; if (isSticker) { const newSticker = { id: `sticker-${Date.now()}`, src, x: 20, y: 20, width: 150, rotation: 0, opacity: 1 }; if (!pageBlocks[blockIndex].content.stickers) pageBlocks[blockIndex].content.stickers = []; pageBlocks[blockIndex].content.stickers.push(newSticker); } else { const keys = key.split('.'); let current = pageBlocks[blockIndex].content; for (let i = 0; i < keys.length - 1; i++) { current = current[keys[i]]; } current[keys[keys.length - 1]] = src; } renderEditor(); renderPreview(); imageLibraryModal.classList.remove('is-visible'); }
    
    function setupEventListeners() { const editorContent = document.getElementById('editor-content'); const handleEditorChange = e => { const target = e.target; const blockDiv = target.closest('.editor-block'); if (!blockDiv) return; const blockId = blockDiv.dataset.id; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; const key = target.dataset.key; if (key) { let value = target.type === 'checkbox' ? target.checked : target.value; if (target.type === 'number' || target.type === 'range') value = parseFloat(value) || 0; const keys = key.split('.'); let current = pageBlocks[blockIndex].content; for (let i = 0; i < keys.length - 1; i++) { current = current[keys[i]] = current[keys[i]] || {}; } current[keys[keys.length - 1]] = value; } renderPreview(); }; editorContent.addEventListener('input', e => { if (e.target.type === 'range' && e.target.dataset.key.includes('opacity')) { const label = e.target.closest('.control-group').querySelector('label'); if (label?.querySelector('.opacity-value')) label.querySelector('.opacity-value').textContent = `${Math.round(e.target.value*100)}%`; } handleEditorChange(e); }); editorContent.addEventListener('change', handleEditorChange); editorContent.addEventListener('click', e => { const target = e.target; const blockDiv = target.closest('.editor-block'); if (!blockDiv) return; const blockId = blockDiv.dataset.id; if (target.matches('.browse-image-btn')) { openImageLibrary({blockId, key: target.dataset.targetKey, isSticker: false}); } else if (target.matches('.add-sticker-btn')) { openImageLibrary({blockId, key: null, isSticker: true}); } else if (target.matches('.delete-sticker-btn')) { const blockIndex = pageBlocks.findIndex(b => b.id === blockId); const stickerIndex = parseInt(target.closest('.sticker-editor').dataset.stickerIndex, 10); pageBlocks[blockIndex].content.stickers.splice(stickerIndex, 1); renderEditor(); renderPreview(); } else if (target.closest('.delete-block-btn')) { if (confirm('Are you sure?')) { const blockIndex = pageBlocks.findIndex(b => b.id === blockId); pageBlocks.splice(blockIndex, 1); renderEditor(); renderPreview(); } } else if (target.closest('.editor-block-header')) { const content = blockDiv.querySelector('.editor-block-content'); if (content) { content.classList.toggle('is-open'); blockDiv.querySelector('.toggle-btn').textContent = content.classList.contains('is-open') ? '▲' : '▼'; } } }); document.querySelectorAll('#add-block-modal .modal-close, #image-library-modal .modal-close').forEach(b => b.addEventListener('click', e => e.target.closest('.modal-overlay').classList.remove('is-visible'))); document.getElementById('add-block-btn').addEventListener('click', () => document.getElementById('add-block-modal').classList.add('is-visible')); document.getElementById('add-block-options').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { const newBlock = getNewBlockData(e.target.dataset.type); pageBlocks.push(newBlock); renderEditor(); renderPreview(); document.getElementById('add-block-modal').classList.remove('is-visible'); } }); document.getElementById('image-upload-input').addEventListener('change', async e => { if (e.target.files.length > 0) { const src = await uploadToImgBB(e.target.files[0]); if (src) handleImageSelection(src); } }); document.querySelectorAll('.library-item').forEach(item => item.addEventListener('click', () => handleImageSelection(item.dataset.src))); const globalStyleSelect = document.getElementById('global-style-select'); const globalBgGroup = document.getElementById('global-bg-image-group'); globalStyleSelect.addEventListener('change', () => { pageSettings.style = globalStyleSelect.value; globalBgGroup.style.display = pageSettings.style === 'modern' ? 'block' : 'none'; renderPreview(); }); const globalWidthInput = document.getElementById('global-width-input'); globalWidthInput.addEventListener('input', () => { pageSettings.maxWidth = globalWidthInput.value; renderPreview(); }); }
    
    function renderPreview() { if (iframe.contentWindow?.renderPage) iframe.contentWindow.renderPage(pageBlocks, pageSettings); }
    function saveCurrentPageData() { const data = { settings: JSON.parse(JSON.stringify(pageSettings)), blocks: JSON.parse(JSON.stringify(pageBlocks)) }; if (currentTemplate === mainPageData.template) { mainPageData = {...mainPageData, ...data}; } else { rsvpFormData = {...rsvpFormData, ...data}; } }
    function switchEditorMode(target) { currentTemplate = target.template; pageSettings = JSON.parse(JSON.stringify(target.settings)); pageBlocks = JSON.parse(JSON.stringify(target.blocks)); document.getElementById('global-width-input').value = pageSettings.maxWidth; document.getElementById('global-style-select').value = pageSettings.style; const bgGroup = document.getElementById('global-bg-image-group'); bgGroup.innerHTML = createUniversalImageInput('Background Image URL', 'backgroundImage', pageSettings.backgroundImage); bgGroup.style.display = pageSettings.style === 'modern' ? 'block' : 'none'; iframe.src = `templates/${target.template}?v=${Date.now()}`; document.getElementById('edit-main-btn').classList.toggle('active', currentTemplate === mainPageData.template); document.getElementById('edit-rsvp-btn').classList.toggle('active', currentTemplate === rsvpFormData.template); iframe.onload = () => { renderEditor(); renderPreview(); setupResizeObserver(); }; }
    function initSortable() { const c = document.getElementById('editor-content'); Sortable.create(c, { handle: '.drag-handle', animation: 150, onEnd: (evt) => { const item = pageBlocks.splice(evt.oldIndex, 1)[0]; pageBlocks.splice(evt.newIndex, 0, item); renderPreview(); } }); }
    let resizeObserver; function setupResizeObserver() { if (resizeObserver) resizeObserver.disconnect(); const body = iframe.contentWindow.document.body; if (!body) return; resizeObserver = new ResizeObserver(() => { iframe.style.height = body.scrollHeight + 'px'; }); resizeObserver.observe(body); iframe.style.height = body.scrollHeight + 'px'; }

    async function initEditor() { const statusText = document.getElementById('status-text'); try { statusText.textContent = 'Initializing editor...'; const response = await fetch('/.netlify/functions/get-api-keys'); if (!response.ok) throw new Error('Could not fetch API keys from server.'); const keys = await response.json(); IMGBB_API_KEY = keys.imgbb; if (!IMGBB_API_KEY) { statusText.textContent = 'Warning: Image upload disabled.'; } else { statusText.textContent = ''; } } catch (error) { console.error(error); statusText.textContent = 'Error initializing editor.'; alert('CRITICAL ERROR: Could not load configuration.'); return; } window.addEventListener('message', e => { if (e.source !== iframe.contentWindow) return; const {type, payload} = e.data; if (type === 'UPDATE_STICKER') { const {blockId, stickerId, newProps} = payload; const blockIndex = pageBlocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return; const stickerIndex = pageBlocks[blockIndex].content.stickers.findIndex(s => s.id === stickerId); if (stickerIndex === -1) return; Object.assign(pageBlocks[blockIndex].content.stickers[stickerIndex], newProps); renderEditor(); } }); setupEventListeners(); initSortable(); const params = new URLSearchParams(window.location.search); const id = params.get('id'); if (id) { /* load data from server */ } else { switchEditorMode(mainPageData); } }
    
    initEditor();
    </script>
</body>
</html>