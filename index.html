<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Allura&family=Sacramento&family=Alex+Brush&family=Satisfy&family=Kaushan+Script&family=Pacifico&family=Caveat:wght@400;700&family=Cookie&family=Playfair+Display:wght@400;700&family=Crimson+Text:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=EB+Garamond:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Vollkorn:wght@400;700&family=Cinzel:wght@400;700&family=Abril+Fatface&family=Amatic+SC:wght@400;700&family=Fredoka+One&family=Lobster&family=Montserrat:wght@300;400;700&family=Raleway:wght@300;400;700&family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root{--accent-color:#c5a98b;--background-color:#f8f7f5}
        body{margin:0;font-family:'Montserrat',sans-serif;line-height:1.7;background-color:var(--background-color);color:#333;background-size: cover; background-position: center; background-attachment: fixed;}
        main { transition: opacity 1s ease-in-out; }
        .block-wrapper { position: relative; }
        .content-section{background: #fff; margin: 30px auto; padding: 50px 20px; text-align: center; border-radius: 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); box-sizing: border-box;}
        #page-content > .block-wrapper:first-child > .content-section, 
        #page-content > .hero-block { margin-top: 0; border-radius: 0; }
        .hero-block + .block-wrapper .content-section { margin-top: 30px; border-radius: 8px; }
        h1,h2,h3{ text-align:center; margin: 15px 0; }
        p { margin: 15px 0; }
        .hero-block { display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; overflow: hidden; width: 100%; user-select: none; }
        .hero-background-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; pointer-events: none; }
        .hero-block::before{ content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.4); z-index: 1; pointer-events: none;}
        .hero-content{ position:relative; z-index: 2; width: 90%; max-width: 1000px; padding: 40px 0; pointer-events: none;}
        .hero-content h1, .hero-content p, .hero-content h3 { margin: 10px 0; line-height: 1.3; }
        .style-modern .content-section {background: rgba(255, 255, 255, 0.85); box-shadow: none; }
        .text-block-content p { white-space: pre-wrap; }
        .sticker-wrapper { position: absolute; box-sizing: border-box; z-index: 5; touch-action: none; }
        .sticker-wrapper img { width: 100%; height: 100%; display: block; pointer-events: none; }
        .sticker-wrapper.selected { outline: 2px solid #007bff; }
        .sticker-wrapper .resize-handle { position: absolute; width: 12px; height: 12px; background: #fff; border: 1px solid #007bff; border-radius: 50%; display: none; }
        .sticker-wrapper.selected .resize-handle { display: block; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .sticker-wrapper .rotate-handle { position: absolute; top: -30px; left: calc(50% - 8px); width: 16px; height: 16px; background: #fff; border: 1px solid #007bff; border-radius: 50%; cursor: grab; display: none; }
        .sticker-wrapper .rotate-handle::before { content: ''; position: absolute; top: -15px; left: 50%; width: 1px; height: 15px; background: #007bff; transform: translateX(-50%); }
        .sticker-wrapper.selected .rotate-handle { display: block; }
        .rsvp-button{display:inline-block; padding:15px 30px;text-decoration:none;border-radius:50px;transition:transform .2s ease; margin: 10px;}
        .rsvp-button:hover{transform:scale(1.05)}
        #countdown{display:flex;justify-content:center;gap:20px;text-align:center}
        .time-block{background:#f4f4f4;padding:20px;border-radius:5px;min-width:80px}
        .time-block .number{font-size:2.5rem;font-weight:700;color:var(--accent-color)}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</head>
<body>
    <main id="page-content"></main>
    <script>
    const getStyleString = (style) => { if (!style) return ''; let str = ''; if (style.fontFamily) str += `font-family: '${style.fontFamily}', sans-serif; `; if (style.fontSize) str += `font-size: ${style.fontSize}; `; if (style.color) str += `color: ${style.color}; `; if (style.fontWeight) str += `font-weight: ${style.fontWeight}; `; if (style.textAlign) str += `text-align: ${style.textAlign}; `; if (style.backgroundColor) str += `background-color: ${style.backgroundColor}; `; return str; };
    const renderStickers = (stickers) => { if (!stickers || stickers.length === 0) return ''; return stickers.map(s => `<div class="sticker-wrapper" data-sticker-id="${s.id}" style="opacity: ${s.opacity === undefined ? 1 : s.opacity}; left: ${s.x || 0}px; top: ${s.y || 0}px; width: ${s.width || 150}px; transform: rotate(${s.rotation || 0}deg);"> <img src="${s.src}" alt="sticker"> <div class="rotate-handle"></div> <div class="resize-handle se"></div> </div>`).join(''); };
    
    const createBlockHTML = (block, settings, rsvpLink) => {
        const c = block.content;
        let innerHTML = '';
        const wrapperClass = block.type === 'hero' ? 'hero-block block-wrapper' : 'block-wrapper';
        const wrapperStyle = block.type === 'hero' ? `aspect-ratio:${c.aspectRatio||'16/9'};` : '';
        const sectionStyle = `max-width:${settings.maxWidth || '800px'};`;

        switch(block.type) {
            case 'hero':
                const subtitle = (c.subtitle?.enabled) ? `<p style="${getStyleString(c.subtitle.style)}">${c.subtitle.text}</p>` : '';
                const names = (c.names?.enabled) ? `<h1 style="${getStyleString(c.names.style)}">${c.names.text}</h1>` : '';
                const date = (c.date?.enabled) ? `<p style="${getStyleString(c.date.style)}">${c.date.text}</p>` : '';
                innerHTML = `<img class="hero-background-image" src="${c.imageUrl}" style="object-position:${c.backgroundPosition || 'center center'};"> <div class="hero-content">${subtitle}${names}${date}</div>`;
                break;
            case 'text-block':
                innerHTML = `<section class="content-section" style="${sectionStyle}">${c.title ? `<h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2>` : ''}<div class="text-block-content"><p style="${getStyleString(c.textStyle)}">${(c.text || '').replace(/\n/g, '<br>')}</p></div></section>`;
                break;
            case 'image':
                innerHTML = `<section class="content-section" style="${sectionStyle}"><figure><img src="${c.imageUrl}" alt="${c.caption}"><figcaption>${c.caption}</figcaption></figure></section>`;
                break;
            case 'location':
                innerHTML = `<section class="content-section" style="${sectionStyle}">${c.title ? `<h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2>` : ''}<p>${(c.address||'').replace(/\n/g, '<br>')}</p>${c.imageUrl ? `<img src="${c.imageUrl}" alt="Venue">`: ''}<a href="${c.mapLink}" class="rsvp-button" target="_blank">View on Map</a></section>`;
                break;
            case 'rsvp':
                innerHTML = `<section class="content-section" style="${sectionStyle}">${c.title ? `<h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2>` : ''}<p>${(c.subtitle||'').replace(/\n/g, '<br>')}</p><a href="${rsvpLink}" class="rsvp-button" style="${getStyleString(c.buttonStyle)}">I'll Be There!</a></section>`;
                break;
            case 'countdown':
                 innerHTML = `<section class="content-section" style="${sectionStyle}">${c.title ? `<h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2>` : ''}<div id="countdown"><div class="time-block"><span id="days" class="number">00</span><span>Days</span></div><div class="time-block"><span id="hours" class="number">00</span><span>Hours</span></div><div class="time-block"><span id="minutes" class="number">00</span><span>Minutes</span></div><div class="time-block"><span id="seconds" class="number">00</span><span>Seconds</span></div></div></section>`;
                 break;
            case 'schedule':
                let itemsHTML = (c.items || []).map(item => `<li>...</li>`).join(''); // Simplified
                innerHTML = `<section class="content-section" style="${sectionStyle}">${c.title ? `<h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2>` : ''}<ul>${itemsHTML}</ul></section>`;
                break;
            default:
                innerHTML = `<section class="content-section" style="${sectionStyle}">Unsupported block type: ${block.type}</section>`;
        }
        return `<div class="${wrapperClass}" data-block-id="${block.id}" style="${wrapperStyle}">${innerHTML}${renderStickers(c.stickers)}</div>`;
    };

    function renderPage(blocks, settings, rsvpLink = '#') {
        if (!blocks || !settings) return;
        document.body.className = '';
        if (settings.style) document.body.classList.add(`style-${settings.style}`);
        document.body.style.backgroundImage = (settings.style === 'modern' && settings.backgroundImage) ? `url('${settings.backgroundImage}')` : 'none';
        
        const container = document.getElementById('page-content');
        container.innerHTML = blocks.map(block => createBlockHTML(block, settings, rsvpLink)).join('');
        
        if (window.self !== window.top) {
            setTimeout(() => initStickerInteraction(), 100);
        }
    }
    
    function initStickerInteraction() {
        if (typeof interact === 'undefined') return;

        interact('.sticker-wrapper').on('tap', event => { document.querySelectorAll('.sticker-wrapper').forEach(el => el.classList.remove('selected')); event.currentTarget.classList.add('selected'); event.stopPropagation(); });
        document.body.addEventListener('click', () => document.querySelectorAll('.sticker-wrapper').forEach(el => el.classList.remove('selected')));
        
        interact('.sticker-wrapper').draggable({
            listeners: {
                start(event) {
                    const target = event.target;
                    const rect = target.getBoundingClientRect();
                    target.dataset.x = rect.left - target.parentElement.getBoundingClientRect().left;
                    target.dataset.y = rect.top - target.parentElement.getBoundingClientRect().top;
                },
                move(event) {
                    const target = event.target;
                    const x = (parseFloat(target.dataset.x) || 0) + event.dx;
                    const y = (parseFloat(target.dataset.y) || 0) + event.dy;
                    target.style.left = `${x}px`;
                    target.style.top = `${y}px`;
                    target.dataset.x = x;
                    target.dataset.y = y;
                },
                end(event) {
                    const blockId = event.target.closest('.block-wrapper').dataset.blockId;
                    const newProps = { x: parseFloat(event.target.dataset.x), y: parseFloat(event.target.dataset.y) };
                    window.parent.postMessage({ type: 'UPDATE_STICKER', payload: { blockId, stickerId: event.target.dataset.stickerId, newProps } }, '*');
                }
            },
            modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })]
        }).resizable({
            edges: { right: '.se', bottom: '.se' },
            listeners: {
                move(event) {
                    const target = event.target;
                    target.style.width = `${event.rect.width}px`;
                    target.style.height = 'auto';
                },
                end(event) {
                    const blockId = event.target.closest('.block-wrapper').dataset.blockId;
                    const newProps = { width: event.rect.width };
                    window.parent.postMessage({ type: 'UPDATE_STICKER', payload: { blockId, stickerId: event.target.dataset.stickerId, newProps } }, '*');
                }
            },
            modifiers: [interact.modifiers.aspectRatio({ ratio: 'preserve' })]
        });
    }
    </script>
</body>
</html>