<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } 
        body { margin: 0; background-color: #f0f2f5; overflow: hidden; }
        
        /* Mobile responsive layout */
        @media (max-width: 768px) {
            body { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto 1fr; 
            }
            #editor-panel { 
                grid-column: 1; 
                grid-row: 1;
                height: auto; 
                position: relative;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            #preview-panel { 
                grid-column: 1; 
                grid-row: 2;
                padding: 10px; 
            }
            .mobile-toggle {
                display: block !important;
                background: #007bff;
                color: white;
                border: none;
                padding: 10px;
                width: 100%;
                font-size: 16px;
                cursor: pointer;
            }
            #editor-content.mobile-hidden {
                display: none;
            }
            #editor-footer.mobile-hidden {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-toggle { display: none; }
        }
        
    #editor-panel {
        width: 420px;
        background-color: #fff;
        border-right: 1px solid #ddd;
        height: 100vh;
        overflow-y: auto;
        position: fixed;
        top: 0;
        left: 0;
    }
    #preview-panel { padding: 20px; box-sizing: border-box; display: flex; justify-content: center; margin-left: 420px; height: 100vh; overflow-y: auto; } 
    #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; position: relative; } 
    iframe { width: 100%; height: 100%; border: none; display: block; } 
        
        /* Text editing toolbar */
        #text-editing-toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 90%;
        }
        
        #text-editing-toolbar.visible {
            display: flex;
        }
        
        #text-editing-toolbar label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
            display: block;
        }
        
        #text-editing-toolbar select,
        #text-editing-toolbar input {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        
        #text-editing-toolbar .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } 
        #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } 
        #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } 
        #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } 
        .global-settings { margin-top: 15px; } 
        #editor-content { flex-grow: 1; overflow-y: auto; min-height: 0; padding: 20px; }
        #editor-footer { padding: 20px; border-top: 1px solid #eee; } 
        
        .mobile-toggle { display: none; }
        
        .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } 
        .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } 
        .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } 
        .editor-block-title { font-weight: bold; flex-grow: 1; } 
        .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } 
        .delete-block-btn { color: crimson !important; } 
        .editor-block-content { padding: 15px; display: none; } 
        .editor-block-content.is-open { display: block; }
        
        .control-group { margin-bottom: 15px; } 
        .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } 
        .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; } 
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } 
        input.smart-location-search { border-left: 4px solid #28a745; } 
        textarea { min-height: 80px; }
        
        .style-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; } 
        .style-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; } 
        .style-controls .control-group { margin-bottom: 0; } 
        input[type="color"] { padding: 2px; min-height: 38px; } 
        .style-controls label { font-size: 0.9em; font-weight: 600; color: #555; } 
        hr.style-separator { border: none; border-top: 1px dashed #ccc; margin: 15px 0; }
        
        .optional-element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } 
        .optional-element-header label { margin-bottom: 0; }
        
        .sticker-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #6f42c1; } 
        .sticker-editor-header { display: flex; justify-content: space-between; align-items: center; } 
        .sticker-editor .control-group { margin-bottom: 8px; } 
        .sticker-editor .control-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 3px; } 
        .delete-sticker-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-weight: bold; cursor: pointer; }
        
        .inner-blocks-container { border-top: 2px solid #007bff; margin-top: 20px; padding-top: 15px; } 
        .inner-block-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid #007bff; } 
        .inner-block-editor .delete-inner-block-btn { float: right; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; line-height: 22px; text-align: center; } 
        .add-inner-block-controls button { background-color: #e9ecef; border: 1px dashed #ccc; padding: 8px; margin-right: 5px; cursor: pointer; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } 
        .modal-overlay.is-visible { display: flex; } 
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; } 
        .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; } 
        #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px; }
        
        .image-input-group { display: flex; gap: 8px; align-items: stretch; } 
        .image-input-group input[type="url"] { flex: 1; } 
        .browse-image-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px; } 
        .browse-image-btn:hover { background: #0056b3; }
        
        .image-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; } 
        .image-library-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: border-color 0.2s; } 
        .image-library-item:hover { border-color: #007bff; } 
        .image-library-item img { width: 100%; height: 80px; object-fit: cover; display: block; }
        
        .upload-section { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; } 
        .upload-section.dragover { border-color: #007bff; background-color: #f8f9fa; } 
        .upload-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; } 
        .upload-btn:hover { background: #218838; }
        
        .opacity-control { margin-top: 10px; } 
        .opacity-slider { width: 100%; margin-top: 5px; }
        
        .schedule-item-editor { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin-bottom: 15px; } 
        .schedule-item-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } 
        .schedule-item-editor-header h4 { margin: 0; flex-grow: 1; } 
        .delete-schedule-item-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <!-- Text Editing Toolbar -->
    <div id="text-editing-toolbar">
        <div class="toolbar-group">
            <label>Font Family</label>
            <select id="toolbar-font-family">
                <optgroup label="Script/Handwritten">
                    <option value="Great Vibes">Great Vibes</option>
                    <option value="Dancing Script">Dancing Script</option>
                    <option value="Allura">Allura</option>
                </optgroup>
                <optgroup label="Elegant Serif">
                    <option value="Playfair Display">Playfair Display</option>
                    <option value="Crimson Text">Crimson Text</option>
                </optgroup>
                <optgroup label="Modern Sans-Serif">
                    <option value="Montserrat">Montserrat</option>
                    <option value="Raleway">Raleway</option>
                </optgroup>
            </select>
        </div>
        <div class="toolbar-group">
            <label>Size</label>
            <input type="text" id="toolbar-font-size" placeholder="16px">
        </div>
        <div class="toolbar-group">
            <label>Color</label>
            <input type="color" id="toolbar-color">
        </div>
        <div class="toolbar-group">
            <label>Weight</label>
            <select id="toolbar-font-weight">
                <option value="400">Normal</option>
                <option value="700">Bold</option>
            </select>
        </div>
        <div class="toolbar-group">
            <label>Align</label>
            <select id="toolbar-text-align">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
            </select>
        </div>
    </div>

    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('is-visible')">×</span>
            <div id="instruction-content"></div>
        </div>
    </div>

    <div id="editor-panel"> 
        <div id="editor-header">
            <h2>Editor</h2>
            <div class="template-switcher">
                <button id="edit-main-btn" class="active">Invitation</button>
                <button id="edit-rsvp-btn">RSVP Form</button>
            </div>
            <div class="api-settings" style="margin-top: 15px;">
                <div class="control-group">
                    <label for="sheetdb-api-input">SheetDB API URL</label>
                    <input type="url" id="sheetdb-api-input" placeholder="Paste your SheetDB API URL here...">
                </div>
            </div>
            <div class="global-settings">
                <div class="control-group">
                    <label for="global-style-select">Page Style</label>
                    <select id="global-style-select">
                        <option value="classic">Classic (Cards)</option>
                        <option value="modern">Modern (Shared Background)</option>
                    </select>
                </div>
                <div class="control-group" id="global-bg-image-group">
                    <label for="global-bg-image-input">Background Image URL</label>
                    <div class="image-input-group">
                        <input type="url" id="global-bg-image-input" placeholder="https://images.unsplash.com/photo-...">
                        <button type="button" class="browse-image-btn" onclick="openImageLibrary('global-bg-image-input')">Browse...</button>
                    </div>
                </div>
                <div class="control-group">
                    <label for="global-bg-color-input">Page Background Color</label>
                    <input type="color" id="global-bg-color-input" value="#f8f7f5">
                </div>
                <div class="control-group">
                    <label for="global-width-input">Global Block Width</label>
                    <input type="text" id="global-width-input" placeholder="e.g., 800px or 90%">
                </div>
            </div>
        </div> 
        <div id="editor-content"></div> 
        <div id="editor-footer">
            <button id="add-block-btn" style="width: 100%; padding: 12px; font-size: 16px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">+ Add New Block</button>
            <button id="share-button" style="width: 100%; padding: 12px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Generate & Copy Link</button>
            <p id="status-text" style="text-align:center; margin-top:10px;"></p>
        </div> 
    </div> 
    
    <div id="preview-panel">
        <div id="preview-wrapper">
            <iframe id="preview-frame" scrolling="no"></iframe>
        </div>
    </div> 
    
    <template id="editor-block-template">
        <div class="editor-block">
            <div class="editor-block-header">
                <span class="drag-handle">☰</span>
                <span class="editor-block-title">Block Title</span>
                <div class="editor-block-controls">
                    <button class="toggle-btn">▼</button>
                    <button class="delete-block-btn" title="Delete Block">×</button>
                </div>
            </div>
            <div class="editor-block-content"></div>
        </div>
    </template> 
    
    <div id="add-block-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">×</span>
            <h3>Choose a Block to Add</h3>
            <div id="add-block-options">
                <button data-type="hero">Hero</button>
                <button data-type="text-block">Text Block</button>
                <button data-type="image">Image</button>
                <hr>
                <button data-type="schedule">Schedule</button>
                <button data-type="location">Location</button>
                <button data-type="countdown">Countdown</button>
                <button data-type="rsvp">RSVP Button</button>
                <hr>
                <button data-type="form-header">Form: Header</button>
                <button data-type="input-question">Form: Text Input</button>
                <button data-type="textarea-question">Form: Text Area</button>
                <button data-type="radio-question">Form: Radio Choice</button>
                <button data-type="form-footer">Form: Footer</button>
            </div>
        </div>
    </div>

    <div id="image-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeImageLibrary()">×</span>
            <h3>Image Library</h3>
            <div class="image-library-grid" id="image-library-grid"></div>
        </div>
    </div>

    <div id="element-library-modal" class="modal-overlay">
         <div class="modal-content">
            <span class="modal-close" onclick="closeElementLibrary()">×</span>
            <h3>Element Library</h3>
            <div class="image-library-grid" id="element-library-grid"></div>
        </div>
    </div>
    
    <script>
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; 
    let pageSettings = {}; 
    let currentTemplate = '';
    let sheetDbApiUrl = '';
    let apiKeys = {}; 
    let currentImageTarget = null; 
    let currentElementBlock = null; 
    let currentEditingElement = null;
    
    const defaultTextStyle = { fontFamily: 'Montserrat', fontSize: '1rem', color: '#333333', fontWeight: '400', textAlign: 'center' };
    const defaultTitleStyle = { fontFamily: 'Playfair Display', fontSize: '2.2rem', color: '#111111', fontWeight: '700', textAlign: 'center' };

    let mainPageData = { 
        template: 'wedding-classic.html', 
        settings: { 
            maxWidth: '800px', 
            style: 'classic', 
            backgroundImage: '', 
            backgroundColor: '#f8f7f5',
        }, 
        blocks: [ 
            { 
                type: 'hero', 
                id: `block-${Date.now()}-1`, 
                content: { 
                    subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    names: { text: 'John & Jane', enabled: true, style: { fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    date: { text: 'September 15, 2025', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, 
                    imageUrl: 'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?q=80&w=2069&auto=format&fit=crop', 
                    backgroundPosition: 'center 30%', 
                    aspectRatio: '9/16', 
                    opacity: 1, 
                    innerBlocks: [], 
                    stickers: [], 
                    fullWidth: true,
                }
            }, 
            { 
                type: 'countdown', 
                id: `block-${Date.now()}-2`, 
                content: { 
                    title: 'Until Our Big Day', 
                    targetDate: '2025-09-15T16:00', 
                    titleStyle: { ...defaultTitleStyle },
                    numberStyle: { fontFamily: 'Playfair Display', fontSize: '2.5rem', color: '#111111', fontWeight: '700' },
                    labelStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' },
                    stickers: [],
                    innerBlocks: [],
                }
            }, 
            { 
                type: 'schedule', 
                id: `block-${Date.now()}-4`, 
                content: { 
                    title: "The Day's Schedule", 
                    items: [
                        { id: `item-${Date.now()}-1`, time: '3:00 PM', title: 'Ceremony', desc: 'Join us for the wedding ceremony at the Grand Hall.', timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } }, 
                        { id: `item-${Date.now()}-2`, time: '5:00 PM', title: 'Reception', desc: 'Dinner, dancing, and celebration!', timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } }
                    ], 
                    titleStyle: { ...defaultTitleStyle, color: '#3BAA71' }, 
                    stickers: [],
                    innerBlocks: [],
                }
            }, 
            { 
                type: 'location', 
                id: `block-${Date.now()}-5`, 
                content: { 
                    title: 'Venue', 
                    address: 'The Grand Hall, 123 Celebration Ave, New York', 
                    imageUrl: 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', 
                    opacity: 1, 
                    mapLink: 'https://maps.google.com', 
                    titleStyle: { ...defaultTitleStyle }, 
                    addressStyle: { ...defaultTextStyle },
                    stickers: [],
                    innerBlocks: [],
                }
            }, 
            { 
                type: 'rsvp', 
                id: `block-${Date.now()}-6`, 
                content: { 
                    title: 'Confirm Your Attendance', 
                    subtitle: 'Please reply by September 1st.', 
                    titleStyle: { ...defaultTitleStyle }, 
                    subtitleStyle: { ...defaultTextStyle },
                    buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' }, 
                    stickers: [],
                    innerBlocks: [],
                }
            } 
        ] 
    };
    
    let rsvpFormData = { 
        template: 'rsvp-form.html', 
        settings: { maxWidth: '800px', style: 'classic', backgroundImage: '', backgroundColor: '#f8f7f5' }, 
        blocks: [] 
    };
    
    const fontOptionsHTML = `<optgroup label="Script/Handwritten"><option value="Great Vibes">Great Vibes</option><option value="Dancing Script">Dancing Script</option><option value="Allura">Allura</option></optgroup><optgroup label="Elegant Serif"><option value="Playfair Display">Playfair Display</option><option value="Crimson Text">Crimson Text</option></optgroup><optgroup label="Modern Sans-Serif"><option value="Montserrat">Montserrat</option><option value="Raleway">Raleway</option></optgroup>`;
    
    const predefinedImages = [ /* ... same as before ... */ ];
    const predefinedElements = [ /* ... same as before ... */ ];

    function showTextEditingToolbar(blockId, elementKey, currentStyle) { /* ... same as before ... */ }
    function hideTextEditingToolbar() { /* ... same as before ... */ }
    function setupToolbarEventListeners() { /* ... same as before ... */ }
    function updateTextStyle() { /* ... same as before ... */ }
    function openImageLibrary(targetInputId) { /* ... same as before ... */ }
    function closeImageLibrary() { /* ... same as before ... */ }
    function openElementLibrary(blockId) { /* ... same as before ... */ }
    function closeElementLibrary() { /* ... same as before ... */ }
    
    function selectElement(elementUrl) {
        if (currentElementBlock) {
            const blockIndex = pageBlocks.findIndex(b => b.id === currentElementBlock);
            if (blockIndex !== -1) {
                const newSticker = {
                    id: `sticker-${Date.now()}`,
                    src: elementUrl,
                    x: 20, y: 20, width: 150, rotation: 0, opacity: 1
                };
                if (!pageBlocks[blockIndex].content.stickers) pageBlocks[blockIndex].content.stickers = [];
                pageBlocks[blockIndex].content.stickers.push(newSticker);
                renderEditor();
                renderPreview();
            }
        }
        closeElementLibrary();
    }
    
    function selectImage(imageUrl) { /* ... same as before ... */ }

    function createStyleControlsHTML(prefix, styleObject, options = { color: true, size: true, weight: true, family: true, textAlign: false }) { 
        if (!styleObject) return ''; 
        return `<div class="style-controls"> ${options.family ? `<div class="control-group"><label>Font Family</label><select data-key="${prefix}.fontFamily">${fontOptionsHTML.replace(`value="${styleObject.fontFamily}"`, `value="${styleObject.fontFamily}" selected`)}</select></div>` : ''} <div class="style-controls-grid"> ${options.size ? `<div class="control-group"><label>Font Size</label><input type="text" data-key="${prefix}.fontSize" value="${styleObject.fontSize || ''}" placeholder="e.g. 16px or 1.2rem"></div>` : ''} ${options.color ? `<div class="control-group"><label>Color</label><input type="color" data-key="${prefix}.color" value="${styleObject.color || '#000000'}"></div>` : ''} </div> <div class="style-controls-grid" style="margin-top: 10px;"> ${options.weight ? `<div class="control-group"><label>Font Weight</label><select data-key="${prefix}.fontWeight"><option value="400" ${styleObject.fontWeight == '400' ? 'selected' : ''}>Normal</option><option value="700" ${styleObject.fontWeight == '700' ? 'selected' : ''}>Bold</option></select></div>` : ''} ${options.textAlign ? `<div class="control-group"><label>Text Align</label><select data-key="${prefix}.textAlign"><option value="left" ${styleObject.textAlign == 'left' ? 'selected' : ''}>Left</option><option value="center" ${styleObject.textAlign == 'center' ? 'selected' : ''}>Center</option><option value="right" ${styleObject.textAlign == 'right' ? 'selected' : ''}>Right</option></select></div>` : ''} </div> </div>`; 
    }
    
    function createInnerBlocksEditor(block) { 
        let innerBlocksHTML = (block.content.innerBlocks || []).map((innerBlock, index) => { 
            const textContentField = `<textarea data-key="innerBlocks.${index}.text">${innerBlock.text || ''}</textarea>`; 
            return `<div class="inner-block-editor" data-index="${index}" data-id="${innerBlock.id}">
                <button class="delete-inner-block-btn" title="Delete this element">×</button>
                <label style="text-transform: capitalize;">${innerBlock.type} Text</label>
                ${textContentField}
                ${createStyleControlsHTML(`innerBlocks.${index}.style`, innerBlock.style, { textAlign: true, color: true, size: true, weight: true, family: true })}
            </div>`; 
        }).join(''); 
        
        return `<hr class="style-separator">
                <div class="inner-blocks-container">
                    <label style="font-weight: bold; color: #333;">Additional Elements</label>
                    <div class="inner-blocks-list">${innerBlocksHTML}</div>
                    <div class="add-inner-block-controls">
                        <button class="add-inner-block-btn" data-inner-type="heading">+ Add Heading</button>
                        <button class="add-inner-block-btn" data-inner-type="paragraph">+ Add Paragraph</button>
                    </div>
                </div>`; 
    }

    function createScheduleItemsEditor(block) { /* ... same as before ... */ }
    
    function getNewBlockData(type) { 
        const newBlock = { type: type, id: `block-${Date.now()}`, content: { stickers: [], innerBlocks: [] } }; 
        switch(type) { 
            case 'hero': 
                newBlock.content = { ...newBlock.content, subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, names: { text: 'John & Jane', enabled: true, style: { ...defaultTitleStyle, fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF'} }, date: { text: 'September 15, 2025', enabled: true, style: { ...defaultTextStyle, color: '#FFFFFF' } }, imageUrl: 'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop', backgroundPosition: 'center center', aspectRatio: '16/9', opacity: 1, fullWidth: true }; 
                break; 
            case 'text-block': 
                newBlock.content = { ...newBlock.content, title: 'New Title', text: 'New paragraph text.', titleStyle: { ...defaultTitleStyle }, textStyle: { ...defaultTextStyle } }; 
                break; 
            case 'countdown': 
                newBlock.content = { ...newBlock.content, title: 'New Countdown', targetDate: '', titleStyle: { ...defaultTitleStyle }, numberStyle: { ...defaultTitleStyle, fontSize: '2.5rem' }, labelStyle: { ...defaultTextStyle, fontSize: '1rem' } }; 
                break;  
            case 'schedule': 
                newBlock.content = { ...newBlock.content, title: 'New Schedule', items: [{ id: `item-${Date.now()}`, time: '3:00 PM', title: 'New Event', desc: 'Event description', timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } }], titleStyle: { ...defaultTitleStyle } }; 
                break; 
            case 'location': 
                newBlock.content = { ...newBlock.content, title: 'New Location', address: '', imageUrl: '', opacity: 1, mapLink: '#', titleStyle: { ...defaultTitleStyle }, addressStyle: { ...defaultTextStyle } }; 
                break; 
            case 'rsvp': 
                newBlock.content = { ...newBlock.content, title: 'New RSVP Block', subtitle: 'New subtitle text', titleStyle: { ...defaultTitleStyle }, subtitleStyle: { ...defaultTextStyle }, buttonStyle: { fontFamily: 'Montserrat', fontSize: '1.1rem', color: '#FFFFFF', fontWeight: '700', backgroundColor: '#c5a98b' } }; 
                break; 
            case 'image': 
                newBlock.content = { ...newBlock.content, imageUrl: 'https://via.placeholder.com/800x400', opacity: 1, caption: '', title: '', description: '', titleStyle: { ...defaultTitleStyle }, descriptionStyle: { ...defaultTextStyle } }; 
                break; 
            // Form blocks...
        } 
        return newBlock; 
    }
    
    function createStickerEditor(block) { /* ... same as before ... */ }
    function createImageInputHTML(dataKey, value, label) { /* ... same as before ... */ }
    function createOpacityControl(dataKey, value, label = 'Opacity') { /* ... same as before ... */ }

    function createEditorFieldsForBlock(block) { 
        let fieldsHTML = ''; 
        const c = block.content; 
        const aspectRatioField = `<div class="control-group"><label>Block Shape (Height)</label><select data-key="aspectRatio">...</select></div>`; 
        const titleStyleField = (styleObj) => `<label>Title Style</label>${createStyleControlsHTML('titleStyle', styleObj, { textAlign: true, color: true, size: true, weight: true, family: true })}`; 
        const sectionTitleField = (title) => `<div class="control-group"><label>Section Title</label><input type="text" data-key="title" value="${title}"></div>`; 
        
        switch(block.type) { 
            case 'hero': 
                // ... (fields for subtitle, names, date)
                fieldsHTML = createInnerBlocksEditor(block) + createStickerEditor(block);
                break; 
            case 'text-block': 
                fieldsHTML = `<div class="control-group"><label>Title (optional)</label><input type="text" data-key="title" value="${c.title || ''}"></div>${titleStyleField(c.titleStyle)}<hr class="style-separator"><div class="control-group"><label>Paragraph Text</label><textarea data-key="text">${c.text}</textarea></div>${createStyleControlsHTML('textStyle', c.textStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}${createInnerBlocksEditor(block)}${createStickerEditor(block)}`; 
                break;
            case 'countdown': 
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}
                    <hr class="style-separator"><div class="control-group"><label>Target Date & Time</label><input type="datetime-local" data-key="targetDate" value="${c.targetDate}"></div>
                    <hr class="style-separator"><label>Numbers Style (e.g., 40)</label>${createStyleControlsHTML('numberStyle', c.numberStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    <hr class="style-separator"><label>Labels Style (e.g., Days)</label>${createStyleControlsHTML('labelStyle', c.labelStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    ${createInnerBlocksEditor(block)}${createStickerEditor(block)}`;
                break;  
            case 'location': 
                fieldsHTML = `${sectionTitleField(c.title)}${titleStyleField(c.titleStyle)}
                    <hr class="style-separator"><div class="control-group"><label>Address</label><textarea data-key="address">${c.address || ''}</textarea></div>${createStyleControlsHTML('addressStyle', c.addressStyle, { textAlign: true, color: true, size: true, weight: true, family: true })}
                    <hr class="style-separator">${createImageInputHTML('imageUrl', c.imageUrl, 'Photo URL')}${createOpacityControl('opacity', c.opacity, 'Photo Opacity')}<div class="control-group"><label>Google Maps Link</label><input type="url" data-key="mapLink" value="${c.mapLink || ''}"></div>
                    ${createInnerBlocksEditor(block)}${createStickerEditor(block)}`; 
                break;  
            default:
                // For other blocks like schedule, rsvp, image etc.
                fieldsHTML = `... (existing fields) ... ${createInnerBlocksEditor(block)}${createStickerEditor(block)}`;
        } 
        return fieldsHTML; 
    }
    
    function renderEditor() { /* ... same as before, no changes needed here ... */ }
    
    function setupEventListeners() { 
        const editorContent = document.getElementById('editor-content'); 
        const handleEditorChange = (e) => { /* ... same as before ... */ }; 
        editorContent.addEventListener('input', handleEditorChange); 
        editorContent.addEventListener('change', handleEditorChange); 
        
        editorContent.addEventListener('click', (e) => { 
            const target = e.target; 
            const blockDiv = target.closest('.editor-block'); 
            if (!blockDiv) return; 
            const blockId = blockDiv.dataset.id; 
            const blockIndex = pageBlocks.findIndex(b => b.id === blockId); 

            if (target.matches('.add-inner-block-btn')) { 
                const type = target.dataset.innerType; 
                const newInnerBlock = { 
                    id: `inner-${Date.now()}`, 
                    type, 
                    text: `New ${type}`, 
                    style: type === 'heading' ? {...defaultTitleStyle} : {...defaultTextStyle},
                    x: 20, y: 20, width: 200, rotation: 0, opacity: 1
                }; 
                if (!pageBlocks[blockIndex].content.innerBlocks) pageBlocks[blockIndex].content.innerBlocks = []; 
                pageBlocks[blockIndex].content.innerBlocks.push(newInnerBlock); 
                renderEditor(); 
                renderPreview(); 
            } else if (target.matches('.delete-inner-block-btn')) { 
                const innerIndex = parseInt(target.closest('.inner-block-editor').dataset.index, 10); 
                pageBlocks[blockIndex].content.innerBlocks.splice(innerIndex, 1); 
                renderEditor(); 
                renderPreview(); 
            } else if (target.closest('.delete-block-btn')) { 
                if (confirm('Are you sure?')) { 
                    pageBlocks.splice(blockIndex, 1); 
                    renderEditor(); 
                    renderPreview(); 
                } 
            } else if (target.closest('.editor-block-header')) { 
                const content = blockDiv.querySelector('.editor-block-content'); 
                content.classList.toggle('is-open'); 
                blockDiv.querySelector('.toggle-btn').textContent = content.classList.contains('is-open') ? '▲' : '▼'; 
            } 
        }); 
    }
    
    document.getElementById('add-block-btn').addEventListener('click', () => { /* ... */ }); 
    // ... other modal event listeners
    
    function setupResizeObserver() { /* ... */ }
    function renderPreview() { /* ... */ }
    function initSortable() { /* ... */ }
    document.getElementById('share-button').addEventListener('click', async function() { /* ... */ });
    // ... global settings event listeners
    
    function saveCurrentPageData() { /* ... */ }
    function switchEditorMode(target) { /* ... */ }
    function updateAddBlockOptions() { /* ... */ }
    editMainBtn.addEventListener('click', () => { /* ... */ }); 
    editRsvpBtn.addEventListener('click', () => { /* ... */ });
    
    async function initEditor() {
        // ... (API key fetching)

        window.addEventListener('message', (event) => {
            if (event.source !== iframe.contentWindow) return;
            const { type, payload } = event.data;
            
            const updateInteractiveElement = (listName) => {
                const { blockId, id, newProps } = payload;
                const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
                if (blockIndex === -1) return;
                const elementIndex = pageBlocks[blockIndex].content[listName].findIndex(s => s.id === id);
                if (elementIndex === -1) return;
                
                Object.assign(pageBlocks[blockIndex].content[listName][elementIndex], newProps);
                renderEditor(); // Re-render editor to update coordinates/sizes in inputs
            };

            if (type === 'UPDATE_STICKER') {
                updateInteractiveElement('stickers');
            } else if (type === 'UPDATE_INNER_BLOCK') {
                updateInteractiveElement('innerBlocks');
            } else if (type === 'TEXT_ELEMENT_CLICKED') {
                showTextEditingToolbar(payload.blockId, payload.elementKey, payload.currentStyle);
            } else if (type === 'HIDE_TEXT_TOOLBAR') {
                hideTextEditingToolbar();
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#text-editing-toolbar') && !e.target.closest('#preview-frame')) {
                hideTextEditingToolbar();
            }
        });
        
        // ... (rest of initEditor)
    }
    
    initEditor();
    </script>
</body>
</html>