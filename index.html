<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Dynamic Invitation Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html { font-family: sans-serif; scroll-behavior: smooth; } body { margin: 0; display: grid; grid-template-columns: 420px 1fr; background-color: #f0f2f5; } #editor-panel { grid-column: 1; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; } #preview-panel { grid-column: 2; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; } #preview-wrapper { width: 100%; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; height: fit-content; } iframe { width: 100%; height: 100%; border: none; display: block; transform-origin: top left; } #editor-header { padding: 15px; border-bottom: 2px solid #f0f2f5; } #editor-header .template-switcher { display: flex; gap: 10px; margin-top: 10px; } #editor-header .template-switcher button { flex: 1; padding: 8px; font-size: 14px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; } #editor-header .template-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; } .global-settings { margin-top: 15px; } #editor-content { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 0; } #editor-footer { padding: 20px; border-top: 1px solid #eee; } .editor-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .editor-block-header { display: flex; align-items: center; padding: 10px; background-color: #f9f9f9; cursor: pointer; border-bottom: 1px solid #eee; } .drag-handle { cursor: grab; margin-right: 10px; color: #aaa; } .editor-block-title { font-weight: bold; flex-grow: 1; } .editor-block-controls button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; } .delete-block-btn { color: crimson !important; } .editor-block-content { padding: 15px; display: none; } .editor-block-content.is-open { display: block; }
        .control-group { margin-bottom: 15px; } .control-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #333; } .control-group label input[type="checkbox"] { width: auto; margin-right: 8px; vertical-align: middle; } input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; } input.smart-location-search { border-left: 4px solid #28a745; } textarea { min-height: 80px; }
        .style-controls { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 5px; background-color: #fdfdfd; } .style-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; } .style-controls .control-group { margin-bottom: 0; } input[type="color"] { padding: 2px; min-height: 38px; } .style-controls label { font-size: 0.9em; font-weight: 600; color: #555; } hr.style-separator { border: none; border-top: 1px dashed #ccc; margin: 15px 0; }
        .optional-element-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } .optional-element-header label { margin-bottom: 0; }
        .sticker-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #6f42c1; } .sticker-editor-header { display: flex; justify-content: space-between; align-items: center; } .sticker-editor .control-group { margin-bottom: 8px; } .sticker-editor .control-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 3px; } .delete-sticker-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-weight: bold; cursor: pointer; }
        .inner-blocks-container { border-top: 2px solid #007bff; margin-top: 20px; padding-top: 15px; } .inner-block-editor { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid #007bff; } .inner-block-editor .delete-inner-block-btn { float: right; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; line-height: 22px; text-align: center; } .add-inner-block-controls button { background-color: #e9ecef; border: 1px dashed #ccc; padding: 8px; margin-right: 5px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; } .modal-overlay.is-visible { display: flex; } .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; } .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; } #add-block-options button { display: block; width: 100%; padding: 12px; margin-bottom: 10px; text-align: left; background: #f0f2f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .image-input-group { display: flex; gap: 8px; align-items: stretch; } .image-input-group input[type="url"] { flex: 1; } .browse-image-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px; } .browse-image-btn:hover { background: #0056b3; }
        .image-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; } .image-library-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: border-color 0.2s; } .image-library-item:hover { border-color: #007bff; } .image-library-item img { width: 100%; height: 80px; object-fit: cover; display: block; }
        .upload-section { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; } .upload-section.dragover { border-color: #007bff; background-color: #f8f9fa; } .upload-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; } .upload-btn:hover { background: #218838; }
        .opacity-control { margin-top: 10px; } .opacity-slider { width: 100%; margin-top: 5px; }
        .schedule-item-editor { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin-bottom: 15px; } .schedule-item-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } .schedule-item-editor-header h4 { margin: 0; flex-grow: 1; } .delete-schedule-item-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <div id="editor-panel"> <div id="editor-header"><h2>Editor</h2><div class="template-switcher"><button id="edit-main-btn" class="active">Invitation</button><button id="edit-rsvp-btn">RSVP Form</button></div><div class="global-settings"><div class="control-group"><label for="global-style-select">Page Style</label><select id="global-style-select"><option value="classic">Classic (Cards)</option><option value="modern">Modern (Shared Background)</option></select></div><div class="control-group" id="global-bg-image-group"><label for="global-bg-image-input">Background Image URL</label><div class="image-input-group"><input type="url" id="global-bg-image-input" placeholder="https://images.unsplash.com/photo-..."><button type="button" class="browse-image-btn" onclick="openImageLibrary('global-bg-image-input')">Browse...</button></div></div><div class="control-group"><label for="global-width-input">Global Block Width</label><input type="text" id="global-width-input" placeholder="e.g., 800px or 90%"></div></div></div> <div id="editor-content"></div> <div id="editor-footer"><button id="add-block-btn" class="action-button" style="margin-bottom: 15px; background-color: #28a745;">+ Add New Block</button><button id="share-button" class="action-button">Generate & Copy Link</button><p id="status-text" style="text-align:center; margin-top:10px;"></p></div> </div> <div id="preview-panel"><div id="preview-wrapper"><iframe id="preview-frame" scrolling="no"></iframe></div></div> <template id="editor-block-template"><div class="editor-block"><div class="editor-block-header"><span class="drag-handle">☰</span><span class="editor-block-title">Block Title</span><div class="editor-block-controls"><button class="toggle-btn">▼</button><button class="delete-block-btn" title="Delete Block">×</button></div></div><div class="editor-block-content"></div></div></template> <div id="add-block-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close" id="modal-close-btn">×</span><h3>Choose a Block to Add</h3><div id="add-block-options"><button data-type="hero">Hero</button><button data-type="text-block">Text Block</button><button data-type="image">Image</button><hr><button data-type="schedule">Schedule</button><button data-type="location">Location</button><button data-type="countdown">Countdown</button><button data-type="rsvp">RSVP Button</button><hr><button data-type="form-header">Form: Header</button><button data-type="input-question">Form: Text Input</button><button data-type="textarea-question">Form: Text Area</button><button data-type="radio-question">Form: Radio Choice</button><button data-type="form-footer">Form: Footer</button></div></div></div>

    <div id="image-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeImageLibrary()">×</span>
            <h3>Image Library</h3>
            <div class="upload-section" id="upload-section">
                <p>Drag & drop an image here or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">Choose File</button>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">Uploads via ImgBB (free image hosting)</p>
            </div>
            <div class="image-library-grid" id="image-library-grid"></div>
        </div>
    </div>

    <div id="element-library-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeElementLibrary()">×</span>
            <h3>Element Library</h3>
            <div class="upload-section" id="element-upload-section">
                <p>Upload Your Own Element</p>
                <p>Drag & drop an image here or</p>
                <button class="upload-btn" onclick="document.getElementById('element-file-input').click()">Choose File</button>
                <input type="file" id="element-file-input" accept="image/*" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-top: 10px;">Uploads via ImgBB (free image hosting)</p>
            </div>
            <div class="image-library-grid" id="element-library-grid"></div>
        </div>
    </div>

    <script>
    const iframe = document.getElementById("preview-frame");
    let pageBlocks = []; let pageSettings = {}; let currentTemplate = '';
    let apiKeys = {}; 
    let currentImageTarget = null;
    let currentElementBlock = null;
    
    const defaultTextStyle = { fontFamily: 'Montserrat', fontSize: '1rem', color: '#333333', fontWeight: '400' };
    const defaultTitleStyle = { fontFamily: 'Playfair Display', fontSize: '2.2rem', color: '#111111', fontWeight: '700' };

    let mainPageData = { template: 'output_wedding-classic.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ { type: 'hero', id: `block-${Date.now()}-1`, content: { subtitle: { text: 'WE ARE GETTING MARRIED', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, names: { text: 'John & Jane', enabled: true, style: { fontFamily: 'Great Vibes', fontSize: '4rem', color: '#FFFFFF', fontWeight: '400' } }, date: { text: 'September 15, 2025', enabled: true, style: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#FFFFFF', fontWeight: '400' } }, imageUrl: 'https://cdn.pixabay.com/photo/2018/01/18/19/06/table-3091173_1280.jpg', backgroundPosition: 'center center', aspectRatio: '16/9', opacity: 1, stickers: [], fullWidth: true }}, { type: 'text-block', id: `block-${Date.now()}-3`, content: { title: 'A few words', text: 'We are excited to share this special day with our closest family and friends.', titleStyle: { ...defaultTitleStyle, fontSize: '2.5rem' }, textStyle: { ...defaultTextStyle, fontSize: '1.1rem', textAlign: 'center' }, stickers: [] }}, { type: 'schedule', id: `block-${Date.now()}-4`, content: { title: "The Day's Schedule", items: [{ id: `item-${Date.now()}-1`, time: '3:00 PM', title: 'Ceremony', desc: 'Join us for the wedding ceremony.', timeStyle: { fontFamily: 'Montserrat', fontSize: '1.2rem', color: '#c5a98b', fontWeight: '700' }, titleStyle: { fontFamily: 'Playfair Display', fontSize: '1.4rem', color: '#333333', fontWeight: '700' }, descStyle: { fontFamily: 'Montserrat', fontSize: '1rem', color: '#666666', fontWeight: '400' } }], titleStyle: { ...defaultTitleStyle }, stickers: [] }} ] };
    let rsvpFormData = { template: 'output_rsvp-form.html', settings: { maxWidth: '800px', style: 'classic', backgroundImage: '' }, blocks: [ ] };
    
    const fontOptionsHTML = `<optgroup label="Script/Handwritten"> <option value="Great Vibes">Great Vibes</option> <option value="Dancing Script">Dancing Script</option> <option value="Allura">Allura</option> <option value="Sacramento">Sacramento</option> <option value="Alex Brush">Alex Brush</option> <option value="Satisfy">Satisfy</option> <option value="Kaushan Script">Kaushan Script</option> <option value="Pacifico">Pacifico</option> <option value="Caveat">Caveat</option> <option value="Cookie">Cookie</option> </optgroup> <optgroup label="Elegant Serif"> <option value="Playfair Display">Playfair Display</option> <option value="Crimson Text">Crimson Text</option> <option value="Cormorant Garamond">Cormorant Garamond</option> <option value="EB Garamond">EB Garamond</option> <option value="Libre Baskerville">Libre Baskerville</option> <option value="Lora">Lora</option> <option value="Merriweather">Merriweather</option> <option value="Vollkorn">Vollkorn</option> </optgroup> <optgroup label="Decorative"> <option value="Cinzel">Cinzel</option> <option value="Abril Fatface">Abril Fatface</option> <option value="Amatic SC">Amatic SC</option> <option value="Fredoka One">Fredoka One</option> <option value="Lobster">Lobster</option> </optgroup> <optgroup label="Modern Sans-Serif"> <option value="Montserrat">Montserrat</option> <option value="Raleway">Raleway</option> <option value="Lato">Lato</option> <option value="Open Sans">Open Sans</option> <option value="Poppins">Poppins</option> </optgroup>`;
    
    const predefinedImages = [ 'https://images.unsplash.com/photo-1522158637959-30385a09e0da?q=80&w=2070&auto=format&fit=crop', 'https://images.unsplash.com/photo-1511795408833-2a1e94992e7a?q=80&w=2070&auto=format&fit=crop', 'https://images.unsplash.com/photo-1519225421980-715cb0215aed?q=80&w=2070&auto=format&fit=crop', 'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?q=80&w=2069&auto=format&fit=crop', 'https://cdn.pixabay.com/photo/2018/01/18/19/06/table-3091173_1280.jpg' ];
    const predefinedElements = [ 'https://www.pngkey.com/png/full/15-154942_wedding-rings-png-image-background-gold-wedding-rings.png', 'https://static.vecteezy.com/system/resources/previews/009/341/365/original/heart-shape-outline-love-symbol-icon-free-png.png' ];

    // The rest of your script functions (openImageLibrary, closeImageLibrary, etc.) remain unchanged...
    // ...
    
    // --- ИСПРАВЛЕНИЕ НАЧИНАЕТСЯ ЗДЕСЬ ---
    
    async function initEditor() {
        try {
            const response = await fetch('/.netlify/functions/get-api-keys');
            if (response.ok) apiKeys = await response.json();
            else console.warn('Could not fetch API keys from server');
        } catch (error) {
            console.warn('Error fetching API keys:', error);
        }

        window.addEventListener('message', (event) => {
            if (event.source !== iframe.contentWindow) return;
            const { type, payload } = event.data;
            if (type === 'UPDATE_STICKER') {
                const { blockId, stickerId, newProps } = payload;
                const blockIndex = pageBlocks.findIndex(b => b.id === blockId);
                if (blockIndex === -1) return;
                
                const stickerIndex = pageBlocks[blockIndex].content.stickers.findIndex(s => s.id === stickerId);
                if (stickerIndex === -1) return;

                // Получаем текущие размеры iframe для коррекции координат
                const iframeRect = iframe.getBoundingClientRect();
                const scale = iframeRect.width / iframe.contentWindow.document.body.scrollWidth;

                // Корректируем координаты, если они пришли
                if (newProps.x !== undefined) {
                    newProps.x = newProps.x / scale;
                }
                if (newProps.y !== undefined) {
                    newProps.y = newProps.y / scale;
                }
                if (newProps.width !== undefined) {
                    newProps.width = newProps.width / scale;
                }

                Object.assign(pageBlocks[blockIndex].content.stickers[stickerIndex], newProps);
                renderEditor(); 
            }
        });

        // The rest of your initEditor function remains...
        // ...
    }
    
    // The rest of your script remains unchanged...
    
    // --- ИСПРАВЛЕНИЕ ЗАКАНЧИВАЕТСЯ ЗДЕСЬ ---

    </script>
</body>
</html>