<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Allura&family=Sacramento&family=Alex+Brush&family=Satisfy&family=Kaushan+Script&family=Pacifico&family=Caveat:wght@400;700&family=Cookie&family=Playfair+Display:wght@400;700&family=Crimson+Text:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=EB+Garamond:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Vollkorn:wght@400;700&family=Cinzel:wght@400;700&family=Abril+Fatface&family=Amatic+SC:wght@400;700&family=Fredoka+One&family=Lobster&family=Montserrat:wght@300;400;700&family=Raleway:wght@300;400;700&family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background-color: #f8f7f5; opacity: 0; transition: opacity .5s ease-in-out; font-family: 'Montserrat', sans-serif; line-height: 1.6; }
        .content-section{background: #fff; margin: 30px auto; padding: 50px 20px; text-align: center; position: relative; border-radius: 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); max-width: 800px; box-sizing: border-box;}
        h1, h2, h3, h4, h5, h6, p { margin: 0; padding: 0; }
        .hero-block { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; overflow: hidden; width: 100%; color: #fff; }
        .hero-background-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        .hero-block::before{ content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.4); z-index: 1; }
        .hero-content{ position:relative; z-index: 2; width: 90%; max-width: 1000px; padding: 40px 0; }
        .hero-content h1 { line-height: 1.2; margin: 10px 0; }
        .hero-content p { letter-spacing: 2px; margin: 0; }
        .paragraph-block { text-align: left; }
        .paragraph-block h3 { margin-bottom: 15px; }
        .countdown-container{display:flex;justify-content:center;gap:20px;text-align:center; margin-top: 30px;}
        .schedule-list{list-style:none;padding:0;text-align:left; max-width: 600px; margin: 30px auto 0; }
        .schedule-item{display:flex; gap:20px; border-bottom:1px solid #eee; padding:20px 0}
        .schedule-item:last-child{border-bottom:none}
        .schedule-event { flex-grow: 1; }
        .schedule-event h3 { text-align: left; }
        .rsvp-button{display:inline-block; color:#fff!important; padding:15px 30px;text-decoration:none;border-radius:50px; margin: 10px;}
        #envelope-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; z-index: 1000; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 1.5s ease-in-out; } body.intro-active main { opacity: 0; } #envelope-3d { width: 80%; max-width: 500px; height: 80%; max-height: 500px; transition: transform 0.5s, opacity 0.5s; opacity: 0; } #envelope-3d.loaded { opacity: 1; animation: floatAnimation 4s ease-in-out infinite; } #envelope-wrapper.hidden { opacity: 0; pointer-events: none; } @keyframes floatAnimation { 0% { transform: translateY(0); } 50% { transform: translateY(-15px); } 100% { translateY(0); } } @media (min-width: 768px) { #envelope-3d { max-width: 700px; max-height: 700px; } }
    </style>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
    <div id="envelope-wrapper">
        <model-viewer id="envelope-3d" src="/templates/envelope.glb" alt="An interactive 3D envelope" camera-controls disable-zoom interaction-prompt="none" camera-orbit="0deg 75deg 105%" style="width: 100%; height: 100%; background: none;"></model-viewer>
    </div>
    <main id="page-content"></main>
    <script>
        let countdownInterval;

        function getStyleString(styleObj) {
            if (!styleObj) return '';
            let styles = '';
            if (styleObj.fontFamily) styles += `font-family: '${styleObj.fontFamily}', sans-serif; `;
            if (styleObj.color) styles += `color: ${styleObj.color}; `;
            if (styleObj.fontSize) styles += `font-size: ${styleObj.fontSize}em; `;
            if (styleObj.fontWeight) styles += `font-weight: ${styleObj.fontWeight}; `;
            return styles.trim();
        }

        const processText = (text) => (text || '').replace(/\n/g, '<br>');

        function createHeroHTML(c) { const headerStyle = c.aspectRatio ? `aspect-ratio: ${c.aspectRatio};` : 'height: 50vh;'; return `<header class="hero-block" style="${headerStyle}">${c.imageUrl ? `<img class="hero-background-image" src="${c.imageUrl}" style="object-position: ${c.backgroundPosition || 'center center'};" alt="">` : ''}<div class="hero-content"><p style="${getStyleString(c.subtitleStyle)}">${c.subtitle}</p><h1 style="${getStyleString(c.namesStyle)}">${c.names}</h1><p style="${getStyleString(c.dateStyle)}">${c.date}</p></div></header>`; }
        function createParagraphHTML(c) { return `<section class="content-section paragraph-block">${c.heading ? `<h3 style="${getStyleString(c.headingStyle)}">${c.heading}</h3>` : ''}<p style="${getStyleString(c.textStyle)}">${processText(c.text)}</p></section>`; }
        function createCountdownHTML(c) { return `<section class="content-section" data-target-date="${c.targetDate || ''}"><h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2><div class="countdown-container"><div class="time-block"><div id="days" style="${getStyleString(c.numberStyle)}">00</div><div style="${getStyleString(c.labelStyle)}">Days</div></div><div class="time-block"><div id="hours" style="${getStyleString(c.numberStyle)}">00</div><div style="${getStyleString(c.labelStyle)}">Hours</div></div><div class="time-block"><div id="minutes" style="${getStyleString(c.numberStyle)}">00</div><div style="${getStyleString(c.labelStyle)}">Minutes</div></div><div class="time-block"><div id="seconds" style="${getStyleString(c.numberStyle)}">00</div><div style="${getStyleString(c.labelStyle)}">Seconds</div></div></div></section>`;}
        function createScheduleHTML(c) { return `<section class="content-section"><h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2><ul class="schedule-list">${(c.items || []).map(i => `<li class="schedule-item"><div class="schedule-time" style="${getStyleString(c.timeStyle)}">${i.time}</div><div class="schedule-event"><h3 style="${getStyleString(c.eventTitleStyle)}">${i.title}</h3><p style="${getStyleString(c.eventDescStyle)}">${processText(i.desc)}</p></div></li>`).join('')}</ul></section>`; }
        function createLocationHTML(c) { return `<section class="content-section"><h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2><p style="${getStyleString(c.addressStyle)}">${processText(c.address)}</p>${c.imageUrl ? `<img src="${c.imageUrl}" alt="" style="width:100%; border-radius: 8px; margin-top: 20px;">` : ''}<a href="${c.mapLink}" target="_blank" class="rsvp-button" style="background-color: ${(c.buttonStyle && c.buttonStyle.accentColor) || '#C5A98B'}; margin-top: 30px;">View on Map</a></section>`; }
        function createRsvpHTML(c) { return `<section class="content-section"><h2 style="${getStyleString(c.titleStyle)}">${c.title}</h2><p style="${getStyleString(c.subtitleStyle)}">${processText(c.subtitle)}</p><a href="#" class="rsvp-button" style="background-color: ${(c.buttonStyle && c.buttonStyle.accentColor) || '#C5A98B'};">I'll Be There!</a></section>`; }

        // ИСПРАВЛЕНО: Восстановлена функция startCountdown
        function startCountdown(targetDate) {
            if (!targetDate) return;
            if (countdownInterval) clearInterval(countdownInterval);
            const targetTime = new Date(targetDate).getTime();
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetTime - now;
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    return;
                }
                const D = document.getElementById("days"), H = document.getElementById("hours"), M = document.getElementById("minutes"), S = document.getElementById("seconds");
                if(D) D.innerText = Math.floor(distance / 864e5).toString().padStart(2, '0');
                if(H) H.innerText = Math.floor((distance % 864e5) / 36e5).toString().padStart(2, '0');
                if(M) M.innerText = Math.floor((distance % 36e5) / 6e4).toString().padStart(2, '0');
                if(S) S.innerText = Math.floor((distance % 6e4) / 1e3).toString().padStart(2, '0');
            }, 1000);
        }

        // ИСПРАВЛЕНО: Восстановлена функция setupIntroAnimation
        function setupIntroAnimation() { const envelopeWrapper = document.getElementById('envelope-wrapper'); const modelViewer = document.getElementById('envelope-3d'); if (!envelopeWrapper || !modelViewer || typeof confetti !== 'function') return; document.body.classList.add('intro-active'); modelViewer.addEventListener('load', () => { modelViewer.classList.add('loaded'); }); const fireConfetti = () => { const defaults = { spread: 360, ticks: 150, gravity: 0, decay: 0.95, startVelocity: 35, shapes: ['star'], colors: ['FFE400', 'FFBD00', 'E89400', 'FFCA6C', 'FDFFB8'] }; confetti({ ...defaults, particleCount: 60, scalar: 1.2, shapes: ['star'] }); confetti({ ...defaults, particleCount: 20, scalar: 0.75, shapes: ['circle'] }); }; envelopeWrapper.addEventListener('click', () => { fireConfetti(); modelViewer.style.transform = 'scale(0)'; modelViewer.style.opacity = '0'; setTimeout(() => { document.body.classList.remove('intro-active'); envelopeWrapper.classList.add('hidden'); }, 500); }, { once: true }); }

        function renderPage(blocks, settings) {
            if (!blocks) return;
            const container = document.getElementById('page-content');
            container.innerHTML = '';
            const blockRenderers = { hero: createHeroHTML, paragraph: createParagraphHTML, countdown: createCountdownHTML, schedule: createScheduleHTML, location: createLocationHTML, rsvp: createRsvpHTML };
            
            blocks.forEach(block => {
                if (blockRenderers[block.type]) {
                    container.innerHTML += blockRenderers[block.type](block.content);
                }
            });
            
            const countdownBlock = document.querySelector('[data-target-date]');
            if(countdownBlock) {
                startCountdown(countdownBlock.dataset.targetDate);
            }

            document.body.style.opacity = 1;
        }

        // ИСПРАВЛЕНО: Восстановлена логика для iframe
        if (window.self !== window.top) { // Если открыто в iframe (превью)
            document.body.style.opacity = 1;
            const envelopeWrapper = document.getElementById('envelope-wrapper');
            if (envelopeWrapper) { envelopeWrapper.style.display = 'none'; }
        } else { // Если открыто как самостоятельная страница
            setupIntroAnimation();
        }
    </script>
</body>
</html>