<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{--accent-color:#c5a98b;--background-color:#f8f7f5}
        body{margin:0;font-family:'Montserrat',sans-serif;line-height:1.7;background-color:var(--background-color);color:#333;opacity:0;transition:opacity .5s ease-in-out; background-size: cover; background-position: center; background-attachment: fixed;}
        .content-section{background: #fff; margin: 30px auto; padding: 50px 20px; text-align: center; position: relative; border-radius: 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); box-sizing: border-box;}
        #page-content > .content-section:first-child { margin-top: 0; border-radius: 0; }
        #page-content > .hero-block + .content-section { margin-top: 30px; border-radius: 8px; }
        h1,h2,h3{font-family:'Playfair Display',serif;text-align:center}
        h2{font-size:2.2rem;margin-top: 0; margin-bottom:30px}
        .hero-block {display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; position: relative; background-size: cover; background-position: center; overflow: hidden; padding: 40px 20px; box-sizing: border-box; width: 100%;}
        .hero-block::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4); z-index: 1;}
        .hero-content{position:relative;z-index:2}
        .hero-content h1{font-size:4rem;margin:10px 0; line-height: 1.2;}
        .hero-content p{font-size:1.2rem;letter-spacing:2px; margin: 0;}
        .style-modern .content-section {background: rgba(255, 255, 255, 0.85); box-shadow: none; color: #333;}
        .style-modern #page-content > .content-section:first-child { border-radius: 8px; }
        .style-modern .hero-block { background-image: none !important; margin: 0 auto; }
        .style-modern .hero-block::before { background: rgba(0,0,0,0.2); }
        .style-modern .hero-content h1, .style-modern .hero-content p { text-shadow: 1px 1px 4px rgba(0,0,0,0.6); }
        .style-modern #countdown .time-block { background: rgba(255, 255, 255, 0.5); }
        #countdown{display:flex;justify-content:center;gap:20px;text-align:center}
        .time-block{background:#f4f4f4;padding:20px;border-radius:5px;min-width:80px}
        .time-block .number{font-size:2.5rem;font-weight:700;color:var(--accent-color)}
        .schedule-list{list-style:none;padding:0;text-align:left; max-width: 600px; margin: 0 auto;}
        .schedule-item{display:flex;gap:20px;border-bottom:1px solid #eee;padding:20px 0}
        .schedule-item:last-child{border-bottom:none}
        .schedule-time{font-weight:700;color:var(--accent-color);font-size:1.2rem;min-width:80px}
        .schedule-event h3{margin:0;font-size:1.4rem;text-align:left}
        .schedule-event p{margin:5px 0 0; white-space: pre-wrap;}
        .location-block p { margin-bottom: 20px; white-space: pre-wrap; } 
        .location-block img { width: 100%; height: auto; max-height: 400px; object-fit: cover; border-radius: 8px; }
        .rsvp-button{display:inline-block;background:var(--accent-color);color:#fff!important;padding:15px 30px;text-decoration:none;border-radius:50px;transition:transform .2s ease;font-size:1.1rem; margin: 10px;}
        .rsvp-button.decline{background-color:#888}
        .rsvp-button:hover{transform:scale(1.05)}
        .paragraph-block p { font-size: 1.1em; line-height: 1.8; text-align: left; white-space: pre-wrap; }
        .image-block figure { margin: 0; } 
        .image-block img { max-width: 100%; border-radius: 8px; } 
        .image-block figcaption { margin-top: 10px; font-style: italic; color: #777; }
        @media (max-width: 768px) { .content-section { margin-left: 15px; margin-right: 15px; } }
        @media (max-width: 600px) { .hero-content h1 { font-size: 2.8rem; } h2 { font-size: 1.8rem; } .content-section { padding: 30px 20px; margin: 20px 10px; } .schedule-item { flex-direction: column; align-items: flex-start; gap: 10px; } .time-block { padding: 15px; min-width: 60px; } .time-block .number { font-size: 2rem; } #countdown { gap: 10px; } }

                /* ===== СТИЛИ ДЛЯ ИНТРО-КОНВЕРТА ===== */
        #envelope-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 1.2s ease-in-out;
        }

        /* Скрываем основной контент, пока интро активно */
        body.intro-active main {
            opacity: 0;
        }

        /* Контейнер для 3D-анимации */
        #envelope {
            position: relative;
            width: 80vmin;
            height: 50vmin;
            perspective: 1500px;
            transform-style: preserve-3d;
        }

        /* Основание конверта */
        .envelope-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 25%, #B22222 50%, #8B0000 100%);
            border-radius: 12px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.3);
            transform-style: preserve-3d;
        }

        /* Текстура бархата */
        .envelope-base::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.05) 1px, transparent 1px),
                radial-gradient(circle at 40% 60%, rgba(255,255,255,0.08) 1px, transparent 1px);
            background-size: 15px 15px, 20px 20px, 25px 25px;
            border-radius: 12px;
        }

        /* Левый клапан */
        .flap-left {
            position: absolute;
            left: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 25%, #B22222 50%, #8B0000 100%);
            transform-origin: left center;
            transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            border-radius: 12px 0 0 12px;
            box-shadow: inset -2px 0 10px rgba(0,0,0,0.3);
            z-index: 3;
        }

        /* Правый клапан */
        .flap-right {
            position: absolute;
            right: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 25%, #B22222 50%, #8B0000 100%);
            transform-origin: right center;
            transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            border-radius: 0 12px 12px 0;
            box-shadow: inset 2px 0 10px rgba(0,0,0,0.3);
            z-index: 3;
        }

        /* Верхний клапан */
        .flap-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 25%, #B22222 50%, #8B0000 100%);
            transform-origin: top center;
            transition: transform 1.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            border-radius: 12px 12px 0 0;
            box-shadow: inset 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 4;
        }

        /* Нижний клапан */
        .flap-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 25%, #B22222 50%, #8B0000 100%);
            transform-origin: bottom center;
            transition: transform 1.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            border-radius: 0 0 12px 12px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            z-index: 4;
        }

        /* Печать */
        .seal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12vmin;
            height: 12vmin;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 30%, #FF8C00 70%, #FF6347 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 2vmin;
            color: #8B0000;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 
                0 0 30px rgba(255,215,0,0.6),
                inset 0 2px 5px rgba(255,255,255,0.3),
                inset 0 -2px 5px rgba(0,0,0,0.2);
            transition: all 0.8s ease;
            z-index: 10;
            cursor: pointer;
            animation: sealGlow 3s ease-in-out infinite alternate;
        }

        @keyframes sealGlow {
            0% { box-shadow: 0 0 30px rgba(255,215,0,0.6), inset 0 2px 5px rgba(255,255,255,0.3), inset 0 -2px 5px rgba(0,0,0,0.2); }
            100% { box-shadow: 0 0 50px rgba(255,215,0,0.8), inset 0 2px 8px rgba(255,255,255,0.4), inset 0 -2px 8px rgba(0,0,0,0.3); }
        }

        .seal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: conic-gradient(from 0deg, #FFD700, #FFA500, #FF8C00, #FF6347, #FFD700);
            border-radius: 50%;
            z-index: -1;
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Состояние "открыто" */
        #envelope.open .flap-left {
            transform: rotateY(-180deg);
        }

        #envelope.open .flap-right {
            transform: rotateY(180deg);
        }

        #envelope.open .flap-top {
            transform: rotateX(-180deg);
        }

        #envelope.open .flap-bottom {
            transform: rotateX(180deg);
        }

        #envelope.open .seal {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.3);
        }

        /* Карточка внутри */
        .card-front {
            position: absolute;
            width: 92%;
            height: 92%;
            top: 4%;
            left: 4%;
            background: linear-gradient(135deg, #f8f7f5 0%, #ffffff 50%, #f0f0f0 100%);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1;
        }

        /* Анимация исчезновения всего блока */
        #envelope-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            #envelope {
                width: 90vmin;
                height: 56vmin;
            }
            .seal {
                width: 15vmin;
                height: 15vmin;
                font-size: 2.5vmin;
            }
        }
    </style>
</head>
<body>
        <!-- ===== НАЧАЛО КОДА КОНВЕРТА ===== -->
    <div id="envelope-wrapper">
        <div id="envelope">
            <div class="envelope-base"></div>
            <div class="card-front"></div>
            <div class="flap-left"></div>
            <div class="flap-right"></div>
            <div class="flap-top"></div>
            <div class="flap-bottom"></div>
            <div class="seal">John & Jane</div>
        </div>
    </div>
<!-- ===== КОНЕЦ КОДА КОНВЕРТА ===== -->
    <!-- ===== КОНЕЦ КОДА КОНВЕРТА ===== -->

    <main id="page-content"></main>
    
    <script>
    let countdownInterval;

    // ===== ЛОГИКА ДЛЯ ИНТРО-КОНВЕРТА =====
    function setupIntroAnimation() {
        const envelopeWrapper = document.getElementById('envelope-wrapper');
        const envelope = document.getElementById('envelope');
        const seal = document.querySelector('.seal');

        if (!envelopeWrapper || !envelope || !seal) return;

        document.body.classList.add('intro-active');

        // Анимация при клике на печать
        seal.addEventListener('click', (e) => {
            e.stopPropagation();
            envelope.classList.add('open');
            
            // Ждем завершения анимации раскрытия клапанов
            setTimeout(() => {
                document.body.classList.remove('intro-active');
                envelopeWrapper.classList.add('hidden');
            }, 1500);
        }, { once: true });
    }

    // ===== ИСПРАВЛЕННЫЕ ФУНКЦИИ ДЛЯ КОРРЕКТНОГО ОТОБРАЖЕНИЯ =====

    const getBlockStyles = (c, settings, type) => {
        const styles = [];
        if (type !== 'hero' || settings.style === 'modern') {
            styles.push(`max-width: ${settings.maxWidth || '800px'}`);
        }
        if (c.height) {
            const heightProp = (type === 'hero' && settings.style === 'classic') ? 'height' : 'min-height';
            styles.push(`${heightProp}: ${c.height}`);
        }
        return styles.join('; ');
    };
    
    const createHeroHTML = (c, s) => {
        const styles = [
            `background-image: url('${c.imageUrl}')`,
            getBlockStyles(c, s, 'hero')
        ];
        const styleAttribute = styles.filter(Boolean).join('; ');
        return `<header class="hero-block" style="${styleAttribute}"><div class="hero-content"><p>${c.subtitle}</p><h1>${c.names}</h1><p>${c.date}</p></div></header>`;
    };
    
    // ===== ОСТАЛЬНЫЕ ФУНКЦИИ ГЕНЕРАЦИИ HTML (без изменений) =====

    const processText = (text) => (text || '').replace(/\n/g, '<br>');
    const createCountdownHTML = (c, s) => `<section class="content-section" style="${getBlockStyles(c, s, 'countdown')}"><h2 id="countdown-title">${c.title}</h2><div id="countdown"><div class="time-block"><div id="days" class="number">00</div><div>Days</div></div><div class="time-block"><div id="hours" class="number">00</div><div>Hours</div></div><div class="time-block"><div id="minutes" class="number">00</div><div>Minutes</div></div><div class="time-block"><div id="seconds" class="number">00</div><div>Seconds</div></div></div></section>`;
    const createScheduleHTML = (c, s) => `<section class="content-section" style="${getBlockStyles(c, s, 'schedule')}"><h2>${c.title}</h2><ul class="schedule-list">${c.items.map(i => `<li class="schedule-item"><div class="schedule-time">${i.time}</div><div class="schedule-event"><h3>${i.title}</h3><p>${processText(i.desc)}</p></div></li>`).join('')}</ul></section>`;
    const createLocationHTML = (c, s) => `<section class="content-section location-block" style="${getBlockStyles(c, s, 'location')}"><h2>${c.title}</h2><p>${processText(c.address)}</p><img src="${c.imageUrl}" alt="Venue"><a href="${c.mapLink}" class="rsvp-button" target="_blank" style="margin-top: 30px;">View on Map</a></section>`;
    const createRsvpHTML = (c, s, rsvpLink) => `<section class="content-section" style="${getBlockStyles(c, s, 'rsvp')}"><h2>${c.title}</h2><p>${processText(c.subtitle)}</p><div><a href="${rsvpLink}" class="rsvp-button">I'll Be There!</a>${c.declineLink ? `<a href="${c.declineLink}" class="rsvp-button decline">Can't Make It</a>` : ''}</div></section>`;
    const createHeadingHTML = (c, s) => `<section class="content-section" style="${getBlockStyles(c, s, 'heading')}"><h2 style="font-size: 2.5rem;">${c.text}</h2></section>`;
    const createImageHTML = (c, s) => `<section class="content-section image-block" style="${getBlockStyles(c,s,'image')}"><figure><img src="${c.imageUrl}" alt="${c.caption}"><figcaption>${c.caption}</figcaption></figure></section>`;
    const createParagraphHTML = (c, s) => `<section class="content-section paragraph-block" style="${getBlockStyles(c, s, 'paragraph')}"><p>${processText(c.text)}</p></section>`;
    
    // ===== ОСНОВНАЯ ЛОГИКА СТРАНИЦЫ =====

    function renderPage(blocks, settings, rsvpLink = '#') {
        if (!blocks || !settings) return;
        document.body.className = '';
        if (settings.style) { document.body.classList.add(`style-${settings.style}`); }
        document.body.style.backgroundImage = (settings.style === 'modern' && settings.backgroundImage) ? `url('${settings.backgroundImage}')` : 'none';
        const container = document.getElementById('page-content');
        container.innerHTML = '';
        let countdownBlock = null;
        blocks.forEach(block => {
            let blockHTML = '';
            switch(block.type) {
                case 'hero': blockHTML = createHeroHTML(block.content, settings); break;
                case 'countdown': blockHTML = createCountdownHTML(block.content, settings); countdownBlock = block.content; break;
                case 'schedule': blockHTML = createScheduleHTML(block.content, settings); break;
                case 'location': blockHTML = createLocationHTML(block.content, settings); break;
                case 'rsvp': blockHTML = createRsvpHTML(block.content, settings, rsvpLink); break;
                case 'heading': blockHTML = createHeadingHTML(block.content, settings); break;
                case 'paragraph': blockHTML = createParagraphHTML(block.content, settings); break;
                case 'image': blockHTML = createImageHTML(block.content, settings); break;
            }
            container.innerHTML += blockHTML;
        });
        if (countdownBlock) { startCountdown(countdownBlock.targetDate); }
    }

    function startCountdown(targetDate) { 
        if (!targetDate) return; 
        if (countdownInterval) clearInterval(countdownInterval); 
        const c = new Date(targetDate).getTime(); 
        countdownInterval = setInterval(() => { 
            const n = new Date().getTime(), d = c - n; 
            if (d < 0) { clearInterval(countdownInterval); const e = document.getElementById("countdown"); if (e) e.innerHTML = "<h2>The event has already happened!</h2>"; return; } 
            const D = document.getElementById("days"), H = document.getElementById("hours"), M = document.getElementById("minutes"), S = document.getElementById("seconds"); 
            if(D) D.innerText = Math.floor(d / 864e5).toString().padStart(2, '0'); 
            if(H) H.innerText = Math.floor(d % 864e5 / 36e5).toString().padStart(2, '0'); 
            if(M) M.innerText = Math.floor(d % 36e5 / 6e4).toString().padStart(2, '0'); 
            if(S) S.innerText = Math.floor(d % 6e4 / 1e3).toString().padStart(2, '0'); 
        }, 1000); 
    }

    async function loadInvitationData() {
        setupIntroAnimation(); // Запускаем подготовку анимации
        document.body.style.opacity = 1; 
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const pageType = params.get('page') || 'main';
        if (id && pageType) {
            try {
                const r = await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, { headers: { 'X-Access-Key': '__JSONBIN_ACCESS_KEY__' }});
                if (!r.ok) throw new Error('Could not load invitation data.');
                const data = (await r.json()).record;
                const pageData = data[pageType];
                if (!pageData) throw new Error(`Specified page data ('${pageType}') not found.`);
                const rsvpTemplateFile = data.rsvp.template;
                const rsvpLink = `${window.location.origin}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1)}${rsvpTemplateFile}?id=${id}&page=rsvp`;
                renderPage(pageData.blocks, pageData.settings, rsvpLink);
            } catch (e) { document.getElementById('page-content').innerHTML = `<h1>Error Loading Invitation</h1><p>${e.message}</p>`; }
        }
    }
    
    if (window.self !== window.top) { // Если в iframe (превью в редакторе)
        document.body.style.opacity = 1;
        // НЕ запускаем анимацию в превью, чтобы не мешала
    } else { // Если открыто как самостоятельная страница
        window.addEventListener('load', loadInvitationData);
    }
    </script>
</body>
</html>