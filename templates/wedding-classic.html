<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Allura&family=Sacramento&family=Alex+Brush&family=Satisfy&family=Kaushan+Script&family=Pacifico&family=Caveat:wght@400;700&family=Cookie&family=Playfair+Display:wght@400;700&family=Crimson+Text:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=EB+Garamond:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Vollkorn:wght@400;700&family=Cinzel:wght@400;700&family=Abril+Fatface&family=Amatic+SC:wght@400;700&family=Fredoka+One&family=Lobster&family=Montserrat:wght@300;400;700&family=Raleway:wght@300;400;700&family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root{--accent-color:#c5a98b;--background-color:#f8f7f5}
        body{margin:0;font-family:'Montserrat',sans-serif;line-height:1.7;background-color:var(--background-color);color:#333;opacity:0;transition:opacity .5s ease-in-out; background-size: cover; background-position: center; background-attachment: fixed;}
        main { transition: opacity 1s ease-in-out; } body.intro-active main { opacity: 0; }
        .block-wrapper { position: relative; }
        .content-section{background: #fff; margin: 30px auto; padding: 50px 20px; text-align: center; position: relative; border-radius: 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); box-sizing: border-box;}
        #page-content > .block-wrapper:first-child .content-section { margin-top: 0; border-radius: 0; }
        #page-content > .block-wrapper:first-child .hero-block + .block-wrapper .content-section { margin-top: 30px; border-radius: 8px; }
        h1,h2,h3{ text-align:center; margin: 15px 0; }
        p { margin: 15px 0; }
        .hero-block { display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; position: relative; overflow: hidden; width: 100%; user-select: none; }
        .hero-background-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; pointer-events: none; }
        .hero-block::before{ content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.4); z-index: 1; pointer-events: none;}
        .hero-content{ position:relative; z-index: 2; width: 90%; max-width: 1000px; padding: 40px 0; pointer-events: none;}
        .hero-content h1, .hero-content p, .hero-content h3 { margin: 10px 0; line-height: 1.3; }
        .hero-inner-blocks { margin-top: 25px; }
        .style-modern .content-section {background: rgba(255, 255, 255, 0.85); box-shadow: none; }
        #countdown{display:flex;justify-content:center;gap:20px;text-align:center}
        .time-block{background:#f4f4f4;padding:20px;border-radius:5px;min-width:80px}
        .time-block .number{font-size:2.5rem;font-weight:700;color:var(--accent-color)}
        .schedule-list{list-style:none;padding:0;text-align:left; max-width: 600px; margin: 0 auto;}
        .schedule-item{display:flex;gap:20px;border-bottom:1px solid #eee;padding:20px 0}
        .schedule-item:last-child{border-bottom:none}
        .schedule-time{font-weight:700;color:var(--accent-color);font-size:1.2rem;min-width:80px}
        .schedule-event h3{margin:0;font-size:1.4rem;text-align:left}
        .schedule-event p{margin:5px 0 0; white-space: pre-wrap;}
        .location-block p { margin-bottom: 20px; white-space: pre-wrap; }
        .location-block img { width: 100%; height: auto; max-height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 20px;}
        .rsvp-button{display:inline-block; padding:15px 30px;text-decoration:none;border-radius:50px;transition:transform .2s ease; margin: 10px;}
        .rsvp-button:hover{transform:scale(1.05)}
        .text-block-content p { white-space: pre-wrap; }
        #envelope-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; z-index: 1000; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 1.5s ease-in-out; } #envelope-3d { width: 80%; max-width: 500px; height: 80%; max-height: 500px; transition: transform 0.5s, opacity 0.5s; opacity: 0; } #envelope-3d.loaded { opacity: 1; animation: floatAnimation 4s ease-in-out infinite; } #envelope-wrapper.hidden { opacity: 0; pointer-events: none; } @keyframes floatAnimation { 0% { transform: translateY(0); } 50% { transform: translateY(-15px); } 100% { translateY(0); } }

        /* Styles for Stickers Interaction */
        .sticker-wrapper { position: absolute; box-sizing: border-box; z-index: 5; }
        .sticker-wrapper img { width: 100%; height: 100%; display: block; }
        .sticker-wrapper.selected { outline: 2px solid #007bff; }
        .sticker-wrapper .resize-handle { position: absolute; width: 12px; height: 12px; background: #fff; border: 1px solid #007bff; border-radius: 50%; display: none; }
        .sticker-wrapper.selected .resize-handle { display: block; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .sticker-wrapper .rotate-handle { position: absolute; top: -30px; left: calc(50% - 8px); width: 16px; height: 16px; background: #fff; border: 1px solid #007bff; border-radius: 50%; cursor: grab; display: none; }
        .sticker-wrapper .rotate-handle::before { content: ''; position: absolute; top: -15px; left: 50%; width: 1px; height: 15px; background: #007bff; transform: translateX(-50%); }
        .sticker-wrapper.selected .rotate-handle { display: block; }

    </style>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</head>
<body>
    <div id="envelope-wrapper">
        <model-viewer id="envelope-3d" src="/templates/envelope.glb" alt="An interactive 3D envelope" camera-controls disable-zoom interaction-prompt="none" camera-orbit="0deg 75deg 105%" style="width: 100%; height: 100%; background: none;"></model-viewer>
    </div>
    <main id="page-content"></main>

    <script>
    let countdownInterval;

    const processText = (text) => (text || '').replace(/\n/g, '<br>');
    const getStyleString = (style) => { if (!style) return ''; let str = ''; if (style.fontFamily) str += `font-family: '${style.fontFamily}', sans-serif; `; if (style.fontSize) str += `font-size: ${style.fontSize}; `; if (style.color) str += `color: ${style.color}; `; if (style.fontWeight) str += `font-weight: ${style.fontWeight}; `; if (style.textAlign) str += `text-align: ${style.textAlign}; `; if (style.backgroundColor) str += `background-color: ${style.backgroundColor}; `; return str; };

    const renderStickers = (stickers) => {
        if (!stickers || stickers.length === 0) return '';
        return stickers.map(sticker => {
            const opacityStyle = (sticker.opacity !== undefined) ? `opacity: ${sticker.opacity};` : '';
            return `<div class="sticker-wrapper" data-sticker-id="${sticker.id}" style="left: ${sticker.x}px; top: ${sticker.y}px; width: ${sticker.width}px; transform: rotate(${sticker.rotation || 0}deg); ${opacityStyle}"> <img src="${sticker.src}" alt="sticker"> <div class="rotate-handle"></div> <div class="resize-handle se"></div> </div>`;
        }).join('');
    };

    const createHeroHTML = (c, s) => {
        const imageOpacityStyle = (c.opacity !== undefined) ? `opacity: ${c.opacity};` : '';
        const imageHTML = c.imageUrl ? `<img class="hero-background-image" src="${c.imageUrl}" style="object-position: ${c.backgroundPosition || 'center center'}; ${imageOpacityStyle}" alt="Wedding background">` : '';
        const headerStyle = c.aspectRatio ? `aspect-ratio: ${c.aspectRatio};` : '';
        const subtitleHTML = (c.subtitle && c.subtitle.enabled) ? `<p style="${getStyleString(c.subtitle.style)}">${c.subtitle.text}</p>` : '';
        const namesHTML = (c.names && c.names.enabled) ? `<h1 style="${getStyleString(c.names.style)}">${c.names.text}</h1>` : '';
        const dateHTML = (c.date && c.date.enabled) ? `<p style="${getStyleString(c.date.style)}">${c.date.text}</p>` : '';
        let innerBlocksHTML = ''; if (c.innerBlocks && c.innerBlocks.length > 0) { innerBlocksHTML = `<div class="hero-inner-blocks">${c.innerBlocks.map(b => { const style = getStyleString(b.style); if (b.type === 'heading') return `<h3 style="${style}">${b.text}</h3>`; if (b.type === 'paragraph') return `<p style="${style}">${processText(b.text)}</p>`; return ''; }).join('')}</div>`; }
        const stickersHTML = renderStickers(c.stickers);
        return `<div class="block-wrapper"><header class="hero-block" style="${headerStyle}"> ${imageHTML} <div class="hero-content"> ${subtitleHTML} ${namesHTML} ${dateHTML} ${innerBlocksHTML} </div> ${stickersHTML} </header></div>`;
    };
    
    const createTextBlockHTML = (c, s) => { 
        const titleStyle = getStyleString(c.titleStyle); 
        const textStyle = getStyleString(c.textStyle); 
        const titleHTML = c.title ? `<h2 style="${titleStyle}">${c.title}</h2>` : ''; 
        const textHTML = c.text ? `<div class="text-block-content"><p style="${textStyle}">${processText(c.text)}</p></div>` : ''; 
        const stickersHTML = renderStickers(c.stickers);
        return `<div class="block-wrapper"><section class="content-section text-block" style="max-width: ${s.maxWidth || '800px'};"> ${titleHTML}${textHTML} ${stickersHTML} </section></div>`; 
    };

    const createSectionWithTitleHTML = (type, c, s, innerHTML) => { 
        const titleStyle = getStyleString(c.titleStyle); 
        const stickersHTML = renderStickers(c.stickers);
        return `<div class="block-wrapper"><section class="content-section ${type}-block" style="max-width: ${s.maxWidth || '800px'};"> <h2 style="${titleStyle}">${c.title}</h2> ${innerHTML} ${stickersHTML} </section></div>`; 
    };

    const createCountdownHTML = (c, s) => createSectionWithTitleHTML('countdown', c, s, `<div id="countdown"><div class="time-block"><div id="days" class="number">00</div><div>Days</div></div><div class="time-block"><div id="hours" class="number">00</div><div>Hours</div></div><div class="time-block"><div id="minutes" class="number">00</div><div>Minutes</div></div><div class="time-block"><div id="seconds" class="number">00</div><div>Seconds</div></div></div>`);
    const createScheduleHTML = (c, s) => createSectionWithTitleHTML('schedule', c, s, `<ul class="schedule-list">${(c.items || []).map(i => `<li class="schedule-item"><div class="schedule-time">${i.time}</div><div class="schedule-event"><h3>${i.title}</h3><p>${processText(i.desc)}</p></div></li>`).join('')}</ul>`);
    const createLocationHTML = (c, s) => {
        const imageOpacityStyle = (c.opacity !== undefined) ? `opacity: ${c.opacity};` : '';
        const locationImage = c.imageUrl ? `<img src="${c.imageUrl}" alt="Venue" style="${imageOpacityStyle}">` : '';
        return createSectionWithTitleHTML('location', c, s, `<p>${processText(c.address)}</p>${locationImage}<a href="${c.mapLink}" class="rsvp-button" target="_blank">View on Map</a>`);
    };
    const createRsvpHTML = (c, s, rsvpLink) => createSectionWithTitleHTML('rsvp', c, s, `<p>${processText(c.subtitle)}</p><div><a href="${rsvpLink}" class="rsvp-button" style="${getStyleString(c.buttonStyle)}">I'll Be There!</a></div>`);
    const createImageHTML = (c, s) => {
        const imageOpacityStyle = (c.opacity !== undefined) ? `opacity: ${c.opacity};` : '';
        const stickersHTML = renderStickers(c.stickers);
        return `<div class="block-wrapper"><section class="content-section image-block" style="max-width: ${s.maxWidth || '800px'};"><figure><img src="${c.imageUrl}" alt="${c.caption}" style="${imageOpacityStyle}"><figcaption>${c.caption}</figcaption></figure>${stickersHTML}</section></div>`;
    };

    function renderPage(blocks, settings, rsvpLink = '#') {
        if (!blocks || !settings) return;
        document.body.className = '';
        if (settings.style) document.body.classList.add(`style-${settings.style}`);
        document.body.style.backgroundImage = (settings.style === 'modern' && settings.backgroundImage) ? `url('${settings.backgroundImage}')` : 'none';
        
        const container = document.getElementById('page-content'); container.innerHTML = '';
        let countdownBlock = null;

        blocks.forEach(block => {
            let blockHTML = '';
            switch(block.type) {
                case 'hero': blockHTML = createHeroHTML(block.content, settings); break;
                case 'text-block': blockHTML = createTextBlockHTML(block.content, settings); break;
                case 'countdown': blockHTML = createCountdownHTML(block.content, settings); countdownBlock = block.content; break;
                case 'schedule': blockHTML = createScheduleHTML(block.content, settings); break;
                case 'location': blockHTML = createLocationHTML(block.content, settings); break;
                case 'rsvp': blockHTML = createRsvpHTML(block.content, settings, rsvpLink); break;
                case 'image': blockHTML = createImageHTML(block.content, settings); break;
            }
            container.innerHTML += blockHTML;
        });
        if (countdownBlock) startCountdown(countdownBlock.targetDate);
        
        // Initialize sticker interaction only if in an iframe (editor mode)
        if (window.self !== window.top) {
             setTimeout(() => initStickerInteraction(blocks), 50);
        }
    }
    
    function startCountdown(targetDate) { if (!targetDate) return; if (countdownInterval) clearInterval(countdownInterval); const targetTime = new Date(targetDate).getTime(); countdownInterval = setInterval(() => { const now = new Date().getTime(), distance = targetTime - now; if (distance < 0) { clearInterval(countdownInterval); const e = document.getElementById("countdown"); if (e) e.innerHTML = "<h2>The event has already happened!</h2>"; return; } const D = document.getElementById("days"), H = document.getElementById("hours"), M = document.getElementById("minutes"), S = document.getElementById("seconds"); if(D) D.innerText = Math.floor(distance / 864e5).toString().padStart(2, '0'); if(H) H.innerText = Math.floor(distance % 864e5 / 36e5).toString().padStart(2, '0'); if(M) M.innerText = Math.floor(distance % 36e5 / 6e4).toString().padStart(2, '0'); if(S) S.innerText = Math.floor(distance % 6e4 / 1e3).toString().padStart(2, '0'); }, 1000); }
    
    function initStickerInteraction(blocks) {
        if (typeof interact === 'undefined') return;
        
        blocks.forEach(block => {
            const blockWrapper = document.querySelector(`.${block.type}-block`)?.closest('.block-wrapper') || 
                                document.querySelector('.hero-block')?.closest('.block-wrapper');
            if (!blockWrapper) return;
            
            const blockId = block.id;

            interact(blockWrapper.querySelectorAll('.sticker-wrapper'))
                .draggable({
                    listeners: {
                        start(event) { event.target.classList.add('selected'); },
                        move(event) {
                            const target = event.target;
                            let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                            target.style.left = `${x}px`;
                            target.style.top = `${y}px`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        },
                        end(event) {
                            const newProps = { x: parseFloat(event.target.getAttribute('data-x')), y: parseFloat(event.target.getAttribute('data-y')) };
                            window.parent.postMessage({ type: 'UPDATE_STICKER', payload: { blockId, stickerId: event.target.dataset.stickerId, newProps } }, '*');
                        }
                    },
                    modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent' }) ]
                })
                .resizable({
                    edges: { right: '.resize-handle.se', bottom: '.resize-handle.se' },
                    listeners: {
                        move(event) {
                            let { x, y } = event.target.dataset;
                            Object.assign(event.target.style, { width: `${event.rect.width}px`, height: 'auto' });
                            event.target.setAttribute('data-x', x);
                            event.target.setAttribute('data-y', y);
                        },
                         end(event) {
                            const newProps = { width: event.rect.width };
                            window.parent.postMessage({ type: 'UPDATE_STICKER', payload: { blockId, stickerId: event.target.dataset.stickerId, newProps } }, '*');
                        }
                    },
                    modifiers: [ interact.modifiers.aspectRatio({ ratio: 'preserve' }) ]
                })
                .gesturable({ // For rotation
                    listeners: {
                        move (event) {
                            const target = event.target;
                            let angle = (parseFloat(target.getAttribute('data-angle')) || 0) + event.da;
                            target.style.transform = `rotate(${angle}deg)`;
                            target.setAttribute('data-angle', angle);
                        },
                        end(event) {
                            const newProps = { rotation: parseFloat(event.target.getAttribute('data-angle')) };
                            window.parent.postMessage({ type: 'UPDATE_STICKER', payload: { blockId, stickerId: event.target.dataset.stickerId, newProps } }, '*');
                        }
                    }
                })
                .on('tap', (event) => {
                    document.querySelectorAll('.sticker-wrapper').forEach(el => el.classList.remove('selected'));
                    event.currentTarget.classList.add('selected');
                });

            blockWrapper.addEventListener('click', (e) => {
                if (e.target.closest('.sticker-wrapper')) return;
                document.querySelectorAll('.sticker-wrapper').forEach(el => el.classList.remove('selected'));
            });
        });
    }

    function setupIntroAnimation() {
        const envelopeWrapper = document.getElementById('envelope-wrapper');
        const modelViewer = document.getElementById('envelope-3d');
        if (!envelopeWrapper || !modelViewer || typeof confetti !== 'function') { document.body.style.opacity = 1; if(envelopeWrapper) envelopeWrapper.style.display = 'none'; return; }
        document.body.classList.add('intro-active');
        document.body.style.opacity = 1; 
        modelViewer.addEventListener('load', () => modelViewer.classList.add('loaded'));
        const fireConfetti = () => { const defaults = { spread: 360, ticks: 150, gravity: 0, decay: 0.95, startVelocity: 35, shapes: ['star'], colors: ['FFE400', 'FFBD00', 'E89400', 'FFCA6C', 'FDFFB8'] }; confetti({ ...defaults, particleCount: 60, scalar: 1.2, shapes: ['star'] }); confetti({ ...defaults, particleCount: 20, scalar: 0.75, shapes: ['circle'] }); };
        envelopeWrapper.addEventListener('click', () => { fireConfetti(); modelViewer.style.transform = 'scale(0)'; modelViewer.style.opacity = '0'; setTimeout(() => { document.body.classList.remove('intro-active'); envelopeWrapper.classList.add('hidden'); }, 500); }, { once: true });
    }

    async function loadInvitationData() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id'), pageType = params.get('page') || 'main';
        if (id && pageType) {
            try {
                const r = await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, { headers: { 'X-Access-Key': '$2a$10$c.QWLI8NIw84W3uqmH/mUez32F1LK7KPBirRW7hr1nE0mJ9CAATC6' }});
                if (!r.ok) throw new Error('Could not load invitation data.');
                const data = (await r.json()).record;
                const pageData = data[pageType];
                if (!pageData) throw new Error(`Page data ('${pageType}') not found.`);
                const rsvpTemplateFile = data.rsvp ? data.rsvp.template : 'rsvp-form.html';
                const rsvpLink = `${window.location.origin}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1)}${rsvpTemplateFile}?id=${id}&page=rsvp`;
                renderPage(pageData.blocks, pageData.settings, rsvpLink);
            } catch (e) {
                document.getElementById('page-content').innerHTML = `<h1>Error</h1><p>${e.message}</p>`;
            }
        }
    }

    if (window.self === window.top) { // Final page
        window.addEventListener('load', () => { loadInvitationData(); setupIntroAnimation(); });
    } else { // Editor mode
        document.body.style.opacity = 1;
        const envelope = document.getElementById('envelope-wrapper');
        if (envelope) envelope.style.display = 'none';
    }
    </script>
</body>
</html>